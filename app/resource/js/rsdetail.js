if($==undefined){$=jQuery}function insertChart(){$("#pdailog").dialog({title:"创建图形",width:380,height:304,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",handler:function(){if(curTmpInfo.selectChart==undefined){msginfo("您还未选择图形，请点击图形示意图片，再点确认按钮。")}else{addChart(curTmpInfo.selectChart);delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}},{text:"取消",handler:function(){delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","../ruisibi/Panel!insertChart.action")}function chartcss(){curTmpInfo.selectChart="line";$(".chartselect .selleft ul li").bind("click",function(){var b=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#schart"+b).css("display","block");var a=$("#schart"+b).attr("tp");curTmpInfo.selectChart=a})}function addChart(g,e){curTmpInfo.charttype=g;var a="图形 -";if(g=="line"){a=a+"曲线图"}else{if(g=="column"){a=a+"柱状图"}else{if(g=="pie"){a=a+"饼图"}else{if(g=="gauge"){a=a+"仪表盘"}else{if(g=="radar"){a=a+"雷达图"}else{if(g=="scatter"){a=a+"散点图"}else{if(g=="bubble"){a=a+"气泡图"}}}}}}}if(!pageInfo.chart){pageInfo.chart={}}var n=pageInfo.chart;if(e){n.chartJson=e.chartJson}else{n.chartJson={type:g,xcol:{},ycol:{},scol:{}}}var d=false;var h=false;var c=false;d=g=="pie"||g=="gauge";h=g=="bubble"||g=="scatter";c=g=="bubble";var f='<div class="tsbd">'+(h?'<div class="ts_h">'+(d?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx">'+(e&&e.kpiJson[1]!=null?'<span title="聚合方式" onclick="chartAggreType(this,\'y2col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+(e.kpiJson[1].dispName!=""?e.kpiJson[1].dispName:e.kpiJson[1].name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'y2col\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":'<div class="ts_h">'+(d?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx">'+(e&&e.chartJson.xcol&&!$.isEmptyObject(e.chartJson.xcol)?'<span class="charttxt">'+(e.chartJson.xcol.dispName!=""?e.chartJson.xcol.dispName:e.chartJson.xcol.name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>")+'<div class="ts_h">'+(d?"度量":"纵轴")+'：<div id="ycol" class="h_ctx">'+(e&&e.kpiJson[0]!=null?'<span title="聚合方式" onclick="chartAggreType(this, \'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+(e.kpiJson[0].dispName==""?e.kpiJson[0].name:e.kpiJson[0].dispName)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>"+(c?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx">'+(e?'<span title="聚合方式" onclick="chartAggreType(this, \'y3col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+(e.kpiJson[2].dispName==""?e.kpiJson[2].name:e.kpiJson[2].dispName)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'y3col\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":"")+(h?'<div class="ts_h">观察维度：<div id="xcol" class="h_ctx">'+(e&&e.chartJson.xcol&&!$.isEmptyObject(e.chartJson.xcol)?'<span class="charttxt">'+(e.chartJson.xcol.dispName!=""?e.chartJson.xcol.dispName:e.chartJson.xcol.name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>":"")+(c?"":'<div class="ts_h" '+(d?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx">'+(e&&e.chartJson.scol&&!$.isEmptyObject(e.chartJson.scol)?'<span class="charttxt">'+(e.chartJson.scol.dispName!=""?e.chartJson.scol.dispName:e.chartJson.scol.name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>':'<span class="charttip">将字段拖到这里</span>')+"</div></div>")+"</div>"+(d||h?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif'><a title='交换维度' href='javascript:exchangexs();'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif'></div>")+'<div class="chartctx" style="'+(h?"height:220px;":"")+'">图形预览区域</div>';var l='<div id="T3" class="comp_table"><div class="title"><div class="tname">'+a+'</div><div class="mvcomp"></div><div class="ticon"><a href="javascript:;" id="removechartbtn" title="删除对象"></a></div></div><div class="ctx"> '+f+" </div></div>";$("#chart_div").html(l);var b=$("#T3").offset();$("#optarea").scrollTop(b.top);$("#removechartbtn").click(function(){$("#chart_div").html("");delete pageInfo.chart});if(curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter"){initChartByScatter()}else{initChartKpiDrop()}if(e){chartview(e)}}function initChartKpiDrop(){var a=3;$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(c,b){$(b).draggable("proxy").find("span").removeClass("tree-dnd-no");$(b).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000");c.cancelBubble=true;c.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(f,d){$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var c=$("#selectdatatree").tree("getNode",d);f.cancelBubble=true;f.stopPropagation();var b=pageInfo.chart;if(b.datasetid&&b.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与图形已有的内容不在同一个数据集中，拖放失败！");return}else{b.datasetid=c.attributes.tid}if(b.kpiJson==undefined){b.kpiJson=[]}if($(this).attr("id")=="ycol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在于横轴中，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例中，不能拖放。");return}b.kpiJson=[];b.kpiJson.push({id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"});b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this,\'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}if($(this).attr("id")=="xcol"){if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例项中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在于纵轴中，不能拖放。");return}b.chartJson.xcol={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}if($(this).attr("id")=="scol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在于横轴中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在于纵轴中，不能拖放。");return}b.chartJson.scol={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>');curTmpInfo.isupdate=true;chartview(b)}}})}function kpiExist(b,c){var a=false;for(k=0;b&&k<b.length;k++){if(b[k]!=null&&b[k].id==c){a=true;break}}return a}function initChartByScatter(){var a=3;$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #y2col, #T"+a+" #y3col, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T3 #"+$(this).attr("id")).css("border-color","#ff0000");d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T3 #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(f,d){$("#T3 #"+$(this).attr("id")).css("border-color","#7F9DB9");var c=$("#selectdatatree").tree("getNode",d);f.cancelBubble=true;f.stopPropagation();var b=pageInfo.chart;if(b.datasetid&&b.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与图形已有的内容不在同一个数据集中，拖放失败！");return}else{b.datasetid=c.attributes.tid}if(!b.kpiJson){if(b.chartJson.type=="bubble"){b.kpiJson=[null,null,null]}else{b.kpiJson=[null,null]}}if($(this).attr("id")=="ycol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[0]={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'ycol\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'ycol\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="y2col"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[1]={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'y2col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'y2col\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="y3col"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在，不能拖放。");return}b.kpiJson[2]={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression,aggre:"count"};b.chartJson.ycol={type:"kpi"};$(this).html('<span title="聚合方式" onclick="chartAggreType(this, \'y3col\')" class="grouptype"></span><span class="charttxt" style="width:75px;">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'y3col\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="xcol"){if(b.chartJson.scol!=undefined&&b.chartJson.scol.id==c.id){msginfo("您拖放的字段已存在于图例项中，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存，不能拖放。");return}b.chartJson.xcol={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>');curTmpInfo.isupdate=true}if($(this).attr("id")=="scol"){if(b.chartJson.xcol!=undefined&&b.chartJson.xcol.id==c.id){msginfo("您拖放的字段已存，不能拖放。");return}if(kpiExist(b.kpiJson,c.id)){msginfo("您拖放的字段已存在，不能拖放。");return}b.chartJson.scol={id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression};$(this).html('<span class="charttxt">'+c.text+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>');curTmpInfo.isupdate=true}if(b.chartJson.type=="scatter"){if(b.kpiJson[0]!=null&&b.kpiJson[1]!=null){chartview(b)}}if(b.chartJson.type=="bubble"){if(b.kpiJson[0]!=null&&b.kpiJson[1]!=null&&b.kpiJson[2]!=null){chartview(b)}}}})}function chartAggreType(b,d){var a=pageInfo.chart;$("#aggretypemenu").children().each(function(f,g){$("#aggretypemenu").menu("setIcon",{target:$(this),iconCls:"icon-blank"})});var e;if(d=="ycol"){e=0}else{if(d=="y2col"){e=1}else{e=2}}curTmpInfo.ycolIdx=e;$("#aggretypemenu").menu("setIcon",{target:$("#aggre_"+a.kpiJson[e].aggre),iconCls:"icon-ok"});var c=$(b).offset();$("#aggretypemenu").menu("show",{left:c.left,top:c.top+20})}function kpiAggreType(c){var b=pageInfo.chart;var a=b.kpiJson[curTmpInfo.ycolIdx].type;if(c!="count"){if(a!="Int"&&a!="Double"){msginfo("字段类型不是数字类型， 不能进行 "+c+" 运算。");return}}b.kpiJson[curTmpInfo.ycolIdx].aggre=c;chartview(b);curTmpInfo.isupdate=true}function chartview(c){if(!c||!c.kpiJson||c.kpiJson.length==0){return}if(c.chartJson.type=="scatter"&&(c.kpiJson[0]==null||c.kpiJson[1]==null)){return}if(c.chartJson.type=="bubble"&&(c.kpiJson[0]==null||c.kpiJson[1]==null||c.kpiJson[2]==null)){return}var b=JSON.stringify(c.chartJson);var f=JSON.stringify(c.kpiJson);var e=[];if(pageInfo.params&&pageInfo.params.length>0){for(k=0;k<pageInfo.params.length;k++){if(pageInfo.params[k].tid==c.tid){e.push(pageInfo.params[k])}}}var d=findDatasetById(c.datasetid);if(d==null){$("#T3 div.ctx").html("组件关联的数据集已经失效，请移除该组件。");return}var a=findDatasourceById(d.dsid);if(a==null){$("#T3 div.ctx").html("组件关联的数据源已经失效，请移除该组件。");return}showloading();$.ajax({type:"POST",url:"ChartView.action",dataType:"html",data:{chartJson:b,kpiJson:f,params:JSON.stringify(e),dset:JSON.stringify(d),dsource:JSON.stringify(a)},success:function(g){hideLoading();$("#T3 div.chartctx").css("height","auto");$("#T3 div.chartctx").html(g)},error:function(g){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function delChartCol(c){var b=pageInfo.chart;var a=3;if(c=="xcol"){b.chartJson.xcol={};$("#T"+a+" #xcol").html('<span class="charttip">将字段拖到这里</span>');curTmpInfo.isupdate=true;chartview(b,a)}if(c=="ycol"){b.chartJson.ycol={};if(b.kpiJson.length>1){b.kpiJson[0]=null}else{b.kpiJson=[]}$("#T"+a+" #ycol").html('<span class="charttip">将字段拖到这里</span>')}if(c=="y2col"){if(b.kpiJson.length>1){b.kpiJson[1]=null}else{b.kpiJson=[]}$("#T"+a+" #y2col").html('<span class="charttip">将字段拖到这里</span>')}if(c=="y3col"){b.kpiJson[2]=null;$("#T"+a+" #y3col").html('<span class="charttip">将字段拖到这里</span>')}if(c=="scol"){b.chartJson.scol={};$("#T"+a+" #scol").html('<span class="charttip">将字段拖到这里</span>');curTmpInfo.isupdate=true;chartview(b,a)}}function exchangexs(){var a=pageInfo.chart;if(!a){return}if(a.chartJson==undefined||(a.chartJson.xcol==undefined&&a.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var c=a.chartJson.xcol;a.chartJson.xcol=a.chartJson.scol;a.chartJson.scol=c;var b=3;if(a.chartJson.xcol&&a.chartJson.xcol.id){var d=a.chartJson.xcol;$("#T"+b+" #xcol").html('<span class="charttxt">'+(a.chartJson.xcol.dispName!=""?a.chartJson.xcol.dispName:a.chartJson.xcol.name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'xcol\')"></span>')}else{$("#T"+b+" #xcol").html('<span class="charttip">将维度拖到这里</span>')}if(a.chartJson.scol&&a.chartJson.scol.id){var d=a.chartJson.scol;$("#T"+b+" #scol").html('<span class="charttxt">'+(a.chartJson.scol.dispName!=""?a.chartJson.scol.dispName:a.chartJson.scol.name)+'</span><span class="chartdel" title="配置" onclick="delChartCol(\'scol\')"></span>')}else{$("#T"+b+" #scol").html('<span class="charttip">将维度拖到这里</span>')}curTmpInfo.isupdate=true;chartview(a)}function formatNumber(h,p){if(p.indexOf("%")>0){h=h*100}var b=p?p.split("."):[""];var o="";var t=0;if(b.length>1){t=b[1].length}var d=1;for(g=0;g<t;g++){d=d*10}h=h*d;h=Math.round(h);h=h/d;var s=h?h.toString().split("."):["0"];var q=s[0];var c=b[0];var g=q.length-1;var u=false;for(var n=c.length-1;n>=0;n--){switch(c.substr(n,1)){case"#":if(g>=0){o=q.substr(g--,1)+o}break;case"0":if(g>=0){o=q.substr(g--,1)+o}else{o="0"+o}break;case",":u=true;o=","+o;break}}if(g>=0){if(u){var e=q.length;for(;g>=0;g--){o=q.substr(g,1)+o;if(g>0&&((e-g)%3)==0){o=","+o}}}else{o=q.substr(0,g+1)+o}}o=o+".";q=s.length>1?s[1]:"";c=b.length>1?b[1]:"";g=0;for(var n=0;n<c.length;n++){switch(c.substr(n,1)){case"#":if(g<q.length){o+=q.substr(g++,1)}break;case"0":if(g<q.length){o+=q.substr(g++,1)}else{o+="0"}break}}var a=o.replace(/^,+/,"").replace(/\.$/,"");if(p.indexOf("%")>0){a=a+"%"}return a}if($==undefined){$=jQuery}var dataType=["String","Int","Double","Date"];function initselectDataTree(){var f=false;if(pageInfo.selectDs&&pageInfo.selectDs!=""){var a=pageInfo.selectDs.split(",");var b=[];for(i=0;i<a.length;i++){var e=findDatasetById(a[i]);if(e==null){continue}f=true;var h={id:e.datasetid,text:e.name,iconCls:"icon-dataset2",attributes:{drag:"n"},children:[]};b.push(h);for(j=0;j<e.cols.length;j++){var l=e.cols[j];if(l.isshow){h.children.push({id:l.tname+"_"+l.name,text:(l.dispName==""?l.name:l.dispName),iconCls:"icon-dscol",attributes:{name:l.name,tname:l.tname,type:l.type,dispName:l.dispName,tid:e.datasetid,fmt:l.fmt}})}}for(k=0;e.dynamic&&k<e.dynamic.length;k++){var g=e.dynamic[k];h.children.push({id:g.tname+"_"+g.name,text:(g.dispName!=""?g.dispName:g.name),iconCls:"icon-dscol",attributes:{name:g.name,tname:g.tname,type:g.type,dispName:g.dispName,tid:e.datasetid,expression:g.expression,fmt:g.fmt}})}}$("#selectdatatree").tree({dnd:true,lines:true,data:b,onBeforeDrag:function(c){if(c.attributes&&c.attributes.drag=="n"){return false}return true},onDragEnter:function(d,c){return false},onContextMenu:function(d,c){msginfo("拖拽字段到明细表进行数据查询。","info");d.preventDefault()}})}if(!f){$("#selectdatatree").tree({dnd:false,data:[{id:"nodata",text:"您还未选择查询的数据集。",iconCls:"icon-no"}]})}}function selectdset(){var a='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0"><tr style="background-color:#FFF"><th width="10%">选择</th><th width="10%">序号</th><th width="40%">数据集名称</th><th width="40%">数据集说明</th></tr>';for(i=0;pageInfo.dataset&&i<pageInfo.dataset.length;i++){var b=pageInfo.dataset[i];a=a+'<tr><td class=\'kpiData1 grid3-td\'><input type="checkbox" id="selectdataset" name="selectdataset" value="'+b.datasetid+"\" /></td><td class='kpiData1 grid3-td'>"+(i+1)+"</td><td class='kpiData1 grid3-td'>"+b.name+"</td><td class='kpiData1 grid3-td'>"+b.note+"</td></tr>"}if(!pageInfo.dataset||pageInfo.dataset.length==0){a=a+"<tr><td class='kpiData1 grid3-td' align='center' colspan=\"4\">无数据，请先建立数据模型。</td></tr>"}a=a+"</table>";$("#pdailog").dialog({title:"选择查询数据",width:640,height:340,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var c=jQuery("input[name='selectdataset']:checkbox:checked");var d="";c.each(function(f,e){d=d+$(this).val();if(c.size()-1!=f){d=d+","}});if(d!=""){pageInfo.selectDs=d;initselectDataTree();$("#l_tab").tabs("select",0)}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function newdatasource(c){var b;if(c){b=findDatasourceById(curTmpInfo.id)}var a='<div id="dsource_tab" style="height:auto; width:auto;"><div title="JDBC"><form id="datasourceform" name="datasourceform"><input type="hidden" name="connstate" id="connstate"><div class="textpanel"><span class="inputtext">数据源名称：</span><input type="text" id="dsname" name="dsname" class="inputform" value="'+(b&&b.use=="jdbc"?b.dsname:"")+'" style="width:260px;"><br/><span class="inputtext">数据源类型：</span><select id="linktype" name="linktype" class="inputform" style="width:260px;"><option value="mysql" '+(b&&b.use=="jdbc"&&b.linktype=="mysql"?"selected":"")+'>MYSQL</option><option value="oracle" '+(b&&b.use=="jdbc"&&b.use=="jdbc"&&b.linktype=="oracle"?"selected":"")+'>ORACLE</option><option value="sqlserver" '+(b&&b.use=="jdbc"&&b.linktype=="sqlserver"?"selected":"")+'>SQL Server</option></select><br/><span class="inputtext">连接字符串：</span><input type="text" id="linkurl" name="linkurl" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?b.linkurl:"jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")+'"><br/><span class="inputtext">连接用户名：</span><input type="text" id="linkname" name="linkname" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?b.linkname:"")+'"> <br/><span class="inputtext">连接密码：</span><input type="password" name="linkpwd" id="linkpwd" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?encoder(b.linkpwd,"decode"):"")+'"></div></form></div><div data-options="'+(b&&b.use=="jndi"?"selected:true":"")+'" title="JNDI"><div class="textpanel"><span class="inputtext">JNDI名称：</span><input type="text" value="'+(b&&b.use=="jndi"?b.jndiname:"")+'" class="inputform" name="jndiname" id="jndiname" style="width:260px;"></div></div></div>';$("#pdailog").dialog({title:c?"编辑数据源":"创建数据源",width:410,height:270,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"测试连接",handler:function(){var e=$("#dsource_tab").tabs("getSelected");var d=$("#dsource_tab").tabs("getTabIndex",e);if(d==0){var f=$("#datasourceform").serialize();$.ajax({type:"POST",url:"Data!testConn.action",dataType:"json",data:f,success:function(g){if(g.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}else{if(d==1){var f={jndiname:$("#dsource_tab #jndiname").val()};$.ajax({type:"POST",url:"Data!testJNDI.action",dataType:"json",data:f,success:function(g){if(g.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}}}},{text:"确定",handler:function(){var e=$("#dsource_tab").tabs("getSelected");var d=$("#dsource_tab").tabs("getTabIndex",e);if(d==0){if($("#datasourceform #dsname").val()==""){msginfo("请输入数据源名称！");$("#datasourceform #dsname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(c==false){var g={linktype:$("#linktype").val(),linkname:$("#linkname").val(),linkpwd:encoder($("#linkpwd").val(),"encode"),linkurl:$("#linkurl").val(),dsname:$("#datasourceform #dsname").val(),dsid:newGuid(),use:"jdbc"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(g);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:g.dsid,text:g.dsname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#l_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.linktype=$("#linktype").val();datasource.linkname=$("#linkname").val();datasource.linkpwd=encoder($("#linkpwd").val(),"encode");datasource.linkurl=$("#linkurl").val();datasource.dsname=$("#dsname").val();datasource.use="jdbc";var f=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:f.target,text:datasource.dsname});break}}}}else{if(d==1){if($("#dsource_tab #jndiname").val()==""){msginfo("请输入JNDI名称！");$("#dsource_tab #jndiname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(c==false){var g={jndiname:$("#dsource_tab #jndiname").val(),dsid:newGuid(),use:"jndi"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(g);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:g.dsid,text:g.jndiname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#l_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.jndiname=$("#jndiname").val();datasource.use="jndi";var f=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:f.target,text:datasource.jndiname});break}}}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #dsource_tab").tabs({fit:true,border:false});$("#pdailog #linktype").change(function(){var d=$(this).val();if(d=="mysql"){$("#pdailog #linkurl").val("jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")}else{if(d=="oracle"){$("#pdailog #linkurl").val("jdbc:oracle:thin:@ip:1521:sid")}else{if(d=="sqlserver"){$("#pdailog #linkurl").val("jdbc:jtds:sqlserver://ip:1433/database")}}}})}function initmydatatree(e){var b=[{text:"数据源",id:"sjy",state:"closed",iconCls:"icon-dsource",attributes:{showmenu:true,onlyAdd:true}},{text:"数据集",id:"sjj",state:(e?"open":"closed"),iconCls:"icon-dataset2",attributes:{showmenu:true,onlyAdd:true}}];if(pageInfo.datasource){b[0].children=[];for(var a=0;a<pageInfo.datasource.length;a++){b[0].children.push({text:(pageInfo.datasource[a].use=="jdbc"?pageInfo.datasource[a].dsname:pageInfo.datasource[a].jndiname),id:pageInfo.datasource[a].dsid,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}})}}if(pageInfo.dataset){b[1].children=[];for(var a=0;a<pageInfo.dataset.length;a++){var c={text:pageInfo.dataset[a].name,id:pageInfo.dataset[a].datasetid,iconCls:"icon-dataset2",attributes:{showmenu:true,type:"dset"},children:[],state:"open"};b[1].children.push(c);var d=pageInfo.dataset[a].cols;if(d&&d[0]!=null){c.children=initdatasetview(d,pageInfo.dataset[a].datasetid)}}}$("#mydatatree").tree({data:b,dnd:false,onContextMenu:function(g,f){if(f.attributes&&f.attributes.showmenu==true){g.preventDefault();var h=curTmpInfo.tp=f.attributes.type;curTmpInfo.id=f.id;if(h=="dsettable"){msginfo("请在数据集上右键编辑数据集。");return}if(f.attributes.onlyAdd){$("#mydatasetmenu").menu("disableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("disableItem",$("#dataset_del"));$("#mydatasetmenu").menu("enableItem",$("#dataset_add"))}else{$("#mydatasetmenu").menu("enableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("enableItem",$("#dataset_del"));$("#mydatasetmenu").menu("disableItem",$("#dataset_add"))}$("#mydatatree").tree("select",f.target);$("#mydatasetmenu").menu("show",{left:g.pageX,top:g.pageY})}else{g.preventDefault()}}})}function newdataset(){if(!pageInfo.datasource){msginfo("创建数据集前，请先创建数据源！");return}var d='<select id="dsid" name="dsid" class="inputform">';for(var c=0;pageInfo.datasource&&c<pageInfo.datasource.length;c++){d=d+'<option value="'+pageInfo.datasource[c].dsid+'">'+(pageInfo.datasource[c].use=="jdbc"?pageInfo.datasource[c].dsname:pageInfo.datasource[c].jndiname)+"</option>"}d=d+"</select>";var a='<div id="crtdataset" class="easyui-tabs" data-options="fit:true,border:false,tabPosition:\'left\'"><div title="基本信息"><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" id="datasetname" name="datasetname" class="inputform"><br/><span class="inputtext">数据集说明：</span><input type="text" id="datasetnote" name="datasetnote" class="inputform"><br/><span class="inputtext">连接数据源：</span>'+d+'<br/><span class="inputtext" style="width:120px;">选择需要分析的表：</span><br/><div class="tablesleft"><div class="tabletitle">待选表</div><ul id="allTablesTree" style="height:220px; width:100%; overflow:auto"></ul></div><div class="tablescenter"><input id="left2right" type="button" style="margin-top:120px;" value=">" title="选择"><br/><input type="button" id="right2left"  value="<" title="移除"></div><div class="tablesright"><div class="tabletitle">已选表</div><ul id="selTablesTree" class="easyui-tree" style="height:220px; width:100%; overflow:auto"></ul></div></div></div><div title="表关联"><div class="textpanel"><div style="float:right"><input type="button" id="jointable" value="关联"> <br/> <input type="button" id="unjointable" value="取消"></div><span class="inputtext">主表： </span><select id="mastertable" style="width:300px;"></select><br/><ul class="easyui-tree" id="masterTableTree" style="margin-left:90px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div></div>';$("#pdailog").dialog({title:"创建数据集",width:680,height:450,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var g=$("#pdailog #datasetname").val();var f=$("#pdailog #dsid").val();var p=$("#pdailog #datasetnote").val();if(g==""){msginfo("请填写数据集名称。");$("#crtdataset").tabs("select",0);$("#datasetname").focus();return}var r=$("#selTablesTree").tree("getChildren");if(r==null||r.length==0){msginfo("您还未选择目标表。");return}if(!pageInfo.dataset){pageInfo.dataset=[]}var s=findDatasourceById(f);var o={name:g,note:p,dsid:f,datasetid:newGuid()};o.master=$("#mastertable").val();var q=$("#masterTableTree").tree("getChildren");var h=[];for(c=0;c<q.length;c++){var l=q[c];if(l.iconCls=="icon-coljoin"){h.push({col:l.id,ref:l.attributes.ref,refKey:l.attributes.refKey})}}o.joininfo=h;pageInfo.dataset.push(o);var n=findDatasourceById(f);$.ajax({type:"post",async:false,url:"DataSet!queryDatasetMeta.action",dataType:"json",data:{ds:JSON.stringify(n),dataset:JSON.stringify(o)},success:function(v){o.cols=v;var u={id:o.datasetid,text:o.name,iconCls:"icon-dataset2",attributes:{drag:"n",showmenu:true,type:"dset"}};var t=initdatasetview(v,o.datasetid);u.children=t;$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjj']"),data:u});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjj']"))}});$("#l_tab").tabs("select",1);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var e=function(g){var f=findDatasourceById(g);$.ajax({type:"post",url:"DataSet!queryTables.action",dataType:"json",data:{ds:JSON.stringify(f)},success:function(h){$("#allTablesTree").tree({data:h})}})};$("#pdailog #dsid").bind("change",function(){var f=$("#selTablesTree").tree("getChildren");for(c=0;c<f.length;c++){$("#selTablesTree").tree("remove",f[c].target)}$("#mastertable").html("");e($(this).val())});e($("#pdailog #dsid").val());$("#pdailog #left2right").bind("click",function(){var f=$("#allTablesTree").tree("getSelected");if(f==null||$(f.target).attr("hide")=="y"){msginfo("请先从左边选择表。");return}$("#selTablesTree").tree("append",{parent:null,data:[{id:f.id,text:f.text,iconCls:f.iconCls}]});$(f.target).attr("hide","y").hide();var h=document.getElementById("mastertable");var g=h.selectedIndex;h.options.add(new Option(f.id,f.text));if(g==-1){b(f.id)}});$("#pdailog #right2left").bind("click",function(){var h=$("#selTablesTree").tree("getSelected");if(h==null){msginfo("您还未选择需要移除的表。");return}var g=$("#allTablesTree").tree("getChildren");for(c=0;c<g.length;c++){if(g[c].id==h.id){$(g[c].target).attr("hide","n").show();break}}$("#selTablesTree").tree("remove",h.target);var n=document.getElementById("mastertable");var l=n.selectedIndex;var f=0;for(c=0;c<n.options.length;c++){if(n.options[c].value==h.id){f=c;break}}n.options.remove(f);if(l==f){b(n.options[n.selectedIndex].value)}});var b=function(f){$.ajax({type:"post",url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById($("#crtdataset #dsid").val())),querysql:"select * from "+f+" where 1=2"},success:function(g){var h=[];for(k=0;k<g.length;k++){h.push({id:g[k].name,text:g[k].name,iconCls:"icon-dscol",attributes:{}})}$("#masterTableTree").tree({data:h,onDblClick:function(l){jointableFunc()}})}})};$("#mastertable").bind("change",function(){b($(this).val())});$("#pdailog #jointable").bind("click",function(){jointableFunc()});$("#unjointable").bind("click",function(){var f=$("#masterTableTree").tree("getSelected");if(f==null){msginfo("您还未从主表字段中选择需要删除关联的字段。");return}delete f.attributes.ref;delete f.attributes.refKey;$("#masterTableTree").tree("update",{target:f.target,text:f.id,iconCls:"icon-dscol"})})}function initdatasetview(c,g){var h=[];var f=[];var d=function(p){var o=false;for(k=0;k<f.length;k++){if(f[k]==p){o=true;break}}return o};var l=function(p){var o=[];for(k=0;k<c.length;k++){if(c[k].tname==p){o.push(c[k])}}return o};for(j=0;j<c.length;j++){if(!d(c[j].tname)){f.push(c[j].tname)}}for(j=0;j<f.length;j++){var n=f[j];var e=l(f[j]);var b=[];h.push({id:n,text:n,iconCls:"icon-table",state:"open",children:b,attributes:{showmenu:true,drag:"n",type:"dsettable"}});for(k=0;k<e.length;k++){var a=e[k];b.push({id:a.name,text:(a.dispName==""?a.name:a.dispName),iconCls:"icon-dscol",attributes:{showmenu:true,drag:"n",vtype:a.type,tname:a.tname,isshow:a.isshow,datasetid:g,type:"dsetcol"}})}}return h}function jointableFunc(){var f=$("#masterTableTree").tree("getSelected");if(f==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var b="";var e=null;var d=$("#selTablesTree").tree("getChildren");for(i=0;i<d.length;i++){if(d[i].id!=$("#mastertable").val()){b=b+'<option value="'+d[i].id+'">'+d[i].text+"</option>";if(e==null){e=d[i].id}}}var c=function(g){var h="";if(e!=null){$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById($("#crtdataset #dsid").val())),querysql:"select * from "+g+" where 1=2"},success:function(l){for(k=0;k<l.length;k++){h=h+'<option value="'+l[k].name+'">'+l[k].name+"</option>"}}})}return h};var a='<div class="textpanel">主表 <b>'+$("#mastertable").val()+"</b> 字段 <b>"+f.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+b+'</select> 字段 <select id="slavetablecol"  style="width:100px;">'+c(e)+"</select> </div>";$("#dsColumn_div").dialog({title:"关联维度表",width:350,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){f.attributes.ref=$("#dsColumn_div #slavetable").val();f.attributes.refKey=$("#dsColumn_div #slavetablecol").val();$("#masterTableTree").tree("update",{target:f.target,text:f.text+" -> "+f.attributes.ref+"."+f.attributes.refKey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var g=c($(this).val());$("#slavetablecol").html(g)})}function editdataset(){var id=curTmpInfo.id;var dset=findDatasetById(id);dset=eval("("+JSON.stringify(dset)+")");curTmpInfo.curDset=dset;var dsource=findDatasourceById(dset.dsid);$("#pdailog").dialog({title:"编辑数据集",width:800,height:450,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="datasettabs" ><div title="基本信息" ><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" class="inputform" name="datasetname" id="datasetname" value="'+dset.name+'"><br/><span class="inputtext">数据集说明：</span><input type="text" class="inputform" name="datasetnote" id="datasetnote" value="'+(dset.note?dset.note:"")+'"><br/><span class="inputtext">连接数据源：</span><input type="text" class="inputform" value="'+(dsource.use=="jndi"?dsource.jndiname:dsource.dsname)+'" readOnly=true>(不能更改)<br/><span class="inputtext">已选分析表：</span><br/><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td width="70%" valign="top"><ul id="selectTables"></ul></td><td valign="top" align="right"><a id="addtable" href="#">添加表</a><br/><a id="deltable" href="#">删除表</a></td></tr></table></div></div><div title="表关联" ><div class="textpanel"><div style="float:right"><input type="button" value="关联" id="jointable"><br/><input type="button" value="删除" id="deljointable"></div><span class="inputtext">主表： </span><input type="text" class="inputform" value="'+dset.master+'" style="width:300px;">(不可更改)<br/><ul id="masterTableTree" style="margin-left:90px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div><div title="字段信息"></div><div title="动态字段"></div><div title="数据筛选"></div><div title="数据预览"></div></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){dset.name=$("#datasetname").val();dset.note=$("#datasetnote").val();if(dset.name==""){msginfo("请填数据集名称。");$("#datasetname").focus();return}for(i=0;i<dset.joininfo.length;i++){var o=dset.joininfo[i];if(o.col==""){msginfo("表 "+o.ref+" 还未和主表关联。");return}}for(var i=0;i<pageInfo.dataset.length;i++){var d=pageInfo.dataset[i];if(d.datasetid==dset.datasetid){pageInfo.dataset[i]=dset;break}}var pp=$("#mydatatree").tree("getSelected");var ls=$("#mydatatree").tree("getChildren",pp.target);for(var i=0;i<ls.length;i++){$("#mydatatree").tree("remove",ls[i].target)}var ncols=[];var o=dset.cols;ncols=initdatasetview(o,dset.datasetid);$("#mydatatree").tree("append",{parent:pp.target,data:ncols});$("#mydatatree").tree("update",{target:pp.target,text:dset.name});initselectDataTree();curTmpInfo.isupdate=true;delete curTmpInfo.curDset;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){delete curTmpInfo.curDset;$("#pdailog").dialog("close")}}]});var stbs=[];stbs.push({id:dset.master,text:dset.master+" (主表)",iconCls:"icon-table"});for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){stbs.push({id:dset.joininfo[i].ref,text:dset.joininfo[i].ref,iconCls:"icon-table"})}$("#selectTables").tree({data:stbs});$("#pdailog #addtable").linkbutton({iconCls:"icon-add",plain:true}).bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var ds=findDatasourceById(dset.dsid);var ctx='<ul id="selectTablesTree"></ul>';$("#dsColumn_div").dialog({title:"添加表",width:350,height:280,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var nd=$("#dsColumn_div #selectTablesTree").tree("getSelected");if(nd==null){msginfo("请选择表。");return}var tname=nd.id;if(tname==dset.master){msginfo("您选择的表已经存在。");return}var exist=false;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){exist=true;break}}if(exist){msginfo("您选择的表已经存在。");return}dset.joininfo.push({col:"",ref:tname,refKey:""});$("#pdailog #selectTables").tree("append",{parent:null,data:{id:tname,text:tname,iconCls:"icon-table"}});$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById(dset.dsid)),querysql:"select * from "+tname+" where 1=2"},success:function(dt){for(k=0;k<dt.length;k++){dt[k].tname=tname;dset.cols.push(dt[k])}}});curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$.ajax({type:"post",url:"DataSet!queryTables.action",dataType:"json",data:{ds:JSON.stringify(ds)},success:function(dt){$("#selectTablesTree").tree({data:dt})}})});$("#pdailog #deltable").linkbutton({iconCls:"icon-edit",plain:true}).bind("click",function(){var node=$("#pdailog #selectTables").tree("getSelected");if(node==null){msginfo("请选择表。");return}var tname=node.id;if(tname==dset.master){msginfo("不能删除主表");return}var cubes=pageInfo.cube;var use=false;for(i=0;cubes&&i<cubes.length;i++){var cube=cubes[i];if(cube.datasetid!=dset.datasetid){continue}for(j=0;j<cube.dim.length;j++){var d=cube.dim[j];if(d.tp=="group"){var ls=d.children;for(k=0;k<ls.length;k++){if(ls[k].tname==tname||ls[k].codetable==tname){use=true;break}}}else{if(d.tname==tname||d.codetable==tname){use=true;break}}}}if(use){msginfo("您要删除的表已在立方体中使用，不能删除.");return}if(confirm("是否确认删除？")){var idx=-1;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){idx=i}}if(dset.joininfo){dset.joininfo.splice(idx,1)}var ncols=[];for(i=0;i<dset.cols.length;i++){var c=dset.cols[i];if(c.tname!=tname){ncols.push(c)}}dset.cols=ncols;$("#pdailog #selectTables").tree("remove",node.target)}});$("#pdailog #deljointable").click(function(){var node=$("#masterTableTree").tree("getSelected");var joininfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==node.attributes.ref){joininfo=dset.joininfo[i];break}}if(joininfo!=null){joininfo.col="";joininfo.refKey="";$("#masterTableTree").tree("update",{target:node.target,text:node.id,iconCls:"icon-dscol"})}});$("#pdailog #jointable").click(function(){var node=$("#masterTableTree").tree("getSelected");if(node==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var tbs="";var tname=null;var cld=dset.joininfo;for(i=0;i<cld.length;i++){if(cld[i].col!=""){continue}tbs=tbs+'<option value="'+cld[i].ref+'">'+cld[i].ref+"</option>"}var getSlaveColumns=function(tn){if(!tn||tn==null){return""}var slavecols="";$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById(dset.dsid)),querysql:"select * from "+tn+" where 1=2"},success:function(dt){for(k=0;k<dt.length;k++){slavecols=slavecols+'<option value="'+dt[k].name+'">'+dt[k].name+"</option>"}}});return slavecols};var ctx='<div class="textpanel">主表 <b>'+dset.master+"</b> 字段 <b>"+node.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+tbs+'</select> 字段 <select id="slavetablecol"  style="width:100px;"></select> </div>';$("#dsColumn_div").dialog({title:"关联维度表",width:350,height:200,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var ref=$("#dsColumn_div #slavetable").val();var refkey=$("#dsColumn_div #slavetablecol").val();if(!ref||ref==null||ref==""){msginfo("请选择关联表。");return}var joininfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==ref){joininfo=dset.joininfo[i];break}}joininfo.col=node.id;joininfo.refKey=refkey;$("#masterTableTree").tree("update",{target:node.target,text:node.text+" -> "+ref+"."+refkey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var s=getSlaveColumns($(this).val());$("#slavetablecol").html(s)});var s=getSlaveColumns($("#slavetable").val());$("#slavetablecol").html(s)});$("#datasettabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onLoad:function(){},onSelect:function(a,b){if(b==1){var isJoin=function(col){var ret=null;for(j=0;dset.joininfo&&j<dset.joininfo.length;j++){if(dset.joininfo[j].col==col){ret=dset.joininfo[j];break}}return ret};var mcols=[];for(i=0;i<dset.cols.length;i++){if(dset.cols[i].tname==dset.master){var r=isJoin(dset.cols[i].name);if(r==null){mcols.push({id:dset.cols[i].name,text:dset.cols[i].name,iconCls:"icon-dscol",attributes:{ref:""}})}else{mcols.push({id:dset.cols[i].name,text:dset.cols[i].name+" -> "+r.ref+"."+r.refKey,iconCls:"icon-coljoin",attributes:{ref:r.ref}})}}}$("#masterTableTree").tree({data:mcols})}if(b==2){var pp=$("#datasettabs").tabs("getSelected");var str='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';str=str+'<tr><th width="15%">字段名</th><th width="15%">显示名</th><th width="15%">类型</th><th width="15%">格式化</th><th width="10%">是否显示</th><th width="15%">来源表</th><th width="8%">操作</th></tr>';for(var i=0;i<dset.cols.length;i++){m=dset.cols[i];str=str+"<tr><td class='kpiData1 grid3-td' style='"+(!m.isshow?"text-decoration:line-through":"")+"'>"+m.name+"</td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_disp">'+(m.dispName==""?"&nbsp;":m.dispName)+"</div></td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_tp">'+m.type+'</div></td><td class="kpiData1 grid3-td"><div id="'+(m.tname+"_"+m.name+"_fmt")+'">'+(m.fmt?m.fmt:"")+'</div></td><td class=\'kpiData1 grid3-td\' align="center"><div id="'+m.tname+"_"+m.name+'_show">'+(m.isshow?"是":"否")+"</div></td><td class='kpiData1 grid3-td'>"+m.tname+"</td><td class='kpiData1 grid3-td' align='center'><a href=\"javascript:;\" onclick=\"editDsColumn('"+m.name+"', '"+curTmpInfo.id+"', '"+m.tname+"', 'panel')\">编辑</a></td></tr>"}str=str+"</table>";$(pp).html(str)}if(b==3){reloadDynamicCol(dset)}if(b==4){reloadDatasetFilter(dset)}if(b==5){var pp=$("#datasettabs").tabs("getSelected");$(pp).html("加载中...");$(pp).load("DataSet!queryData.action",{ds:JSON.stringify(dsource),dataset:JSON.stringify(dset)},function(a,b,c){if(b=="error"){$(pp).html("SQL执行出错...")}})}}})}function newdatactx(){var a=curTmpInfo.id;if(a=="sjy"){newdatasource(false)}else{if(a=="sjj"){newdataset()}}}function editmydata(){var b=curTmpInfo.tp;var c=curTmpInfo.id;if(b=="dsource"){newdatasource(true)}else{if(b=="dset"){editdataset()}else{if(b=="dsettable"){msginfo("请在数据集上右键编辑数据集。")}else{if(b=="dsetcol"){var a=$("#mydatatree").tree("getSelected");editDsColumn(a.id,a.attributes.datasetid,a.attributes.tname,"col")}}}}}function deletemydata(){if(confirm("是否确认删除？")==false){return}var f=curTmpInfo.tp;var g=curTmpInfo.id;if(f=="dsource"){var c=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",c.target);var a=-1;for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==g){a=i;break}}pageInfo.datasource.splice(a,1)}if(f=="dset"){var c=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",c.target);var a=-1;for(i=0;i<pageInfo.dataset.length;i++){if(pageInfo.dataset[i].datasetid==g){a=i;break}}pageInfo.dataset.splice(a,1)}if(f=="dsetcol"){var c=$("#mydatatree").tree("getSelected");var d=findDatasetById(c.attributes.datasetid);var e=function(l,n){var h=null;for(j=0;d.joininfo&&j<d.joininfo.length;j++){if(d.master==n&&d.joininfo[j].col==l){h=d.joininfo[j];break}else{if(n==d.joininfo[j].ref&&l==d.joininfo[j].refKey){h=d.joininfo[j];break}}}return h};if(e(c.id,c.attributes.tname)!=null){msginfo("当前字段是表关联字段，不允许删除！");return}var b=c.attributes.tname;var a=-1;for(i=0;i<d.cols.length;i++){if(d.cols[i].tname==b&&d.cols[i].name==c.id){a=i;break}}d.cols.splice(a,1);$("#mydatatree").tree("remove",c.target)}curTmpInfo.isupdate=true}function editDsColumn(a,d,n,g){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var h=g=="panel"?curTmpInfo.curDset:findDatasetById(d);var e=null;for(var f=0;f<h.cols.length;f++){if(h.cols[f].name==a&&h.cols[f].tname==n){e=h.cols[f];break}}var b="";for(var f=0;f<dataType.length;f++){b=b+'<option value="'+dataType[f]+'" '+(e.type==dataType[f]?"selected":"")+">"+dataType[f]+"</option>"}var c=null;for(j=0;h.joininfo&&j<h.joininfo.length;j++){if(h.master==e.tname&&h.joininfo[j].col==e.name){c=h.joininfo[j];break}else{if(e.tname==h.joininfo[j].ref&&e.name==h.joininfo[j].refKey){c=h.joininfo[j];break}}}var l='<div class="textpanel"><span class="inputtext">字段名：</span>'+e.name+'<br/><span class="inputtext">显示名：</span><input type="text" name="coldispname" id="coldispname" value="'+e.dispName+'" class="inputform"><br/><span class="inputtext">类型：</span><select id="coltype" class="inputform">'+b+'</select><br/><span class="inputtext">是否显示：</span><select id="isshow" class="inputform"><option value="1" '+(e.isshow==true?"selected":"")+'>是</option><option value="0" '+(e.isshow==false?"selected":"")+">否</option></select><br/><span class=\"inputtext\">格式化：</span><input type='text' style='width:80px;' id='fmt' value=\""+(e.fmt?e.fmt:"")+'"> (yyyy-MM-dd 或 #,###等)<br/><span class="inputtext">来源表：</span>'+e.tname+'<br/><span class="inputtext">字段关联：</span>'+(c==null?"字段无关联":h.master+"."+c.col+" -> "+c.ref+"."+c.refKey)+"</div>";$("#dsColumn_div").dialog({title:"编辑字段信息",width:c==null?350:420,height:300,closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){e.dispName=$("#dsColumn_div #coldispname").val();e.type=$("#dsColumn_div #coltype").val();var p=$("#dsColumn_div #isshow").val();e.isshow=Number(p)==1?true:false;e.fmt=$("#dsColumn_div #fmt").val();curTmpInfo.isupdate=true;if(g=="panel"){$("#datasettabs #"+e.tname+"_"+e.name+"_disp").text(e.dispName);$("#datasettabs #"+e.tname+"_"+e.name+"_tp").text(e.type);$("#datasettabs #"+e.tname+"_"+e.name+"_show").text(e.isshow?"是":"否");$("#datasettabs #"+e.tname+"_"+e.name+"_fmt").text(e.fmt);$("#datasettabs #"+e.tname+"_"+e.name+"_show").parents("tr").find("td:first").css("text-decoration",e.isshow?"none":"line-through")}else{if(g=="col"){var o=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:o.target,text:(e.dispName==""?e.name:e.dispName)});initselectDataTree()}}curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function reloadDatasetFilter(c){var d='<a href="javascript:newdatasetparam(false);" style="margin:3px;" id="ndatasetparam">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';d=d+"<tr><th>筛选字段</th><th>判断条件</th><th>筛选值</th><th>值类型</th><th>操作</th></tr>";for(var b=0;c.param&&b<c.param.length;b++){d=d+'<tr><td class="kpiData1 grid3-td">'+c.param[b].col+'</td><td class="kpiData1 grid3-td">'+c.param[b].type+'</td><td class="kpiData1 grid3-td">'+(c.param[b].val+(c.param[b].val2==""?"":"/"+c.param[b].val2))+'</td><td class="kpiData1 grid3-td">'+c.param[b].valuetype+'</td><td class="kpiData1 grid3-td"><a href="javascript:newdatasetparam(true,\''+c.param[b].id+"');\">编辑</a> <a href=\"javascript:delDatasetFilter('"+c.param[b].id+"');\">删除</a></td></tr>"}if(!c.param||c.param.length==0){d=d+'<tr><td class="kpiData1 grid3-td" align="center" colspan="5">无数据.</td></tr>'}d=d+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(d);$("#datasettabs #ndatasetparam").linkbutton({iconCls:"icon-add"})}function reloadDynamicCol(d){var f='<a href="javascript:;" style="margin:3px;" id="dynamiccol">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+'<tr><th width="15%">字段名</th><th width="15%">显示名</th><th width="30%">表达式</th><th width="15%">值类型</th><th width="12%">格式化</th><th width="12%">操作</th></tr>';for(var c=0;d.dynamic&&c<d.dynamic.length;c++){var e=d.dynamic[c];f=f+'<tr><td class="kpiData1 grid3-td">'+e.name+'</td><td class="kpiData1 grid3-td">'+e.dispName+'</td><td class="kpiData1 grid3-td">'+e.expression.replace(/@/g,"'")+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td">'+(e.fmt?e.fmt:"")+'</td><td class="kpiData1 grid3-td"><a href="javascript:;" col="'+e.name+'" id="dynamiccolupdate">编辑</a> <a href="javascript:;" col="'+e.name+'" id="dynamiccoldel">删除</a></td></tr>'}if(!d.dynamic||d.dynamic.length==0){f=f+'<tr><td class="kpiData1 grid3-td" align="center" colspan="5">无数据.</td></tr>'}f=f+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(f);var b=function(h){var n="";for(var l=0;l<dataType.length;l++){n=n+'<option value="'+dataType[l]+'" '+(h&&h.type==dataType[l]?"selected":"")+">"+dataType[l]+"</option>"}var g='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform" value="'+(h?h.name:"")+'">(添加后不能更改)<br/><span class="inputtext">显示名：</span><input type="text" id="dispname" name="dispname" class="inputform" value="'+(h?h.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea name="expression" id="expression" cols="40" style="height:52px;">'+(h?h.expression.replace(/@/g,"'"):"")+'</textarea></td></tr></tbody></table><span class="inputtext">值类型：</span><select id="valtype" class="inputform">'+n+'</select><br/><span class="inputtext">格式化</span><input type="text" id="fmt" value="'+(h&&h.fmt?h.fmt:"")+'" size="10"> (只对Int/Double类型起作用)</div>';if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:h?"编辑动态字段":"添加动态字段",width:380,height:280,closed:false,cache:false,modal:true,toolbar:null,content:g,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(h){h.dispName=$("#dsColumn_div #dispname").val();h.name=$("#dsColumn_div #colname").val();h.type=$("#dsColumn_div #valtype").val();h.expression=$("#dsColumn_div #expression").val().replace(/'/g,"@");h.fmt=$("#dsColumn_div #fmt").val()}else{var o={dispName:$("#dsColumn_div #dispname").val(),name:$("#dsColumn_div #colname").val(),tname:d.master,type:$("#dsColumn_div #valtype").val(),expression:$("#dsColumn_div #expression").val().replace(/'/g,"@"),fmt:$("#dsColumn_div #fmt").val()};if(!d.dynamic){d.dynamic=[]}d.dynamic.push(o)}$("#dsColumn_div").dialog("close");reloadDynamicCol(d)}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})};$("#datasettabs #dynamiccoldel").bind("click",function(){if(!confirm("是否确认删除？")){return}var g=-1;var h=$(this).attr("col");for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==h){g=c;break}}d.dynamic.splice(g,1);reloadDynamicCol(d)});$("#datasettabs #dynamiccolupdate").bind("click",function(){var g=$(this).attr("col");var h=null;for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==g){h=d.dynamic[c];break}}b(h)});$("#datasettabs #dynamiccol").bind("click",function(){b()}).linkbutton({iconCls:"icon-add"})}function delDatasetFilter(b){if(confirm("是否确认删除？")){var c=curTmpInfo.curDset;var a=-1;for(i=0;i<c.param.length;i++){if(c.param[i].id==b){a=i}}c.param.splice(a,1);reloadDatasetFilter(c)}}function newdatasetparam(h,c){var e=curTmpInfo.curDset;var d=null;if(e.param){for(i=0;i<e.param.length;i++){if(e.param[i].id==c){d=e.param[i]}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var g='<select id="filtercolumn" name="filtercolumn" class="inputform">';for(i=0;i<e.cols.length;i++){g=g+"<option value='"+e.cols[i].name+"@"+e.cols[i].tname+"' "+(d!=null&&d.col==e.cols[i].name&&d.tname==e.cols[i].tname?"selected":"")+">"+(e.cols[i].dispName==""?e.cols[i].name:e.cols[i].dispName)+"</option>"}g=g+"</select>";var b=["=",">",">=","<","<=","!=","between"];var f='<select id="filtertype" name="filtertype" class="inputform">';for(i=0;i<b.length;i++){f=f+'<option value="'+b[i]+'" '+(d!=null&&d.type==b[i]?"selected":"")+">"+b[i]+"</option>"}f=f+"</select>";var a='<div class="textpanel"><span class="inputtext">筛选字段：</span>'+g+'<br/><span class="inputtext">判断条件：</span>'+f+'<br/><span class="inputtext">筛选值：</span><input type="text" name="filtervalue" id="filtervalue" value="'+(d!=null?d.val:"")+'" class="inputform"><br><div style="'+(d!=null&&d.val2!=""?"":"display:none")+'"><span class="inputtext">筛选值2：</span><input type="text" name="filtervalue2" id="filtervalue2" value="'+(d!=null?d.val2:"")+'"  class="inputform"></div><span class="inputtext">筛选值类型：</span><select name="valuetype" id="valuetype" class="inputform"><option value="number" '+(d!=null&&d.valuetype=="number"?"selected":"")+'>数字类型</option><option value="string" '+(d!=null&&d.valuetype=="string"?"selected":"")+'>字符类型</option><option value="datetime" '+((d!=null&&d.valuetype=="datetime"?"selected":""))+">日期类型</option></select></div>";$("#dsColumn_div").dialog({title:(h==false?"添加筛选条件":"编辑筛选条件"),width:380,height:260,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(!e.param){e.param=[]}if($("#dsColumn_div #filterid").val()==""){msginfo("筛选标识是必填项！");$("#dsColumn_div #filterid").focus();return}if(h==true){var l=$("#dsColumn_div #filtercolumn").val().split("@");d.col=l[0];d.tname=l[1];d.type=$("#dsColumn_div #filtertype").val();d.val=$("#dsColumn_div #filtervalue").val();d.val2=$("#dsColumn_div #filtervalue2").val();d.valuetype=$("#dsColumn_div #valuetype").val()}else{var l=$("#dsColumn_div #filtercolumn").val().split("@");e.param.push({id:newGuid(),col:l[0],tname:l[1],type:$("#dsColumn_div #filtertype").val(),val:$("#dsColumn_div #filtervalue").val(),val2:$("#dsColumn_div #filtervalue2").val(),valuetype:$("#dsColumn_div #valuetype").val()})}reloadDatasetFilter(e);$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #filtertype").bind("change",function(){if($(this).val()=="between"){$("#dsColumn_div #filtervalue2").parent().css("display","block")}else{$("#dsColumn_div #filtervalue2").parent().css("display","none")}})}function findDatasourceById(a){var b=null;for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==a){b=pageInfo.datasource[i]}}return b}function findDatasetById(a){var b=null;for(var c=0;c<pageInfo.dataset.length;c++){var e=pageInfo.dataset[c];if(e.datasetid==a){b=e;break}}return b}if($==undefined){$=jQuery}function initpage(){$("#l_tab").tabs({fit:true,border:false});initselectDataTree();initmydatatree();loadMyReportTree();initparam();crtTable();if(pageInfo.grid&&pageInfo.grid.cols&&pageInfo.grid.cols.length>0){gridView(pageInfo.grid)}if(pageInfo.chart&&pageInfo.chart.kpiJson&&pageInfo.chart.kpiJson.length>0){var a=pageInfo.chart;addChart(a.chartJson.type,a)}$("table.grid5 tr.scrollColThead th span a.extKpibtn,.comp_table .title .ticon a,span.chartdel").live("mouseover",function(){$(this).css("opacity",1)}).live("mouseout",function(){$(this).css("opacity",0.6)})}function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#optarea #p_param div.ptabhelpr").remove();$("#optarea #p_param").append("<b>参数： </b>");for(i=0;i<pageInfo.params.length;i++){var b=$("#optarea #p_param");var a=pageInfo.params[i];var c='<span class="pppp" id="pa_'+a.id+'"><span title="筛选" onclick="paramFilter(\''+a.id+"', '"+a.type+"', '"+(a.dispName!=""?a.dispName:a.name)+'\')" class="text">'+dispalyParamName(a)+'</span><a class="one_p" title="删除" onclick="deleteParam(\''+a.id+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>';b.append(c)}}$("#optarea #p_param").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(g,f){var d=$("#selectdatatree").tree("getNode",f);$(f).draggable("proxy").find("span").removeClass("tree-dnd-no");$(f).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000");g.cancelBubble=true;g.stopPropagation()},onDragLeave:function(f,d){$(d).draggable("proxy").find("span").addClass("tree-dnd-no");$(d).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px dotted #999999");f.cancelBubble=true;f.stopPropagation()},onDrop:function(n,f){n.cancelBubble=true;n.stopPropagation();$(this).css("border","1px dotted #999999");var d=$("#selectdatatree").tree("getNode",f);if(!pageInfo.params){pageInfo.params=[]}var o=pageInfo.params;var l=findParamById(d.id);if(l!=null){msginfo("参数"+d.text+"已经存在。");return}var h={id:d.id,name:d.attributes.name,tname:d.attributes.tname,type:d.attributes.type,dispName:d.attributes.dispName,datasetid:d.attributes.tid,expression:d.attributes.expression};o.push(h);var g=$(this);g.find("div.ptabhelpr").remove();if(g.find("b").size()==0){g.append("<b>参数： </b>")}g.append('<span class="pppp" id="pa_'+h.id+'"><span title="筛选" onclick="paramFilter(\''+h.id+"', '"+h.type+"','"+d.text+'\')" class="text">'+d.text+'(无)</span><a class="one_p" title="删除" onclick="deleteParam(\''+h.id+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>');paramFilter(h.id,h.type,d.text)}})}function deleteParam(c){$("#optarea #p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#optarea #p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}gridView(pageInfo.grid);chartview(pageInfo.chart)}function paramFilter(l,e,c){var b=320;var d=200;var f=findParamById(l);var g=f.filter;var a="";if(e=="Double"||e=="Int"){a="<div style='line-height:25px; margin:5px;'><br/> "+c+'： &nbsp; <select id="ftype"><option value=""></option><option value=">" '+(g&&g.filterType==">"?"selected":"")+'>大于</option><option value=">=" '+(g&&g.filterType==">="?"selected":"")+'>大于等于</option><option value="<" '+(g&&g.filterType=="<"?"selected":"")+'>小于</option><option value="<=" '+(g&&g.filterType=="<="?"selected":"")+'>小于等于</option><option value="=" '+(g&&g.filterType=="="?"selected":"")+'>等于</option><option value="!=" '+(g&&g.filterType=="!="?"selected":"")+'>不等于</option><option value="between" '+(g&&g.filterType=="between"?"selected":"")+'>区间</option></select> &nbsp; <input type="text" id="startval" size="5" value="'+(g?g.val1:"")+'"><span id="endvalspan" style="display:'+(g&&g.filterType=="between"?"inline":"none")+'"> and <input type="text" id="endval" size="5" value="'+(g?g.val2:"")+'"></span></div>'}else{if(e=="String"){a="<div style='line-height:25px; margin:5px;'><br/> "+c+'：<select id="ftype"><option value=""></option><option value="=" '+(g&&g.filterType=="="?"selected":"")+'>等于</option><option value="!=" '+(g&&g.filterType=="!="?"selected":"")+'>不等于</option><option value="like" '+(g&&g.filterType=="like"?"selected":"")+'>包含</option></select> &nbsp; <input type="text" id="val1" size="13" value="'+(g?g.val1:"")+'"> </div>'}else{a='<div style=\'line-height:25px; margin:5px;\'><input type=\'hidden\' id=\'ftype\' value=\'between\'><br/> 开始时间：  <input type="text" size="20" id="stdt"  readonly="true" value="'+(g&&g.stdt?g.stdt:"")+'" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\'})" class="Wdate"><br/><br/>  结束时间： <input type="text" size="20" id="enddt"  readonly="true" onclick="WdatePicker({dateFmt:\'yyyy-MM-dd\'})" class="Wdate" value="'+(g&&g.enddt?g.enddt:"")+'"><br/>  </div>'}}$("#pdailog").dialog({title:c+" - 参数值筛选",width:b,height:d,closed:false,cache:false,modal:true,content:a,buttons:[{text:"确定",handler:function(){var s=$("#pdailog #ftype").val();if(s==""){msginfo("请选择筛选条件!");return}if(e=="Double"||e=="Int"){var n=$("#pdailog #startval").val();var q=$("#pdailog #endval").val();if(n==""){msginfo("请录入筛选值!");return}var p={filterType:s,val1:Number(n),val2:(q==""?0:Number(q))};f.filter=p}else{if(e=="String"){var r=$("#pdailog #val1").val();if(r==""){msginfo("请录入筛选值!");return}var p={filterType:s,val1:r};f.filter=p}else{if(e=="Date"){var h=$("#pdailog #stdt").val();var o=$("#pdailog #enddt").val();if(h==""||o==""){msginfo("请选择开始时间及结束时间!");return}var p={filterType:"between",stdt:h,enddt:o};f.filter=p}}}$("#p_param #pa_"+f.id+" span").text(dispalyParamName(f));$("#pdailog").dialog("close");curTmpInfo.isupdate=true;gridView(pageInfo.grid);chartview(pageInfo.chart)}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox();$("#pdailog #ftype").bind("change",function(){var h=$(this);if(h.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").val("");$("#pdailog #endval").val("")})}function dispalyParamName(c){var b=c.type;var a=c.filter;if(!a){return c.dispName==""?c.name:c.dispName}if((b=="Int"||b=="Double")&&a.filterType=="between"){return((c.dispName==""?c.name:c.dispName)+"("+a.filterType+" "+a.val1+" and "+a.val2+" )")}else{if(b=="String"&&a.filterType=="like"){return((c.dispName==""?c.name:c.dispName)+"(包含 "+a.val1+")")}else{if(b=="Date"){return((c.dispName==""?c.name:c.dispName)+"("+a.stdt+"到"+a.enddt+")")}else{return((c.dispName==""?c.name:c.dispName)+"("+a.filterType+a.val1+")")}}}}function savepage(c,b,e){if(curTmpInfo.view&&curTmpInfo.share=="y"){msginfo("您不能保存共享报表，请先另存报表后再修改。");return}var a=JSON.stringify(pageInfo);if(a=="{}"){msginfo("没有需要保存的内容！");return}var d=pageInfo.id;if(d==undefined||d==null){d=""}if(d==""){$.messager.prompt("提示信息","请输入您要保存的文件名称：",function(f){if(f){$.post("Report!save.action",{pageInfo:a,pageId:d,pageName:f,view:c},function(g){pageInfo.id=g;if(b!=undefined){b()}else{}loadMyReportTree();msginfo("保存成功！","suc");curTmpInfo.isupdate=false})}});$(".messager-input").focus()}else{$.post("Report!save.action",{pageInfo:a,pageId:d,view:c},function(f){pageInfo.id=f;if(b!=undefined){b()}else{}if(!e||e==false){msginfo("保存成功！","suc")}curTmpInfo.isupdate=false})}}function saveas(b){var a=JSON.stringify(pageInfo);$.messager.prompt("提示信息","请输入您要另存的文件名称：",function(c){if(c){$.post("Report!save.action",{pageInfo:a,pageId:"",pageName:c,view:b},function(d){loadMyReportTree();msginfo("保存成功！","suc")})}});$(".messager-input").focus()}function openreport(a){$("#pdailog").dialog({title:"打开报表",width:550,height:300,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},buttons:[{text:"确定",handler:function(){var c=$('input[name="reportId"]:checked').val();if(!c||c==null){msginfo("请至少选择一个报表！");return}$("#pdailog").dialog("close");var b=(a?"Report!view.action":"Report.action")+"?pageId="+c;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(a,function(){location.href=b})}else{location.href=b}}else{location.href=b}}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","MyReport!list.action?view="+curTmpInfo.view+"&t="+Math.random())}function newpage(a){var b=a?"Report!view.action":"Report.action";if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(a,function(){location.href=b})}else{location.href=b}}else{location.href=b}}function loadMyReportTree(){$("#myreporttree").tree({url:"MyReport!tree.action?view="+curTmpInfo.view,dnd:false,onDblClick:function(a){if(a.id=="sharereport"){return}location.href=(curTmpInfo.view?"Report!view.action":"Report.action")+"?pageId="+a.id},onContextMenu:function(b,a){b.preventDefault();if(a.id=="sharereport"||"y"==a.attributes.sharefile){return}if(curTmpInfo.view!=true){if(a.attributes.share=="y"){$("#myreportmenu").menu("disableItem",$("#myreportmenu #m_share"));$("#myreportmenu").menu("enableItem",$("#myreportmenu #m_share2"))}else{$("#myreportmenu").menu("enableItem",$("#myreportmenu #m_share"));$("#myreportmenu").menu("disableItem",$("#myreportmenu #m_share2"))}}$("#myreporttree").tree("select",a.target);$("#myreportmenu").menu("show",{left:b.pageX,top:b.pageY});pageInfo.reportId=a.id}})}function deletemyreport(){if(confirm("是否确认删除？")){$.post("MyReport!delete.action",{reportId:pageInfo.reportId,view:curTmpInfo.view},function(b){var a=$("#myreporttree").tree("getSelected");$("#myreporttree").tree("remove",a.target)})}}function chgreportname(){var a=$("#myreporttree").tree("getSelected");$.messager.prompt("提示信息","请输入新文件名称：",function(b){if(b){$.post("MyReport!rename.action",{reportId:pageInfo.reportId,reportName:b,view:curTmpInfo.view},function(c){if(a){$("#myreporttree").tree("update",{target:a.target,text:b})}})}});$(".messager-input").val(a.text);$(".messager-input").select()}function crtTable(){var a='<div class="title"><div class="tname">明细查询</div><div class="mvcomp"></div><div class="ticon"><a href="javascript:;" id="removetablebtn" title="删除对象"></a></div></div><div class="ctx"><table class="d_table"><tbody><tr><th><div class="tabhelpr" id="d_colDims">将字段拖入此处查询</div></th></tr><tr><td class="onesel">  </td></tr><tr><td  class="onesel2">  </td></tr><tr><td class="onesel">  </td></tr><tr><td class="onesel2"> </td></tr><tr><td class="onesel"> </td></tr></tbody></table></div>';$("#T2").html(a);$("#removetablebtn").click(function(){$("#T2").html("<div align=\"center\"><a href='javascript:;' id='addtablebtn'><img border='0' src='../resource/img/add.png' style='margin:5px;'></a></div>");delete pageInfo.grid;$("#addtablebtn").click(function(){crtTable()})});fireDropEvent()}function fireDropEvent(){$("#T2 #d_colDims").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(b,a){$(a).draggable("proxy").find("span").removeClass("tree-dnd-no");$(a).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T2 #d_colDims").css("border","1px solid #ff0000");b.cancelBubble=true;b.stopPropagation()},onDragLeave:function(b,a){$(a).draggable("proxy").find("span").addClass("tree-dnd-no");$(a).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T2 #d_colDims").css("border","none");b.cancelBubble=true;b.stopPropagation()},onDrop:function(f,d){$("#T2 #d_colDims").css("border","none");f.cancelBubble=true;f.stopPropagation();var a=pageInfo.grid;if(!a){pageInfo.grid=a={cols:[]}}var c=$("#selectdatatree").tree("getNode",d);if(a.datasetid&&a.datasetid!=c.attributes.tid){msginfo("你拖入的字段"+c.text+"与表格已有的内容不在同一个数据集中，拖放失败！");return}else{a.datasetid=c.attributes.tid}var b=function(e){var g=false;for(j=0;j<a.cols.length;j++){if(a.cols[j].id==e){g=true;break}}return g};if(b(c.id)){msginfo("您拖拽的字段 "+c.text+" 已经存在。");return}a.cols.push({id:c.id,name:c.attributes.name,tname:c.attributes.tname,type:c.attributes.type,dispName:c.attributes.dispName,fmt:c.attributes.fmt,expression:c.attributes.expression});gridView(a);curTmpInfo.isupdate=true}})}function optTableCol(b,d){var c=$(b).offset();curTmpInfo.colId=d;var a=findColById(d);if(a.sort=="asc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{if(a.sort=="desc"){$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-ok"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-blank"})}else{$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord1")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord2")).target,iconCls:"icon-blank"});$("#gridoptmenu").menu("setIcon",{target:$("#gridoptmenu").menu("getItem",$("#col_ord3")).target,iconCls:"icon-ok"})}}$("#gridoptmenu").menu("show",{left:c.left,top:c.top+19})}function findColById(b){var a=null;for(i=0;pageInfo.grid&&pageInfo.grid.cols&&i<pageInfo.grid.cols.length;i++){if(pageInfo.grid.cols[i].id==b){a=pageInfo.grid.cols[i];break}}return a}function gridView(b){if(!b){return}if(!b.cols||b.cols.length==0){crtTable();return}var c=findDatasetById(b.datasetid);var a=findDatasourceById(c.dsid);showloading();$.ajax({type:"POST",url:"GridView.action",dataType:"html",data:{gridJson:JSON.stringify(b),params:(pageInfo.params?JSON.stringify(pageInfo.params):"[]"),dset:JSON.stringify(c),dsource:JSON.stringify(a)},success:function(d){hideLoading();$("#T2 div.ctx").html(d);fireDropEvent()},error:function(d){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function tablePagination(b,a,e,g){b=b-1;var d=pageInfo.grid;d.pageSize=a;var f=findDatasetById(d.datasetid);var c=findDatasourceById(f.dsid);showloading();$.ajax({type:"POST",url:"GridView.action",dataType:"html",data:{gridJson:JSON.stringify(d),params:(pageInfo.params?JSON.stringify(pageInfo.params):"[]"),dset:JSON.stringify(f),dsource:JSON.stringify(c),currPage:b},success:function(h){hideLoading();$("#T2 div.ctx").html(h);fireDropEvent()},error:function(h){hideLoading();$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function gridColsort(b){var c=curTmpInfo.colId;var a=findColById(c);for(i=0;i<pageInfo.grid.cols.length;i++){delete pageInfo.grid.cols[i].sort}if(b!=""){a.sort=b}curTmpInfo.isupdate=true;gridView(pageInfo.grid)}function tableColmove(c){var d=curTmpInfo.colId;var b=pageInfo.grid.cols;if(b.length<=1){msginfo("无效移动。");return}for(var a=0;a<b.length;a++){if(b[a].id==d){if(c=="left"){if(a<=0){msginfo("无效移动。");return}else{var c=b[a-1];b[a-1]=b[a];b[a]=c;curTmpInfo.isupdate=true;gridView(pageInfo.grid);return}}else{if(c=="right"){if(a>=b.length-1){msginfo("无效移动。");return}else{var c=b[a+1];b[a+1]=b[a];b[a]=c;curTmpInfo.isupdate=true;gridView(pageInfo.grid);return}}}break}}}function delTableCol(e){var b=pageInfo.grid;var a=-1;for(i=0;i<b.cols.length;i++){var d=b.cols[i];if(d.id==e){a=i;break}}b.cols.splice(a,1);gridView(b)}function shareReport(b){var a=$("#myreporttree").tree("getSelected");if(a.attributes.share=="y"&&b=="y"){return}if(a.attributes.share!="y"&&b=="n"){return}if(confirm("是否"+(b=="n"?"取消":"")+"共享？")){$.ajax({type:"post",dataType:"json",url:b=="y"?"MyReport!share.action":"MyReport!unshare.action",data:{reportId:a.id},success:function(c){loadMyReportTree()}})}}function exportPage(){var a="<form name='expff' method='post' action=\"ReportExport.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:310,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var b=curTmpInfo.expType;$("#expff #type").val(b);$("#expff #json").val(JSON.stringify(pageInfo));if(!pageInfo.grid){msginfo("报表无内容。");return}$("#expff").submit();$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(b){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function msginfo(a,d){var c=null;if(d&&(d=="suc"||d=="info")){c="<div class='msginfo msgsuc'>"+a+"</div>"}else{c="<div class='msginfo msgerr'>"+a+"</div>"}var b="出错了";if(d&&d=="suc"){b="成功了"}else{if(d&&d=="info"){b="提示信息"}}$.messager.show({title:b,msg:c,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function encoder(h,g){var f=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0",".","-","*","/","'",":",";",">","<","~","!","@","#","$","%","^","&","(",")","{","}","[","]","|","_"];var e=["T","l","m",">","S","&","J","G","/","!","p","h","Z","7","q","_","U","(","0","a","X","f","^","@","D","~","M","t","O","6","9","C","N","K","H","g","w","4","F","<","e","2","R","o","$","d","V","v","]","#","[","L","r","b","Y","{","z","k","x","n","5","B","W","-","A","P","1","j","E","u","s","'","I","c","%",".","i","y","Q","*",")","3","8","}",";",":","|"];var a=function(o,c){var p=-1;for(var n=0;n<c.length;n++){if(o==c[n]){p=n;break}}return p};var d="";if(g=="encode"){for(var b=0;b<h.length;b++){var l=h.charAt(b);d=d+e[a(l,f)]}}else{if(g=="decode"){for(var b=0;b<h.length;b++){var l=h.charAt(b);d=d+f[a(l,e)]}}}return d}function showmsg(b){var a='<div class="textpanel" style="margin:25px;"><div class=\'msginfo msgsuc\'>'+b+"</div></div>";$("#pdailog").dialog({title:"提示信息",width:300,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){$("#pdailog").dialog("close")}}]})}function showloading(){var d=jQuery(document);var c=jQuery(window);var b=d.scrollTop()+60;var a=d.scrollLeft()+c.width()-200;$("#Cloading").css({top:b,left:a,display:"block"})}function hideLoading(){$("#Cloading").css("display","none")};