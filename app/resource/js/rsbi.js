if($==undefined){$=jQuery}function crtChart(e){var a=false;var d=false;var b=false;if(curTmpInfo.charttype){a=curTmpInfo.charttype=="pie"||curTmpInfo.charttype=="gauge";d=curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter";b=curTmpInfo.charttype=="bubble"}else{var c=findCompById(e);a=c.chartJson.type=="pie"||c.chartJson.type=="gauge";d=c.chartJson.type=="bubble"||c.chartJson.type=="scatter";b=c.chartJson.type=="bubble"}return'<div class="tsbd">'+(d?'<div class="ts_h">'+(a?"观察维度":"横轴")+'：<div id="y2col" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>':'<div class="ts_h">'+(a?"观察维度":"横轴")+'：<div id="xcol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+'<div class="ts_h">'+(a?"度量":"纵轴")+'：<div id="ycol" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>'+(b?'<div class="ts_h">气泡大小：<div id="y3col" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>':"")+(d?'<div class="ts_h">观察维度：<div id="xcol" class="h_ctx"><span class="charttip">将度量拖到这里</span></div></div>':"")+(b?"":'<div class="ts_h" '+(a?'style="display:none"':"")+'>图例：<div id="scol" class="h_ctx"><span class="charttip">将维度拖到这里</span></div></div>')+"</div>"+(a||d?"":"<div class=\"exchangexs\"><img src='../resource/img/exchangexs1.gif'><a title='交换维度' href='javascript:exchangexs("+e+", true);'><img src='../resource/img/reload.png' border='0'></a><img src='../resource/img/exchangexs2.gif'></div>")+'<div class="chartctx" style="'+(d?"height:220px;":"")+'">图形预览区域</div>'}function addChart(d){curTmpInfo.charttype=d;var c=getMaxCompId();var a="图形组件-";if(d=="line"){a=a+"曲线图"}else{if(d=="column"){a=a+"柱状图"}else{if(d=="pie"){a=a+"饼图"}else{if(d=="gauge"){a=a+"仪表盘"}else{if(d=="radar"){a=a+"雷达图"}else{if(d=="scatter"){a=a+"散点图"}else{if(d=="bubble"){a=a+"气泡图"}}}}}}}addComp(c,a,null,true,"chart");var b=findCompById(c);b.chartJson={type:d,xcol:{},ycol:{},scol:{},params:[]}}function insertChart(){$("#pdailog").dialog({title:"插入图形",width:380,height:350,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",handler:function(){if(curTmpInfo.selectChart==undefined){msginfo("您还未选择图形，请点击图形示意图片，再点确认按钮。")}else{addChart(curTmpInfo.selectChart);delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}},{text:"取消",handler:function(){delete curTmpInfo.selectChart;$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","Panel!insertChart.action")}function chartcss(){curTmpInfo.selectChart="line";$(".chartselect .selleft ul li").bind("click",function(){var b=$(this).attr("cid");$(".chartselect .selleft ul li").removeClass("select");$(this).addClass("select");$(".chartselect .selright .one").css("display","none");$("#schart"+b).css("display","block");var a=$("#schart"+b).attr("tp");curTmpInfo.selectChart=a})}function chartview(p,n){if(p.kpiJson==undefined||p.kpiJson.length==0){return}var o=JSON.stringify(p.chartJson);var h=JSON.stringify(p.kpiJson);var f=[];if(pageInfo.params&&pageInfo.params.length>0){for(d=0;d<pageInfo.params.length;d++){if(pageInfo.params[d].tid==p.tid){f.push(pageInfo.params[d])}}}var a=fundCubeById(p.tid);if(a==null){$("#T"+n+" div.ctx").html("组件关联的立方体已经失效，请移除该组件。");return}var l=findDatasetById(a.datasetid);if(l==null){$("#T"+n+" div.ctx").html("组件关联的数据集已经失效，请移除该组件。");return}var b={name:l.name,master:l.master,aggreTable:a.aggreTable,joininfo:l.joininfo,param:l.param};var c=findDatasourceById(l.dsid);if(c==null){$("#T"+n+" div.ctx").html("组件关联的数据源已经失效，请移除该组件。");return}var e=[];for(i=0;i<a.kpi.length;i++){var d=a.kpi[i];var g=d.aggre+"_"+d.id;e.push({calc:(d.calc==true?true:false),col_name:d.col,aggre:d.aggre,alias:g,tname:d.tname})}showloading();$.ajax({type:"POST",url:"ChartView.action",dataType:"html",data:{chartJson:o,kpiJson:h,divison:(a.divison?JSON.stringify(a.divison):"{}"),compId:n,cubeId:(a.cache?a.id:""),params:JSON.stringify(f),dset:JSON.stringify(b),dsource:JSON.stringify(c),cubeKpis:(a.cache?JSON.stringify(e):"[]")},success:function(q){hideLoading();$("#T"+n+" div.chartctx").css("height","auto");$("#T"+n+" div.chartctx").html(q)},error:function(q){hideLoading();$.messager.alert("出错了","系统出错，请查看后台日志。","error")}})}function initChartKpiDrop(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="xcol"||$(this).attr("id")=="scol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&$(this).attr("id")=="ycol"){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #ycol").css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var l=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(l));$("#T"+l+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#selectdatatree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"度量":"维度")+"与组件已有的内容不在同一个数据表中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的度量需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){d.kpiJson=[];d.kpiJson.push({kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,tname:f.attributes.tname,calc:f.attributes.calc,dyna:f.attributes.dyna});d.chartJson.ycol={type:"kpi"};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col,tid:d.tid,iscas:f.attributes.iscas,tname:f.attributes.tname,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,dyna:f.attributes.dyna,ord:f.attributes.ord,dateformat:f.attributes.dateformat};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col,tid:d.tid,iscas:f.attributes.iscas,tname:f.attributes.tname,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,valType:f.attributes.valType,dyna:f.attributes.dyna,ord:f.attributes.ord,dateformat:f.attributes.dateformat};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;chartview(d,l)}}})}function initChartByScatter(a){$("#T"+a+" #xcol, #T"+a+" #ycol, #T"+a+" #y2col, #T"+a+" #y3col, #T"+a+" #scol").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(d,c){var b=$("#datasettree").tree("getNode",c);var f=b.attributes.col_type;if(f==1&&($(this).attr("id")=="scol"||$(this).attr("id")=="xcol")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}if(f==2&&($(this).attr("id")=="ycol"||$(this).attr("id")=="y2col"||$(this).attr("id")=="y3col")){$(c).draggable("proxy").find("span").removeClass("tree-dnd-no");$(c).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#ff0000")}d.cancelBubble=true;d.stopPropagation()},onDragLeave:function(c,b){$(b).draggable("proxy").find("span").addClass("tree-dnd-no");$(b).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+a+" #"+$(this).attr("id")).css("border-color","#7F9DB9");c.cancelBubble=true;c.stopPropagation()},onDrop:function(h,g){var n=$(this).parents(".comp_table").attr("id").replace("T","");var d=findCompById(Number(n));$("#T"+n+" #"+$(this).attr("id")).css("border-color","#7F9DB9");var f=$("#datasettree").tree("getNode",g);h.cancelBubble=true;h.stopPropagation();if(d.tid!=undefined){if(d.tid!=f.attributes.tid){msginfo("您拖入的"+(f.attributes.col_type==2?"度量":"维度")+"与图形已有的内容不在同一个立方体中，拖放失败。");return}}if(f.attributes.calc_kpi==1){if(!isExistDateDim(d,"chart")){msginfo("您拖入的度量需要图形中有时间类型的维度(年/季度/月/日)。");return}}d.tid=f.attributes.tid;if(d.kpiJson==undefined){d.kpiJson=[]}if(f.attributes.col_type==1){var c=f.attributes.col_id;if(findDimById(c,d.chartJson.params)!=null){msginfo("您拖放的维度已存在于钻取维中，不能拖放。");return}}if(f.attributes.col_type==2&&$(this).attr("id")=="ycol"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的度量已存在当前图形中。");return}d.kpiJson[0]={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,tname:f.attributes.tname,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,calc:f.attributes.calc,dyna:f.attributes.dyna};d.chartJson.ycol={type:"kpi"};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'ycol','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y2col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[2]!=null&&d.kpiJson[2].kpi_id==f.attributes.col_id)){msginfo("您拖放的度量已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,tname:f.attributes.tname,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,calc:f.attributes.calc,dyna:f.attributes.dyna};d.kpiJson[1]=l;$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y2col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==2&&$(this).attr("id")=="y3col"){if(!d.kpiJson){d.kpiJson=[null,null,null]}if((d.kpiJson[0]!=null&&d.kpiJson[0].kpi_id==f.attributes.col_id)||(d.kpiJson[1]!=null&&d.kpiJson[1].kpi_id==f.attributes.col_id)){msginfo("您拖放的指标已存在当前图形中。");return}var l={kpi_id:f.attributes.col_id,kpi_name:f.text,col_name:f.attributes.col_name,aggre:f.attributes.aggre,tname:f.attributes.tname,fmt:f.attributes.fmt,alias:f.attributes.alias,tid:d.tid,unit:f.attributes.unit,rate:f.attributes.rate,calc:f.attributes.calc,dyna:f.attributes.dyna};d.kpiJson[2]=l;$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'y3col','"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="xcol"){if(d.chartJson.scol!=undefined&&d.chartJson.scol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于图例项中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.scol!=undefined&&d.chartJson.scol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.xcol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col,tid:d.tid,iscas:f.attributes.iscas,tname:f.attributes.tname,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,dyna:f.attributes.dyna,ord:f.attributes.ord};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+f.attributes.col_id+",'xcol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}if(f.attributes.col_type==1&&$(this).attr("id")=="scol"){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.id==f.attributes.col_id){msginfo("您拖放的维度已存在于横轴中，不能拖放。");return}var b=f.attributes.grouptype;if(b!=null&&b!=""){if(d.chartJson.xcol!=undefined&&d.chartJson.xcol.grouptype==b){msginfo("您拖放的维度与此图形中已有维度分类相同，不能拖放。");return}}d.chartJson.scol={id:f.attributes.col_id,dimdesc:f.text,type:f.attributes.dim_type,colname:f.attributes.col,tid:d.tid,iscas:f.attributes.iscas,tname:f.attributes.tname,tableName:f.attributes.tableName,tableColKey:f.attributes.tableColKey,tableColName:f.attributes.tableColName,dimord:f.attributes.dimord,dim_name:f.attributes.dim_name,grouptype:f.attributes.grouptype,dyna:f.attributes.dyna,ord:f.attributes.ord};$(this).html('<span class="charttxt">'+f.text+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+f.attributes.col_id+", 'scol', '"+f.text+"')\"></span>");curTmpInfo.isupdate=true;if(d.chartJson.type=="scatter"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null){chartview(d,n)}}if(d.chartJson.type=="bubble"){if(d.kpiJson[0]!=null&&d.kpiJson[1]!=null&&d.kpiJson[2]!=null){chartview(d,n)}}}}})}function backChartData(a){var c=a.id;if(!$.isEmptyObject(a.chartJson.xcol)){var b=a.chartJson.xcol;$("#T"+c+" #xcol").html('<span class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.id+",'xcol', '"+b.dimdesc+"')\"></span>")}if(!$.isEmptyObject(a.chartJson.ycol)){var b=a.kpiJson[0];$("#T"+c+" #ycol").html('<span class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'ycol','"+b.kpi_name+"')\"></span>")}if(a.kpiJson&&(a.chartJson.type=="scatter"||a.chartJson.type=="bubble")){var b=a.kpiJson[1];if(b!=null){$("#T"+c+" #y2col").html('<span class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y2col','"+b.kpi_name+"')\"></span>")}b=a.kpiJson[2];if(b!=null){$("#T"+c+" #y3col").html('<span class="charttxt">'+b.kpi_name+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+b.kpi_id+",'y3col','"+b.kpi_name+"')\"></span>")}}if(!$.isEmptyObject(a.chartJson.scol)){if(a.chartJson.type!="pie"&&a.chartJson.type!="gauge"){var b=a.chartJson.scol;$("#T"+c+" #scol").html('<span class="charttxt">'+b.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this,'+b.id+", 'scol', '"+b.dimdesc+"')\"></span>")}}}function chartmenu(b,e,d,a){var c=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.tp=d;curTmpInfo.compId=$(b).parents(".comp_table").attr("id").replace("T","");curTmpInfo.dimname=a;if(d=="ycol"||d=="y2col"||d=="y3col"){$("#chartoptmenu").menu("enableItem",$("#m_set"))}else{$("#chartoptmenu").menu("disableItem",$("#m_set"))}$("#chartoptmenu").menu("show",{left:c.left,top:c.top+20})}function chartsort(d){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var e=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){delete a.kpiJson[0].sort;a.chartJson.xcol.dimord=d}if(c=="ycol"){a.kpiJson[0].sort=d}if(c=="scol"){delete a.kpiJson[0].sort;a.chartJson.scol.dimord=d}curTmpInfo.isupdate=true;chartview(a,b)}function delChartKpiOrDim(){var c=curTmpInfo.tp;var b=curTmpInfo.compId;var d=curTmpInfo.ckid;var a=findCompById(b);if(c=="xcol"){a.chartJson.xcol={};$("#T"+b+" #xcol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}if(c=="ycol"){a.chartJson.ycol={};if(a.kpiJson.length>1){a.kpiJson[0]=null}else{a.kpiJson=[]}$("#T"+b+" #ycol").html('<span class="charttip">将度量拖到这里</span>')}if(c=="y2col"){if(a.kpiJson.length>1){a.kpiJson[1]=null}else{a.kpiJson=[]}$("#T"+b+" #y2col").html('<span class="charttip">将度量拖到这里</span>')}if(c=="y3col"){a.kpiJson[2]=null;$("#T"+b+" #y3col").html('<span class="charttip">将度量拖到这里</span>')}if(c=="scol"){a.chartJson.scol={};$("#T"+b+" #scol").html('<span class="charttip">将维度拖到这里</span>');curTmpInfo.isupdate=true;chartview(a,b)}}function setChartKpi(){var g=curTmpInfo.tp;if(g=="xcol"||g=="scol"){return}var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var a=curTmpInfo.dimname;var d=findCompById(h);var e=null;if(g=="ycol"){e=d.kpiJson[0]}else{if(g=="y2col"){e=d.kpiJson[1]}else{if(g=="y3col"){e=d.kpiJson[2]}}}var b=fundCubeById(e.tid);var c=findCubeKpiById(b,f);var l='<div class="textpanel"><span class="inputtext">度量名称：</span>'+e.kpi_name+'<br><span class="inputtext">所属表/字段：</span> '+e.tname+" / "+e.col_name+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+(e.unit?e.unit:"")+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform"><option value=""></option><option value="###,##0">整数</option><option value="###,##0.00">小数</option><option value="0.00%">百分比</option></select><br/><span class="inputtext">度量解释：</span>'+(c.kpinote?unescape(c.kpinote):"")+"</div>";$("#pdailog").dialog({title:"度量属性",width:320,height:245,closed:false,cache:false,modal:true,content:l,toolbar:null,buttons:[{text:"确定",handler:function(){e.fmt=$("#pdailog #fmt").val();e.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;chartview(d,h)}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+e.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+e.rate+"']").attr("selected",true)}function chartfilterDims(){var n=curTmpInfo.tp;var l=curTmpInfo.ckid;var q=curTmpInfo.compId.replace("T","");var a=curTmpInfo.dimname;var f=findCompById(q);var e=null;if(n=="xcol"){e=f.chartJson.xcol}else{if(n=="scol"){e=f.chartJson.scol}else{return kpiFilter("chart")}}var h=[];if(e.vals){h=e.vals.split(",")}var o=function(t){var s=false;for(j=0;j<h.length;j++){if(t==h[j]){s=true;break}}return s};var b=fundCubeById(e.tid);var g=findDatasetById(b.datasetid);var c=findDatasourceById(g.dsid);var r="";var p="";var d=e.valStrs?e.valStrs.split(","):[];for(j=0;j<h.length;j++){p=p+'<div class="fltone"><input type="checkbox" id="S'+h[j]+'" name="dimselcet" value="'+h[j]+'" desc="'+d[j]+'"><label for="S'+h[j]+'">'+d[j]+"</label></div>"}r='<div class="dxwd"><div class="wdhead">待选维度</div><input id="dimsearch" style="width:230px;"></input><div class="wdlist" style="height:278px;"></div></div><div class="xzwdbtn"><input type="button" value=">" id="xzwd" style="margin-top:120px;" title="选择"><br/><input type="button" value="<" id="scwd" title="删除"></div><div class="yxwd"><div class="wdhead">已选维度</div><div class="wdlist">'+p+"</div></div>";$("#pdailog").dialog({title:a+" - 维度筛选",width:546,height:400,closed:false,cache:false,modal:true,content:r,buttons:[{text:"确定",handler:function(){var t="";var s="";var u=$("#pdailog input[name='dimselcet']");u.each(function(w,v){t=t+$(this).val();s=s+$(this).attr("desc");if(w!=u.size()-1){t=t+",";s=s+","}});e.vals=t;e.valStrs=s;curTmpInfo.isupdate=true;chartview(f,q);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(e.tableColKey==""||e.tableName==""||e.tableColName==""){loadDimFunc2(b,c,e,"")}else{loadDimFunc(b,c,e,"")}$("#pdailog #xzwd").click(function(){var s=$("#pdailog input[name='dimselcet']");var t=function(v){var u=false;for(i=0;i<s.size();i++){if($(s.get(i)).val()==v){u=true;break}}return u};$("#pdailog input[name='dimval']:checkbox:checked").each(function(u,v){if(!t($(v).val())){var w='<div class="fltone"><input type="checkbox" desc="'+$(v).attr("desc")+'" value="'+$(v).val()+'" name="dimselcet" id="S'+$(v).val()+'"><label for="S'+$(v).val()+'">'+$(v).attr("desc")+"</label></div>";$("#pdailog .yxwd .wdlist").append(w)}})});$("#pdailog #scwd").click(function(){$("#pdailog input[name='dimselcet']:checkbox:checked").each(function(s,t){$(t).parent().remove()})});$("#pdailog #dimsearch").searchbox({searcher:function(t,s){if(e.tableName==""||e.tableColKey==""||e.tableColName==""){loadDimFunc2(c,e,t)}else{loadDimFunc(c,e,t)}},prompt:"维度搜索..."})}function exchangexs(d,f){var b=findCompById(d);if(b.chartJson==undefined||(b.chartJson.xcol==undefined&&b.chartJson.scol==undefined)){msginfo("您还未选择维度。")}var c=b.chartJson.xcol;b.chartJson.xcol=b.chartJson.scol;b.chartJson.scol=c;if(b.chartJson.xcol&&b.chartJson.xcol.id){var e=b.chartJson.xcol;$("#T"+d+" #xcol").html('<span class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'xcol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #xcol").html('<span class="charttip">将维度拖到这里</span>')}if(b.chartJson.scol&&b.chartJson.scol.id){var e=b.chartJson.scol;$("#T"+d+" #scol").html('<span class="charttxt">'+(e.dimdesc?e.dimdesc:"")+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+e.id+",'scol', '"+e.dimdesc+"')\"></span>")}else{$("#T"+d+" #scol").html('<span class="charttip">将维度拖到这里</span>')}curTmpInfo.isupdate=true;chartview(b,d);if(b.complink&&f){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(a,b)){curTmpInfo.compId="T"+a.id;changecolrow(false)}}}function formatNumber(h,p){if(p.indexOf("%")>0){h=h*100}var b=p?p.split("."):[""];var o="";var t=0;if(b.length>1){t=b[1].length}var d=1;for(g=0;g<t;g++){d=d*10}h=h*d;h=Math.round(h);h=h/d;var s=h?h.toString().split("."):["0"];var q=s[0];var c=b[0];var g=q.length-1;var u=false;for(var n=c.length-1;n>=0;n--){switch(c.substr(n,1)){case"#":if(g>=0){o=q.substr(g--,1)+o}break;case"0":if(g>=0){o=q.substr(g--,1)+o}else{o="0"+o}break;case",":u=true;o=","+o;break}}if(g>=0){if(u){var e=q.length;for(;g>=0;g--){o=q.substr(g,1)+o;if(g>0&&((e-g)%3)==0){o=","+o}}}else{o=q.substr(0,g+1)+o}}o=o+".";q=s.length>1?s[1]:"";c=b.length>1?b[1]:"";g=0;for(var n=0;n<c.length;n++){switch(c.substr(n,1)){case"#":if(g<q.length){o+=q.substr(g++,1)}break;case"0":if(g<q.length){o+=q.substr(g++,1)}else{o+="0"}break}}var a=o.replace(/^,+/,"").replace(/\.$/,"");if(p.indexOf("%")>0){a=a+"%"}return a}function crtChartfromTab(){var compId=curTmpInfo.compId.replace("T","");var comp=findCompById(compId);var rows="";for(i=0;i<comp.tableJson.rows.length;i++){var selected="";if(i==comp.tableJson.rows.length-1){selected="selected"}rows=rows+"<option value='"+comp.tableJson.rows[i].id+"' "+selected+">"+comp.tableJson.rows[i].dimdesc+"</option>"}var cols="";for(i=0;i<comp.tableJson.cols.length;i++){var selected="";if(i==comp.tableJson.cols.length-1){selected="selected"}cols=cols+"<option value='"+comp.tableJson.cols[i].id+"' "+selected+">"+comp.tableJson.cols[i].dimdesc+"</option>"}var ctx="<div style='line-height:25px; margin:5px;'>类型：<select id='charttype'><option value='line'>曲线图</option><option value='column'>柱状图</option><option value='pie'>饼图</option><option value='radar'>雷达图</option></select><br>横轴：<select id='hz'>"+rows+"</select><br/>图例：<select id='zz'>"+cols+"</select></div>";$("#pdailog").dialog({title:"通过表格数据生成图形",width:220,height:200,closed:false,cache:false,modal:true,content:ctx,toolbar:null,buttons:[{text:"确定",handler:function(){var tp=$("#charttype").val();var xcol=$("#hz").val();var scol=$("#zz").val();var kpi=curTmpInfo.ckid;$("#pdailog").dialog("close");var chart={id:getMaxCompId(),name:"图形组件",type:"chart",chartJson:{type:tp,ycol:{type:"kpi"},params:[]},tid:comp.tid,tname:comp.tname,ttype:comp.ttype,kpiJson:[],complink:comp.id};comp.complink=chart.id;var k=eval("("+JSON.stringify(findKpiById(kpi,comp.kpiJson))+")");chart.kpiJson.push(k);if(xcol!=null&&xcol!=""){chart.chartJson.xcol=eval("("+JSON.stringify(findDimById(xcol,comp.tableJson.rows))+")")}if(scol!=null&&scol!=""){chart.chartJson.scol=eval("("+JSON.stringify(findDimById(scol,comp.tableJson.cols))+")")}curTmpInfo.isupdate=true;curTmpInfo.charttype=tp;addComp(chart.id,chart.name,null,false,chart.type,chart);pageInfo.comps.push(chart);var p=$("#T"+chart.id).offset();$("#optarea").scrollTop(p.top)}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}if($==undefined){$=jQuery}var dataType=["String","Int","Double","Date"];var dateformat=["yyyymmdd","yyyy-mm-dd","yyyy年mm月dd日","yyyymm","yyyy-mm","yyyy年mm月","yyyyqq","yyyy-qq","yyyy年qq季度","yyyy","yyyy年"];function selectcube(){var a='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0"><tr style="background-color:#FFF"><th width="10%">选择</th><th width="10%">序号</th><th width="40%">立方体名称</th><th width="40%">立方体说明</th></tr>';for(i=0;pageInfo.cube&&i<pageInfo.cube.length;i++){var b=pageInfo.cube[i];a=a+'<tr><td class=\'kpiData1 grid3-td\'><input type="checkbox" id="selectdataset" name="selectdataset" value="'+b.id+"\" /></td><td class='kpiData1 grid3-td'>"+(i+1)+"</td><td class='kpiData1 grid3-td'>"+b.name+"</td><td class='kpiData1 grid3-td'>"+b.note+"</td></tr>"}if(!pageInfo.cube||pageInfo.cube.length==0){a=a+"<tr><td class='kpiData1 grid3-td' align='center' colspan=\"4\">无数据，请先建立数据模型。</td></tr>"}a=a+"</table>";$("#pdailog").dialog({title:"选择多维立方体",width:640,height:340,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var c=jQuery("input[name='selectdataset']:checkbox:checked");var d="";c.each(function(f,e){d=d+$(this).val();if(c.size()-1!=f){d=d+","}});if(d!=""){pageInfo.selectDs=d;initselectDataTree();$("#l_tab").tabs("select",0)}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function selectAllcube(){var a=function(d){var b='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0"><tr style="background-color:#FFF"><th width="10%">选择</th><th width="30%">立方体名称</th><th width="30%">立方体说明</th><th width="30%">所属文件</th></tr>';for(i=0;d&&i<d.length;i++){var c=d[i];b=b+'<tr><td class=\'kpiData1 grid3-td\'><input type="radio" id="selectdataset" name="selectdataset" value="'+c.fileId+","+c.cubeId+"\" /></td><td class='kpiData1 grid3-td'>"+c.cubeName+"</td><td class='kpiData1 grid3-td'>"+c.note+"</td><td class='kpiData1 grid3-td'>"+c.fileName+"</td></tr>"}if(!d||d.length==0){b=b+"<tr><td class='kpiData1 grid3-td' align='center' colspan=\"4\">无数据。</td></tr>"}b=b+"</table>";$("#pdailog").dialog({title:"选择多维立方体",width:640,height:340,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",handler:function(){var e=$("input[name='selectdataset']:radio:checked");var g=e.val();if(!g){msginfo("请选择立方体。");return}var f=g.split(",");getCubeData(f[0],f[1]);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})};$.ajax({type:"POST",url:"Cube!getAllAuthCubes.action",dataType:"json",data:{},success:function(b){a(b)},error:function(b){$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function getCubeData(a,b){$.ajax({type:"POST",url:"Cube!getCubeInfo.action",dataType:"json",data:{fileId:a,cubeId:b},success:function(c){pageInfo.cube=[c.cube];pageInfo.datasource=[c.dsource];pageInfo.dataset=[c.dataset];pageInfo.selectDs=b;initselectDataTree()},error:function(c){$.messager.alert("出错了","系统出错，请联系管理员。","error")}})}function initselectDataTree(){var a=false;if(pageInfo.selectDs&&pageInfo.selectDs!=""){var b=pageInfo.selectDs.split(",");var e=[];var n=0;for(i=0;i<b.length;i++){var c=fundCubeById(b[i]);if(c==null){continue}a=true;e.push({id:c.id,text:c.name,iconCls:"icon-cube",children:[{id:"data_wd",text:"维度",iconCls:"icon-dim",children:[],attributes:{drag:"n"}},{id:"data_dl",text:"度量",iconCls:"icon-kpi",children:[],attributes:{drag:"n"}}],attributes:{drag:"n"}});var h=c.dim;var s=c.aggreTable||c.divison?true:false;var q=0;for(j=0;h&&j<h.length;j++){var o=h[j];if(o.tp=="dim"){e[n].children[0].children.push({id:o.id,text:o.name,iconCls:"icon-dim",attributes:{col_type:1,tid:c.id,col_id:o.id,dim_type:"frd",col:(s?o.refId:o.col),iscas:"n",tname:(o.tname),tableName:o.codetable,tableColKey:o.keycol,tableColName:o.valcol,dimord:null,dim_name:o.col,grouptype:"",valType:(o.vtype?o.vtype:"number"),dyna:(o.dyna?o.dyna:false),dateformat:(o.dateformat?o.dateformat:""),ord:q}});q++}else{if(o.tp=="group"){var r={id:o.id,text:o.name,iconCls:"icon-group",attributes:{drag:"n"},children:[]};e[n].children[0].children.push(r);for(f=0;f<o.children.length;f++){var l=o.children[f];r.children.push({id:l.id,text:l.name,iconCls:"icon-dim",attributes:{col_type:1,tid:c.id,col_id:l.id,dim_type:(!l.dimtype||l.dimtype==""?"frd":l.dimtype),col:(s?l.refId:l.col),iscas:(f==0?"n":"y"),tname:(l.tname),tableName:l.codetable,tableColKey:l.keycol,tableColName:l.valcol,dimord:null,dim_name:l.col,grouptype:(!o.grouptype||o.grouptype.length==0?(o.id+""):o.grouptype),valType:(l.vtype?l.vtype:"number"),dyna:(l.dyna?l.dyna:false),dateformat:(l.dateformat?l.dateformat:""),ord:q}});q++}}}}var p=c.kpi;for(j=0;p&&j<p.length;j++){var f=p[j];var g=f.aggre+"_"+f.id;e[n].children[1].children.push({id:f.id,text:f.name,iconCls:(f.calc?"icon-ckpi":"icon-kpi"),attributes:{col_type:2,tid:c.id,col_id:f.id,col_name:f.col,tname:(f.tname),aggre:f.aggre,fmt:f.fmt,alias:g,unit:f.unit,rate:null,calc:(f.calc==true?true:false),dyna:(f.dyna?f.dyna:false)}})}n=n+1}$("#selectdatatree").tree({dnd:true,lines:true,data:e,onBeforeDrag:function(d){if(d.attributes&&d.attributes.drag=="n"){return false}return true},onDragEnter:function(t,d){return false},onContextMenu:function(t,d){msginfo("拖拽维度或度量到组件内进行数据分析。","info");t.preventDefault()}})}if(!a){$("#selectdatatree").tree({dnd:false,data:[{id:"nodata",text:"您还未选择立方体数据。",iconCls:"icon-no"}]})}}function newdatasource(c){var b;if(c){b=findDatasourceById(curTmpInfo.id)}var a='<div id="dsource_tab" style="height:auto; width:auto;"><div title="JDBC"><form id="datasourceform" name="datasourceform"><input type="hidden" name="connstate" id="connstate"><div class="textpanel"><span class="inputtext">数据源名称：</span><input type="text" id="dsname" name="dsname" class="inputform" value="'+(b&&b.use=="jdbc"?b.dsname:"")+'" style="width:260px;"><br/><span class="inputtext">数据源类型：</span><select id="linktype" name="linktype" class="inputform" style="width:260px;"><option value="mysql" '+(b&&b.use=="jdbc"&&b.linktype=="mysql"?"selected":"")+'>MYSQL</option><option value="oracle" '+(b&&b.use=="jdbc"&&b.use=="jdbc"&&b.linktype=="oracle"?"selected":"")+'>ORACLE</option><option value="sqlserver" '+(b&&b.use=="jdbc"&&b.linktype=="sqlserver"?"selected":"")+'>SQL Server</option></select><br/><span class="inputtext">连接字符串：</span><input type="text" id="linkurl" name="linkurl" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?b.linkurl:"jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")+'"><br/><span class="inputtext">连接用户名：</span><input type="text" id="linkname" name="linkname" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?b.linkname:"")+'"> <br/><span class="inputtext">连接密码：</span><input type="password" name="linkpwd" id="linkpwd" class="inputform" style="width:260px;" value="'+(b&&b.use=="jdbc"?encoder(b.linkpwd,"decode"):"")+'"></div></form></div><div data-options="'+(b&&b.use=="jndi"?"selected:true":"")+'" title="JNDI"><div class="textpanel"><span class="inputtext">JNDI名称：</span><input type="text" value="'+(b&&b.use=="jndi"?b.jndiname:"")+'" class="inputform" name="jndiname" id="jndiname" style="width:260px;"></div></div></div>';$("#pdailog").dialog({title:c?"编辑数据源":"创建数据源",width:410,height:270,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"测试连接",handler:function(){var e=$("#dsource_tab").tabs("getSelected");var d=$("#dsource_tab").tabs("getTabIndex",e);if(d==0){var f=$("#datasourceform").serialize();$.ajax({type:"POST",url:"Data!testConn.action",dataType:"json",data:f,success:function(g){if(g.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}else{if(d==1){var f={jndiname:$("#dsource_tab #jndiname").val()};$.ajax({type:"POST",url:"Data!testJNDI.action",dataType:"json",data:f,success:function(g){if(g.ret){msginfo("测试成功！","suc");$("#datasourceform #connstate").val("y")}else{msginfo("测试失败！")}}})}}}},{text:"确定",handler:function(){var e=$("#dsource_tab").tabs("getSelected");var d=$("#dsource_tab").tabs("getTabIndex",e);if(d==0){if($("#datasourceform #dsname").val()==""){msginfo("请输入数据源名称！");$("#datasourceform #dsname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(c==false){var g={linktype:$("#linktype").val(),linkname:$("#linkname").val(),linkpwd:encoder($("#linkpwd").val(),"encode"),linkurl:$("#linkurl").val(),dsname:$("#datasourceform #dsname").val(),dsid:newGuid(),use:"jdbc"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(g);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:g.dsid,text:g.dsname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#l_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.linktype=$("#linktype").val();datasource.linkname=$("#linkname").val();datasource.linkpwd=encoder($("#linkpwd").val(),"encode");datasource.linkurl=$("#linkurl").val();datasource.dsname=$("#dsname").val();datasource.use="jdbc";var f=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:f.target,text:datasource.dsname});break}}}}else{if(d==1){if($("#dsource_tab #jndiname").val()==""){msginfo("请输入JNDI名称！");$("#dsource_tab #jndiname").focus();return}if($("#datasourceform #connstate").val()!="y"){msginfo("请先测试连接正常再确定！");return}if(c==false){var g={jndiname:$("#dsource_tab #jndiname").val(),dsid:newGuid(),use:"jndi"};if(!pageInfo.datasource){pageInfo.datasource=[]}pageInfo.datasource.push(g);$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjy']"),data:[{id:g.dsid,text:g.jndiname,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}}]});$("#mydatatree").tree("expand",$("#mydatatree div[node-id='sjy']"));$("#l_tab").tabs("select",1)}else{for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==curTmpInfo.id){datasource=pageInfo.datasource[i];datasource.jndiname=$("#jndiname").val();datasource.use="jndi";var f=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:f.target,text:datasource.jndiname});break}}}}}curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #dsource_tab").tabs({fit:true,border:false});$("#pdailog #linktype").change(function(){var d=$(this).val();if(d=="mysql"){$("#pdailog #linkurl").val("jdbc:mysql://ip/database?useUnicode=true&characterEncoding=UTF8")}else{if(d=="oracle"){$("#pdailog #linkurl").val("jdbc:oracle:thin:@ip:1521:sid")}else{if(d=="sqlserver"){$("#pdailog #linkurl").val("jdbc:jtds:sqlserver://ip:1433/database")}}}})}function initmydatatree(a){var c=[{text:"数据源",id:"sjy",state:"closed",iconCls:"icon-dsource",attributes:{showmenu:true,onlyAdd:true}},{text:"数据集",id:"sjj",state:(a?"open":"closed"),iconCls:"icon-dataset2",attributes:{showmenu:true,onlyAdd:true}},{text:"立方体",id:"lft",state:"closed",iconCls:"icon-cube",attributes:{showmenu:true,onlyAdd:true}}];if(pageInfo.datasource){c[0].children=[];for(var h=0;h<pageInfo.datasource.length;h++){c[0].children.push({text:(pageInfo.datasource[h].use=="jdbc"?pageInfo.datasource[h].dsname:pageInfo.datasource[h].jndiname),id:pageInfo.datasource[h].dsid,iconCls:"icon-dsource",attributes:{showmenu:true,type:"dsource"}})}}if(pageInfo.dataset){c[1].children=[];for(var h=0;h<pageInfo.dataset.length;h++){var g={text:pageInfo.dataset[h].name,id:pageInfo.dataset[h].datasetid,iconCls:"icon-dataset2",attributes:{showmenu:true,type:"dset"},children:[],state:"open"};c[1].children.push(g);var b=pageInfo.dataset[h].cols;if(b&&b[0]!=null){g.children=initdatasetview(b,pageInfo.dataset[h].datasetid)}}}if(pageInfo.cube){c[2].children=[];for(var h=0;h<pageInfo.cube.length;h++){var d=pageInfo.cube[h];var g={text:d.name,id:d.id,iconCls:"icon-cube",attributes:{showmenu:true,type:"cube"},children:[],state:"open"};c[2].children.push(g);var b=d.dim;if(b){for(var f=0;f<b.length;f++){if(b[f].tp=="dim"){g.children.push({text:b[f].name,id:b[f].id,iconCls:"icon-dim",attributes:{showmenu:true,drag:"n",type:"dim",cubeId:d.id}})}else{if(b[f].tp=="group"){var n={text:b[f].name,id:b[f].id,iconCls:"icon-group",children:[],attributes:{showmenu:true,drag:"n",type:"group",cubeId:d.id}};g.children.push(n);for(var e=0;e<b[f].children.length;e++){var l=b[f].children[e];n.children.push({text:l.name,id:l.id,iconCls:"icon-dim",attributes:{showmenu:true,drag:"n",type:"dim",cubeId:d.id}})}}}}}var e=d.kpi;if(e){for(var f=0;f<e.length;f++){g.children.push({text:e[f].aggre+"("+e[f].name+")",id:e[f].id,iconCls:(e[f].calc?"icon-ckpi":"icon-kpi"),attributes:{showmenu:true,drag:"n",type:"kpi",cubeId:d.id}})}}}}$("#mydatatree").tree({data:c,dnd:false,onContextMenu:function(p,o){if(o.attributes&&o.attributes.showmenu==true){p.preventDefault();curTmpInfo.tp=o.attributes.type;curTmpInfo.id=o.id;if(o.attributes.onlyAdd){$("#mydatasetmenu").menu("disableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("disableItem",$("#dataset_del"));$("#mydatasetmenu").menu("enableItem",$("#dataset_add"))}else{$("#mydatasetmenu").menu("enableItem",$("#dataset_mod"));$("#mydatasetmenu").menu("enableItem",$("#dataset_del"));$("#mydatasetmenu").menu("disableItem",$("#dataset_add"))}$("#mydatatree").tree("select",o.target);$("#mydatasetmenu").menu("show",{left:p.pageX,top:p.pageY})}else{p.preventDefault()}}})}function newdatactx(){var a=curTmpInfo.id;if(a=="sjy"){newdatasource(false)}else{if(a=="sjj"){newdataset()}else{if(a=="lft"){newcube()}}}}function editmydata(){var b=curTmpInfo.tp;var c=curTmpInfo.id;if(b=="dsource"){newdatasource(true)}else{if(b=="dset"){editdataset()}else{if(b=="dsetTable"){var a=$("#mydatatree").tree("getSelected");editdataset(a.attributes.datasetid)}else{if(b=="cube"){newcube(true,c)}else{if(b=="dsetcol"){var a=$("#mydatatree").tree("getSelected");editDsColumn(a.id,a.attributes.datasetid,a.attributes.tname,"col")}else{if(b=="kpi"||b=="dim"||b=="group"){var a=$("#mydatatree").tree("getSelected");editcubecol2(b,c,a)}}}}}}}function deletemydata(){var o=curTmpInfo.tp;var a=curTmpInfo.id;if(o=="dsetTable"){msginfo("请直接在要删除的数据集上右键删除数据集。");return}if(confirm("是否确认删除？")==false){return}if(o=="dsource"){var c=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",c.target);var q=-1;for(e=0;e<pageInfo.datasource.length;e++){if(pageInfo.datasource[e].dsid==a){q=e;break}}pageInfo.datasource.splice(q,1)}if(o=="dset"){var c=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",c.target);var q=-1;for(e=0;e<pageInfo.dataset.length;e++){if(pageInfo.dataset[e].datasetid==a){q=e;break}}pageInfo.dataset.splice(q,1)}if(o=="dsetcol"){var c=$("#mydatatree").tree("getSelected");var n=findDatasetById(c.attributes.datasetid);var l=function(g,t){var d=null;for(j=0;n.joininfo&&j<n.joininfo.length;j++){if(n.master==t&&n.joininfo[j].col==g){d=n.joininfo[j];break}else{if(t==n.joininfo[j].ref&&g==n.joininfo[j].refKey){d=n.joininfo[j];break}}}return d};if(l(c.id,c.attributes.tname)!=null){msginfo("当前字段是表关联字段，不允许删除！");return}var s=c.attributes.tname;var q=-1;for(e=0;e<n.cols.length;e++){if(n.cols[e].tname==s&&n.cols[e].name==c.id){q=e;break}}n.cols.splice(q,1);$("#mydatatree").tree("remove",c.target)}if(o=="cube"){var c=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("remove",c.target);var q=-1;for(e=0;e<pageInfo.cube.length;e++){if(pageInfo.cube[e].id==a){q=e;break}}pageInfo.cube.splice(q,1);initselectDataTree()}if(o=="dim"){var c=$("#mydatatree").tree("getSelected");var b=fundCubeById(c.attributes.cubeId);var p=$("#mydatatree").tree("getParent",c.target);if(p.attributes.type=="cube"){var q=-1;for(var e=0;e<b.dim.length;e++){var h=b.dim[e];if(h.tp=="dim"&&h.id==c.id){q=e;break}}b.dim.splice(q,1)}else{var r=null;for(var e=0;e<b.dim.length;e++){var h=b.dim[e];if(h.tp=="group"&&h.id==p.id){r=h;break}}var q=-1;for(j=0;j<r.children.length;j++){var f=r.children[j];if(f.id==c.id){q=j;break}}r.children.splice(q,1)}initselectDataTree();$("#mydatatree").tree("remove",c.target)}if(o=="kpi"){var c=$("#mydatatree").tree("getSelected");var b=fundCubeById(c.attributes.cubeId);var q=findCubeKpiById(b,c.id,true);b.kpi.splice(q,1);$("#mydatatree").tree("remove",c.target);initselectDataTree()}if(o=="group"){var c=$("#mydatatree").tree("getSelected");var b=fundCubeById(c.attributes.cubeId);var r=findCubeGroupById(b,c.id);if(r.children&&r.children.length>0){msginfo("分组下级包含维度，不能删除。");return}var q=findCubeGroupById(b,c.id,true);b.dim.splice(q,1);$("#mydatatree").tree("remove",c.target);initselectDataTree()}curTmpInfo.isupdate=true}function newdataset(){if(!pageInfo.datasource){msginfo("创建数据集前，请先创建数据源！");return}var d='<select id="dsid" name="dsid" class="inputform">';for(var c=0;pageInfo.datasource&&c<pageInfo.datasource.length;c++){d=d+'<option value="'+pageInfo.datasource[c].dsid+'">'+(pageInfo.datasource[c].use=="jdbc"?pageInfo.datasource[c].dsname:pageInfo.datasource[c].jndiname)+"</option>"}d=d+"</select>";var a='<div id="crtdataset" class="easyui-tabs" data-options="fit:true,border:false,tabPosition:\'left\'"><div title="基本信息"><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" id="datasetname" name="datasetname" class="inputform"><br/><span class="inputtext">连接数据源：</span>'+d+'<br/><span class="inputtext" style="width:120px;">选择需要分析的表：</span><br/><div class="tablesleft"><div class="tabletitle">待选表</div><ul id="allTablesTree" style="height:220px; width:100%; overflow:auto"></ul></div><div class="tablescenter"><input id="left2right" type="button" style="margin-top:120px;" value=">" title="选择"><br/><input type="button" id="right2left"  value="<" title="移除"></div><div class="tablesright"><div class="tabletitle">已选表</div><ul id="selTablesTree" class="easyui-tree" style="height:220px; width:100%; overflow:auto"></ul></div></div></div><div title="表关联"><div class="textpanel"><div style="float:right"><input type="button" id="jointable" value="关联"> <br/> <input type="button" id="unjointable" value="取消"></div><span class="inputtext">主表： </span><select id="mastertable" style="width:300px;"></select><br/><ul class="easyui-tree" id="masterTableTree" style="margin-left:90px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div></div>';$("#pdailog").dialog({title:"创建数据集",width:680,height:450,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},content:a,buttons:[{text:"确定",handler:function(){var g=$("#pdailog #datasetname").val();var f=$("#pdailog #dsid").val();if(g==""){msginfo("请填写数据集名称。");$("#crtdataset").tabs("select",0);$("#datasetname").focus();return}var q=$("#selTablesTree").tree("getChildren");if(q==null||q.length==0){msginfo("您还未选择目标表。");return}if(!pageInfo.dataset){pageInfo.dataset=[]}var r=findDatasourceById(f);var o={name:g,dsid:f,datasetid:newGuid()};o.master=$("#mastertable").val();var p=$("#masterTableTree").tree("getChildren");var h=[];for(c=0;c<p.length;c++){var l=p[c];if(l.iconCls=="icon-coljoin"){h.push({col:l.id,ref:l.attributes.ref,refKey:l.attributes.refKey,jtype:l.attributes.jtype,force:l.attributes.force})}}o.joininfo=h;pageInfo.dataset.push(o);var n=findDatasourceById(f);$.ajax({type:"post",async:false,url:"DataSet!queryDatasetMeta.action",dataType:"json",data:{ds:JSON.stringify(n),dataset:JSON.stringify(o)},success:function(u){o.cols=u;var t={id:o.datasetid,text:o.name,iconCls:"icon-dataset2",attributes:{drag:"n",showmenu:true,type:"dset"}};var s=initdatasetview(u,o.datasetid);t.children=s;$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='sjj']"),data:t})}});$("#l_tab").tabs("select",1);curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var e=function(g){var f=findDatasourceById(g);$.ajax({type:"post",url:"DataSet!queryTables.action",dataType:"json",data:{ds:JSON.stringify(f)},success:function(h){$("#allTablesTree").tree({data:h})}})};$("#pdailog #dsid").bind("change",function(){var f=$("#selTablesTree").tree("getChildren");for(c=0;c<f.length;c++){$("#selTablesTree").tree("remove",f[c].target)}$("#mastertable").html("");e($(this).val())});e($("#pdailog #dsid").val());$("#pdailog #left2right").bind("click",function(){var f=$("#allTablesTree").tree("getSelected");if(f==null||$(f.target).attr("hide")=="y"){msginfo("请先从左边选择表。");return}$("#selTablesTree").tree("append",{parent:null,data:[{id:f.id,text:f.text,iconCls:f.iconCls}]});$(f.target).attr("hide","y").hide();var h=document.getElementById("mastertable");var g=h.selectedIndex;h.options.add(new Option(f.id,f.text));if(g==-1){b(f.id)}});$("#pdailog #right2left").bind("click",function(){var h=$("#selTablesTree").tree("getSelected");if(h==null){msginfo("您还未选择需要移除的表。");return}var g=$("#allTablesTree").tree("getChildren");for(c=0;c<g.length;c++){if(g[c].id==h.id){$(g[c].target).attr("hide","n").show();break}}$("#selTablesTree").tree("remove",h.target);var n=document.getElementById("mastertable");var l=n.selectedIndex;var f=0;for(c=0;c<n.options.length;c++){if(n.options[c].value==h.id){f=c;break}}n.options.remove(f);if(l==f){b(n.options[n.selectedIndex].value)}});var b=function(f){$.ajax({type:"post",url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById($("#crtdataset #dsid").val())),querysql:"select * from "+f+" where 1=2"},success:function(g){var h=[];for(k=0;k<g.length;k++){h.push({id:g[k].name,text:g[k].name,iconCls:"icon-dscol",attributes:{}})}$("#masterTableTree").tree({data:h,onDblClick:function(l){jointableFunc()}})}})};$("#mastertable").bind("change",function(){b($(this).val())});$("#pdailog #jointable").bind("click",function(){jointableFunc()});$("#unjointable").bind("click",function(){var f=$("#masterTableTree").tree("getSelected");if(f==null){msginfo("您还未从主表字段中选择需要删除关联的字段。");return}delete f.attributes.ref;delete f.attributes.refKey;$("#masterTableTree").tree("update",{target:f.target,text:f.id,iconCls:"icon-dscol"})})}function initdatasetview(c,g){var h=[];var f=[];var d=function(p){var o=false;for(k=0;k<f.length;k++){if(f[k]==p){o=true;break}}return o};var l=function(p){var o=[];for(k=0;k<c.length;k++){if(c[k].tname==p){o.push(c[k])}}return o};for(j=0;j<c.length;j++){if(!d(c[j].tname)){f.push(c[j].tname)}}for(j=0;j<f.length;j++){var n=f[j];var e=l(f[j]);var b=[];h.push({id:n,text:n,iconCls:"icon-table",state:"closed",attributes:{showmenu:true,type:"dsetTable",datasetid:g},children:b});for(k=0;k<e.length;k++){var a=e[k];b.push({id:a.name,text:a.name,iconCls:"icon-dscol",attributes:{showmenu:true,drag:"n",vtype:a.type,tname:a.tname,datasetid:g,type:"dsetcol"}})}}return h}function jointableFunc(){var f=$("#masterTableTree").tree("getSelected");if(f==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var b="";var e=null;var d=$("#selTablesTree").tree("getChildren");for(i=0;i<d.length;i++){if(d[i].id!=$("#mastertable").val()){b=b+'<option value="'+d[i].id+'">'+d[i].text+"</option>";if(e==null){e=d[i].id}}}var c=function(g){var h="";if(e!=null){$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById($("#crtdataset #dsid").val())),querysql:"select * from "+g+" where 1=2"},success:function(l){for(k=0;k<l.length;k++){h=h+'<option value="'+l[k].name+'">'+l[k].name+"</option>"}}})}return h};var a='<div class="textpanel">主表 <b>'+$("#mastertable").val()+"</b> 字段 <b>"+f.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+b+'</select> 字段 <select id="slavetablecol"  style="width:100px;">'+c(e)+'</select> <br/>连接类型：<select id="jtype" style="width:110px;"><option value="all">全连接</option><option value="left">左连接</option><option value="right">右连接</option></select><br/>强制连接：<input type="checkbox" id="force" name="force" value="1"> <span style=\'color:#ccc\'>(勾选后，每次查询都会关联此表)</span></div>';$("#dsColumn_div").dialog({title:"关联维度表",width:360,height:250,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){f.attributes.ref=$("#dsColumn_div #slavetable").val();f.attributes.refKey=$("#dsColumn_div #slavetablecol").val();var g=$("#dsColumn_div #jtype").val();var h=$("input[name='force']:checkbox:checked").val();f.attributes.jtype=g;f.attributes.force=h?"y":"n";$("#masterTableTree").tree("update",{target:f.target,text:f.text+" -> "+f.attributes.ref+"."+f.attributes.refKey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var g=c($(this).val());$("#slavetablecol").html(g)})}function editdataset(dset_id){var id=dset_id?dset_id:curTmpInfo.id;var dset=findDatasetById(id);dset=eval("("+JSON.stringify(dset)+")");curTmpInfo.curDset=dset;var dsource=findDatasourceById(dset.dsid);$("#pdailog").dialog({title:"编辑数据集",width:800,height:470,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="datasettabs" ><div title="基本信息" ><div class="textpanel"><span class="inputtext">数据集名称：</span><input type="text" class="inputform" name="datasetname" id="datasetname" value="'+dset.name+'"><br/><span class="inputtext">连接数据源：</span><input type="text" class="inputform" value="'+(dsource.use=="jndi"?dsource.jndiname:dsource.dsname)+'" readOnly=true>(不能更改)<br/><span class="inputtext">已选分析表：</span><br/><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td width="70%" valign="top"><ul id="selectTables"></ul></td><td valign="top" align="right"><a id="addtable" href="#">添加表</a><br/><a id="deltable" href="#">删除表</a></td></tr></table></div></div><div title="表关联" ><div class="textpanel"><div style="float:right"><input type="button" value="关联" id="jointable"><br/><input type="button" value="删除" id="deljointable"></div><span class="inputtext">主表： </span><input type="text" class="inputform" value="'+dset.master+'" style="width:300px;"><input type="button" id="reloadcols" value="刷新字段"><br/><ul id="masterTableTree" style="margin-left:90px;border:1px solid #999; width:300px; height:320px; overflow:auto"></ul></div></div><div title="字段信息"></div><div title="动态字段"></div><div title="数据筛选"></div><div title="数据预览"></div></div>',onLoad:function(){},buttons:[{text:"确定",handler:function(){dset.name=$("#datasetname").val();if(dset.name==""){msginfo("请填数据集名称。");$("#datasetname").focus();return}for(i=0;i<dset.joininfo.length;i++){var o=dset.joininfo[i];if(o.col==""){msginfo("表 "+o.ref+" 还未和主表关联。");return}}for(var i=0;i<pageInfo.dataset.length;i++){var d=pageInfo.dataset[i];if(d.datasetid==dset.datasetid){pageInfo.dataset[i]=dset;break}}var pp=$("#mydatatree").tree("getSelected");var ls=$("#mydatatree").tree("getChildren",pp.target);for(var i=0;i<ls.length;i++){$("#mydatatree").tree("remove",ls[i].target)}var ncols=[];for(var j=0;j<dset.cols.length;j++){var o=dset.cols;ncols=initdatasetview(o,dset.datasetid)}$("#mydatatree").tree("append",{parent:pp.target,data:ncols});$("#mydatatree").tree("update",{target:pp.target,text:dset.name});curTmpInfo.isupdate=true;delete curTmpInfo.curDset;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){delete curTmpInfo.curDset;$("#pdailog").dialog("close")}}]});var stbs=[];stbs.push({id:dset.master,text:dset.master+" (主表)",iconCls:"icon-table"});for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){stbs.push({id:dset.joininfo[i].ref,text:dset.joininfo[i].ref,iconCls:"icon-table"})}$("#selectTables").tree({data:stbs});$("#pdailog #addtable").linkbutton({iconCls:"icon-add",plain:true}).bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var ds=findDatasourceById(dset.dsid);var ctx='<ul id="selectTablesTree"></ul>';$("#dsColumn_div").dialog({title:"添加表",width:350,height:280,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var nd=$("#dsColumn_div #selectTablesTree").tree("getSelected");if(nd==null){msginfo("请选择表。");return}var tname=nd.id;if(tname==dset.master){msginfo("您选择的表已经存在。");return}var exist=false;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){exist=true;break}}if(exist){msginfo("您选择的表已经存在。");return}dset.joininfo.push({col:"",ref:tname,refKey:""});$("#pdailog #selectTables").tree("append",{parent:null,data:{id:tname,text:tname,iconCls:"icon-table"}});$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById(dset.dsid)),querysql:"select * from "+tname+" where 1=2"},success:function(dt){for(k=0;k<dt.length;k++){dt[k].tname=tname;dset.cols.push(dt[k])}}});curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$.ajax({type:"post",url:"DataSet!queryTables.action",dataType:"json",data:{ds:JSON.stringify(ds)},success:function(dt){$("#selectTablesTree").tree({data:dt})}})});$("#pdailog #deltable").linkbutton({iconCls:"icon-edit",plain:true}).bind("click",function(){var node=$("#pdailog #selectTables").tree("getSelected");if(node==null){msginfo("请选择表。");return}var tname=node.id;if(tname==dset.master){msginfo("不能删除主表");return}var cubes=pageInfo.cube;var use=false;for(i=0;cubes&&i<cubes.length;i++){var cube=cubes[i];if(cube.datasetid!=dset.datasetid){continue}for(j=0;j<cube.dim.length;j++){var d=cube.dim[j];if(d.tp=="group"){var ls=d.children;for(k=0;k<ls.length;k++){if(ls[k].tname==tname||ls[k].codetable==tname){use=true;break}}}else{if(d.tname==tname||d.codetable==tname){use=true;break}}}}if(use){msginfo("您要删除的表已在立方体中使用，不能删除.");return}if(confirm("是否确认删除？")){var idx=-1;for(i=0;dset.joininfo&&i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==tname){idx=i}}if(dset.joininfo){dset.joininfo.splice(idx,1)}var ncols=[];for(i=0;i<dset.cols.length;i++){var c=dset.cols[i];if(c.tname!=tname){ncols.push(c)}}dset.cols=ncols;$("#pdailog #selectTables").tree("remove",node.target)}});$("#pdailog #deljointable").click(function(){var node=$("#masterTableTree").tree("getSelected");var joininfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==node.attributes.ref){joininfo=dset.joininfo[i];break}}if(joininfo!=null){joininfo.col="";joininfo.refKey="";$("#masterTableTree").tree("update",{target:node.target,text:node.id,iconCls:"icon-dscol"})}});$("#pdailog #reloadcols").click(function(){showloading();$.ajax({type:"post",url:"DataSet!queryDatasetMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById(dset.dsid)),dataset:JSON.stringify(dset)},success:function(dt){hideLoading();dset.cols=dt;loadMasterCols()},error:function(resp){hideLoading()}})});$("#pdailog #jointable").click(function(){var node=$("#masterTableTree").tree("getSelected");if(node==null){msginfo("您还未从主表字段中选择需要关联的字段。");return}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div"></div>').appendTo("body")}var tbs="";var tname=null;var cld=dset.joininfo;for(i=0;i<cld.length;i++){if(cld[i].col==""||cld[i].col==node.id){tbs=tbs+'<option value="'+cld[i].ref+'" '+(cld[i].col==node.id?"selected":"")+">"+cld[i].ref+"</option>"}}var jinfo=null;for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].col==node.id){jinfo=dset.joininfo[i];break}}var getSlaveColumns=function(tn){if(!tn||tn==null){return""}var slavecols="";$.ajax({type:"post",async:false,url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(findDatasourceById(dset.dsid)),querysql:"select * from "+tn+" where 1=2"},success:function(dt){for(k=0;k<dt.length;k++){slavecols=slavecols+'<option value="'+dt[k].name+'" '+(jinfo!=null&&jinfo.refKey==dt[k].name?"selected":"")+">"+dt[k].name+"</option>"}}});return slavecols};var ctx='<div class="textpanel">主表 <b>'+dset.master+"</b> 字段 <b>"+node.id+'</b> <br/> &nbsp; &nbsp; &nbsp; =>关联到=> <br/> 从表 <select id="slavetable" style="width:150px;">'+tbs+'</select> 字段 <select id="slavetablecol"  style="width:100px;"></select><br/>连接类型：<select id="jtype" style="width:110px;"><option value="all" '+(jinfo!=null&&jinfo.jtype=="all"?"selected":"")+'>全连接</option><option value="left" '+(jinfo!=null&&jinfo.jtype=="left"?"selected":"")+'>左连接</option><option value="right" '+(jinfo!=null&&jinfo.jtype=="right"?"selected":"")+'>右连接</option></select><br/>强制连接：<input type="checkbox" id="force" name="force" value="1" '+(jinfo!=null&&jinfo.force=="y"?"checked":"")+"> <span style='color:#ccc'>(勾选后，每次查询都会关联此表)</span></div>";$("#dsColumn_div").dialog({title:"关联维度表",width:360,height:250,closed:false,cache:false,modal:true,toolbar:null,content:ctx,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var ref=$("#dsColumn_div #slavetable").val();var refkey=$("#dsColumn_div #slavetablecol").val();var jtype=$("#dsColumn_div #jtype").val();var force=$("input[name='force']:checkbox:checked").val();if(!ref||ref==null||ref==""){msginfo("请选择关联表。");return}if(jinfo==null){for(i=0;i<dset.joininfo.length;i++){if(dset.joininfo[i].ref==ref){jinfo=dset.joininfo[i];break}}}jinfo.col=node.id;jinfo.refKey=refkey;jinfo.jtype=jtype;jinfo.force=force?"y":"n";$("#masterTableTree").tree("update",{target:node.target,text:node.id+" -> "+ref+"."+refkey,iconCls:"icon-coljoin"});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#slavetable").bind("change",function(){var s=getSlaveColumns($(this).val());$("#slavetablecol").html(s)});var s=getSlaveColumns($("#slavetable").val());$("#slavetablecol").html(s)});var loadMasterCols=function(){var isJoin=function(col){var ret=null;for(j=0;dset.joininfo&&j<dset.joininfo.length;j++){if(dset.joininfo[j].col==col){ret=dset.joininfo[j];break}}return ret};var mcols=[];for(i=0;i<dset.cols.length;i++){if(dset.cols[i].tname==dset.master){var r=isJoin(dset.cols[i].name);if(r==null){mcols.push({id:dset.cols[i].name,text:dset.cols[i].name,iconCls:"icon-dscol",attributes:{ref:""}})}else{mcols.push({id:dset.cols[i].name,text:dset.cols[i].name+" -> "+r.ref+"."+r.refKey,iconCls:"icon-coljoin",attributes:{ref:r.ref}})}}}$("#masterTableTree").tree({data:mcols})};$("#datasettabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onLoad:function(){},onSelect:function(a,b){if(b==1){loadMasterCols()}if(b==2){var pp=$("#datasettabs").tabs("getSelected");var str='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';str=str+"<tr><th width='20%'>字段名</th><th width='17%'>显示名</th><th width='17%'>类型</th><th width='30%'>来源表</th><th width='15%'>操作</th></tr>";for(var i=0;i<dset.cols.length;i++){m=dset.cols[i];str=str+"<tr><td class='kpiData1 grid3-td'>"+m.name+"</td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_disp">'+(m.dispName==""?"&nbsp;":m.dispName)+"</div></td><td class='kpiData1 grid3-td'><div id=\""+m.tname+"_"+m.name+'_tp">'+m.type+"</div></td><td class='kpiData1 grid3-td'>"+m.tname+"</td><td class='kpiData1 grid3-td'><a href=\"javascript:;\" onclick=\"editDsColumn('"+m.name+"', null, '"+m.tname+"', 'panel')\">编辑</a></td></tr>"}str=str+"</table>";$(pp).html(str)}if(b==3){reloadDynamicCol(dset)}if(b==4){reloadDatasetFilter(dset)}if(b==5){var pp=$("#datasettabs").tabs("getSelected");$(pp).html("加载中...");$(pp).load("DataSet!queryData.action",{ds:JSON.stringify(dsource),dataset:JSON.stringify(dset)},function(a,b,c){if(b=="error"){$(pp).html("SQL执行出错...")}})}}})}function reloadDatasetFilter(c){var d='<a href="javascript:newdatasetparam(false);" style="margin:3px;" id="ndatasetparam">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';d=d+"<tr><th>筛选字段</th><th>判断条件</th><th>筛选值</th><th>值类型</th><th>操作</th></tr>";for(var b=0;c.param&&b<c.param.length;b++){d=d+'<tr><td class="kpiData1 grid3-td">'+c.param[b].col+'</td><td class="kpiData1 grid3-td">'+c.param[b].type+'</td><td class="kpiData1 grid3-td">'+(c.param[b].val+(c.param[b].val2==""?"":"/"+c.param[b].val2))+'</td><td class="kpiData1 grid3-td">'+c.param[b].valuetype+'</td><td class="kpiData1 grid3-td"><a href="javascript:newdatasetparam(true,\''+c.param[b].id+"');\">编辑</a> <a href=\"javascript:delDatasetFilter('"+c.param[b].id+"');\">删除</a></td></tr>"}if(!c.param||c.param.length==0){d=d+'<tr><td class="kpiData1 grid3-td" align="center" colspan="5">无数据.</td></tr>'}d=d+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(d);$("#datasettabs #ndatasetparam").linkbutton({iconCls:"icon-add"})}function reloadDynamicCol(d){var f='<a href="javascript:;" style="margin:3px;" id="dynamiccol">新增</a><table class="grid3" id="T_report54" cellpadding="0" cellspacing="0">';f=f+'<tr><th width="15%">字段名</th><th width="15%">显示名</th><th width="40%">表达式</th><th width="15%">值类型</th><th width="15%">操作</th></tr>';for(var c=0;d.dynamic&&c<d.dynamic.length;c++){var e=d.dynamic[c];f=f+'<tr><td class="kpiData1 grid3-td">'+e.name+'</td><td class="kpiData1 grid3-td">'+e.dispName+'</td><td class="kpiData1 grid3-td">'+e.expression.replace(/@/g,"'")+'</td><td class="kpiData1 grid3-td">'+e.type+'</td><td class="kpiData1 grid3-td"><a href="javascript:;" col="'+e.name+'" id="dynamiccolupdate">编辑</a> <a href="javascript:;" col="'+e.name+'" id="dynamiccoldel">删除</a></td></tr>'}if(!d.dynamic||d.dynamic.length==0){f=f+'<tr><td class="kpiData1 grid3-td" align="center" colspan="5">无数据.</td></tr>'}f=f+"</table>";var a=$("#datasettabs").tabs("getSelected");$(a).html(f);var b=function(h){var n="";for(var l=0;l<dataType.length;l++){n=n+'<option value="'+dataType[l]+'" '+(h&&h.type==dataType[l]?"selected":"")+">"+dataType[l]+"</option>"}var g='<div class="textpanel"><span class="inputtext">字段名：</span><input type="text" id="colname" name="colname" class="inputform" value="'+(h?h.name:"")+'">(添加后不能更改)<br/><span class="inputtext">显示名：</span><input type="text" id="dispname" name="dispname" class="inputform" value="'+(h?h.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea name="expression" id="expression" cols="40" style="height:52px;">'+(h?h.expression.replace(/@/g,"'"):"")+'</textarea></td></tr></tbody></table><span class="inputtext">值类型：</span><select id="valtype" class="inputform">'+n+"</select></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:h?"编辑动态字段":"添加动态字段",width:380,height:260,closed:false,cache:false,modal:true,toolbar:null,content:g,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(h){h.dispName=$("#dsColumn_div #dispname").val();h.name=$("#dsColumn_div #colname").val();h.type=$("#dsColumn_div #valtype").val();h.expression=$("#dsColumn_div #expression").val().replace(/'/g,"@")}else{var o={dispName:$("#dsColumn_div #dispname").val(),name:$("#dsColumn_div #colname").val(),tname:d.master,type:$("#dsColumn_div #valtype").val(),expression:$("#dsColumn_div #expression").val().replace(/'/g,"@")};if(!d.dynamic){d.dynamic=[]}d.dynamic.push(o)}$("#dsColumn_div").dialog("close");reloadDynamicCol(d)}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})};$("#datasettabs #dynamiccoldel").bind("click",function(){if(!confirm("是否确认删除？")){return}var g=-1;var h=$(this).attr("col");for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==h){g=c;break}}d.dynamic.splice(g,1);reloadDynamicCol(d)});$("#datasettabs #dynamiccolupdate").bind("click",function(){var g=$(this).attr("col");var h=null;for(c=0;c<d.dynamic.length;c++){if(d.dynamic[c].name==g){h=d.dynamic[c];break}}b(h)});$("#datasettabs #dynamiccol").bind("click",function(){b()}).linkbutton({iconCls:"icon-add"})}function delDatasetFilter(b){if(confirm("是否确认删除？")){var c=curTmpInfo.curDset;var a=-1;for(i=0;i<c.param.length;i++){if(c.param[i].id==b){a=i}}c.param.splice(a,1);reloadDatasetFilter(c)}}function newdatasetparam(h,c){var e=curTmpInfo.curDset;var d=null;if(e.param){for(i=0;i<e.param.length;i++){if(e.param[i].id==c){d=e.param[i]}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var g='<select id="filtercolumn" name="filtercolumn" class="inputform">';for(i=0;i<e.cols.length;i++){if(e.cols[i].tname!=e.master){continue}g=g+"<option value='"+e.cols[i].name+"@"+e.cols[i].tname+"' "+(d!=null&&d.col==e.cols[i].name&&d.tname==e.cols[i].tname?"selected":"")+">"+(e.cols[i].dispName==""?e.cols[i].name:e.cols[i].dispName)+"</option>"}g=g+"</select>";var b=["=",">",">=","<","<=","!=","between"];var f='<select id="filtertype" name="filtertype" class="inputform">';for(i=0;i<b.length;i++){f=f+'<option value="'+b[i]+'" '+(d!=null&&d.type==b[i]?"selected":"")+">"+b[i]+"</option>"}f=f+"</select>";var a='<div class="textpanel"><span class="inputtext">筛选字段：</span>'+g+'<br/><span class="inputtext">判断条件：</span>'+f+'<br/><span class="inputtext">筛选值：</span><input type="text" name="filtervalue" id="filtervalue" value="'+(d!=null?d.val:"")+'" class="inputform"><br><div style="'+(d!=null&&d.val2!=""?"":"display:none")+'"><span class="inputtext">筛选值2：</span><input type="text" name="filtervalue2" id="filtervalue2" value="'+(d!=null?d.val2:"")+'"  class="inputform"></div><span class="inputtext">筛选值类型：</span><select name="valuetype" id="valuetype" class="inputform"><option value="number" '+(d!=null&&d.valuetype=="number"?"selected":"")+'>数字类型</option><option value="string" '+(d!=null&&d.valuetype=="string"?"selected":"")+'>字符类型</option><option value="datetime" '+((d!=null&&d.valuetype=="datetime"?"selected":""))+">日期类型</option></select></div>";$("#dsColumn_div").dialog({title:(h==false?"添加筛选条件":"编辑筛选条件"),width:380,height:260,closed:false,cache:false,modal:true,toolbar:null,content:a,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(!e.param){e.param=[]}if($("#dsColumn_div #filterid").val()==""){msginfo("筛选标识是必填项！");$("#dsColumn_div #filterid").focus();return}if(h==true){var l=$("#dsColumn_div #filtercolumn").val().split("@");d.col=l[0];d.tname=l[1];d.type=$("#dsColumn_div #filtertype").val();d.val=$("#dsColumn_div #filtervalue").val();d.val2=$("#dsColumn_div #filtervalue2").val();d.valuetype=$("#dsColumn_div #valuetype").val()}else{var l=$("#dsColumn_div #filtercolumn").val().split("@");e.param.push({id:newGuid(),col:l[0],tname:l[1],type:$("#dsColumn_div #filtertype").val(),val:$("#dsColumn_div #filtervalue").val(),val2:$("#dsColumn_div #filtervalue2").val(),valuetype:$("#dsColumn_div #valuetype").val()})}reloadDatasetFilter(e);$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div #filtertype").bind("change",function(){if($(this).val()=="between"){$("#dsColumn_div #filtervalue2").parent().css("display","block")}else{$("#dsColumn_div #filtervalue2").parent().css("display","none")}})}function editDsColumn(a,d,n,g){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var h;if(d==null){h=curTmpInfo.curDset}else{h=findDatasetById(d)}var e=null;for(var f=0;f<h.cols.length;f++){if(h.cols[f].name==a&&h.cols[f].tname==n){e=h.cols[f];break}}var b="";for(var f=0;f<dataType.length;f++){b=b+'<option value="'+dataType[f]+'" '+(e.type==dataType[f]?"selected":"")+">"+dataType[f]+"</option>"}var c=null;for(j=0;h.joininfo&&j<h.joininfo.length;j++){if(h.master==e.tname&&h.joininfo[j].col==e.name){c=h.joininfo[j];break}else{if(e.tname==h.joininfo[j].ref&&e.name==h.joininfo[j].refKey){c=h.joininfo[j];break}}}var l='<div class="textpanel"><span class="inputtext">字段名：</span>'+e.name+'<br/><span class="inputtext">显示名：</span><input type="text" name="coldispname" id="coldispname" value="'+e.dispName+'" class="inputform"><br/><span class="inputtext">类型：</span><select id="coltype" class="inputform">'+b+'</select><br/><span class="inputtext">来源表：</span>'+e.tname+'<br/><span class="inputtext">字段关联：</span>'+(c==null?"字段无关联":h.master+"."+c.col+" -> "+c.ref+"."+c.refKey)+(c!=null?'<br/><span class="inputtext">关联类型：</span>'+(c.jtype=="all"?"全连接":(c.jtype=="left"?"左连接":"右连接")):"")+(c==null?"":'<br/><span class="inputtext">强制连接：</span>'+(c.force=="y"?"是":"否"))+"</div>";$("#dsColumn_div").dialog({title:"编辑字段信息",width:c==null?350:450,height:c==null?240:300,closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){e.dispName=$("#dsColumn_div #coldispname").val();e.type=$("#dsColumn_div #coltype").val();curTmpInfo.isupdate=true;if(g=="panel"){$("#datasettabs #"+e.tname+"_"+e.name+"_disp").text(e.dispName);$("#datasettabs #"+e.tname+"_"+e.name+"_tp").text(e.type)}else{if(g=="col"){var o=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:o.target,text:(e.dispName==""?e.name:e.dispName)})}}curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})}function newcube(c,b){if(!pageInfo.dataset){msginfo("创建立方体前，请先创建数据集！");return}var a=null;if(b){a=fundCubeById(b)}$("#pdailog").dialog({title:c==true?"编辑立方体":"创建立方体",width:700,height:500,closed:false,cache:false,modal:true,toolbar:null,content:'<div id="cubetabs" ><div title="数据集" ></div><div title="维度和度量"></div>'+(a!=null?'<div title="聚集"></div><div title="分表"></div><div title="缓存"></div><div title="定时任务"></div>':"")+"</div>",onLoad:function(){},buttons:[{text:"确定",handler:function(){if($("#pdailog #cubename").val()==""){msginfo("您还未录入立方体名称。");return}if(!pageInfo.cube){pageInfo.cube=[]}if(c){a.datasetid=$("#pdailog #datasetid").val();a.name=$("#pdailog #cubename").val();a.note=$("#pdailog #note").val();a.cache="true"==$("input[name='cache']:radio:checked").val();var e=$("#pdailog input[name='autoAggre']:radio:checked").val();if(e=="yes"){if(!pageInfo.id){msginfo("请先保存报表。");return}var h=$("#pdailog #hour").val();var v=$("#pdailog #minute").val();var z=$("#pdailog #week").val();var B=$("#pdailog #day").val();var D=$("#pdailog #period").val();a.job={period:D,hour:h,minute:v,week:z,day:B};$.ajax({type:"POST",url:"Job!startJob.action",data:{fileId:pageInfo.id,cubeId:a.id,job:JSON.stringify(a.job)},dataType:"HTML",success:function(){}})}else{if(e=="no"){delete a.job;$.ajax({type:"POST",url:"Job!stopJob.action",data:{fileId:pageInfo.id,cubeId:a.id},dataType:"HTML",success:function(){},error:function(){}})}}var y=$("#cuberighttree").tree("getRoot");var A=$("#mydatatree").tree("getSelected");$("#mydatatree").tree("update",{target:A.target,text:a.name});var q=$("#pdailog input[name='division']:radio:checked").val();if("y"==q){var u=$("#pdailog #divisonCol").val();var F=$("#pdailog #divisonNumber").val();a.divison={col:u,number:F,tabs:[]};var n=$("#pdailog input[name='divisonEND']");$("#pdailog input[name='divisonST']").each(function(o,t){var H=$(this).val();a.divison.tabs.push({idx:o,st:H,end:n.get(o).value})})}else{if("n"==q){delete a.divison}}if(y!=null){a.dim=[];a.kpi=[];var d=$("#mydatatree").tree("getChildren",A.target);for(var C=0;C<d.length;C++){$("#mydatatree").tree("remove",d[C].target)}var G=[];var l=$("#cuberighttree").tree("getChildren",y.target);var r=null;var E=null;for(C=0;C<l.length;C++){var s=l[C];if(s.attributes&&(s.attributes.tp=="dim"||s.attributes.tp=="group")){if(r!=null){var p=$("#cuberighttree").tree("getParent",s.target);if(!p.attributes||p.attributes.tp!="group"){r=null;E=null}}if(s.attributes.tp=="group"){var w={id:s.id,name:s.attributes.dispName,grouptype:s.attributes.grouptype,tp:"group",children:[]};a.dim.push(w);E=w.children}else{var g=E==null?a.dim:E;g.push({id:s.id,name:s.attributes.dispName,tp:"dim",col:s.attributes.col,tname:s.attributes.tname,codetable:(s.attributes.codetable?s.attributes.codetable:""),keycol:(s.attributes.keycol?s.attributes.keycol:""),valcol:(s.attributes.valcol?s.attributes.valcol:""),vtype:s.attributes.vtype,refId:s.attributes.refId,dimtype:(s.attributes.dimtype?s.attributes.dimtype:""),dyna:(s.attributes.dyna?s.attributes.dyna:false),dateformat:s.attributes.dateformat})}if(s.attributes.tp=="group"){var w={id:s.id,text:s.text,iconCls:"icon-group",attributes:{col_type:"group",showmenu:true,drag:"n",type:"group",cubeId:a.id},children:[]};G.push(w);r=w.children}else{var g=r==null?G:r;g.push({id:s.id,text:s.text,iconCls:"icon-dim",attributes:{col_type:"dim",showmenu:true,drag:"n",type:"dim",cubeId:a.id}})}}else{if(s.attributes&&s.attributes.tp=="kpi"){a.kpi.push({id:s.id,name:s.attributes.dispName,col:s.attributes.col,tname:s.attributes.tname,fmt:(s.attributes.fmt?s.attributes.fmt:""),unit:(s.attributes.unit?s.attributes.unit:""),aggre:(s.attributes.aggre?s.attributes.aggre:""),kpinote:(s.attributes.kpinote?s.attributes.kpinote:""),calc:(s.attributes.calc?s.attributes.calc:false),dimtype:(s.attributes.dimtype?s.attributes.dimtype:""),dyna:(s.attributes.dyna?s.attributes.dyna:false)});G.push({id:s.id,text:s.text,iconCls:(s.attributes.calc?"icon-ckpi":"icon-kpi"),attributes:{col_type:"kpi",showmenu:true,drag:"n",type:"kpi",cubeId:a.id}})}}}$("#mydatatree").tree("append",{parent:A.target,data:G})}}else{var y=$("#cuberighttree").tree("getRoot");if(y==null){msginfo("您还未设置立方体的维和度量。");return}var x={id:newGuid(),dim:[],kpi:[],datasetid:$("#pdailog #datasetid").val(),name:$("#pdailog #cubename").val(),note:$("#pdailog #note").val()};var f=[];var l=$("#cuberighttree").tree("getChildren",y.target);var r=null;var E=null;for(C=0;C<l.length;C++){var s=l[C];if(s.attributes&&(s.attributes.tp=="dim"||s.attributes.tp=="group")){if(r!=null){var p=$("#cuberighttree").tree("getParent",s.target);if(!p.attributes||p.attributes.tp!="group"){r=null;E=null}}if(s.attributes.tp=="group"){var w={id:s.id,name:s.attributes.dispName,grouptype:s.attributes.grouptype,tp:"group",children:[]};x.dim.push(w);E=w.children}else{var g=E==null?x.dim:E;g.push({id:s.id,name:s.attributes.dispName,tp:"dim",col:s.attributes.col,tname:s.attributes.tname,codetable:(s.attributes.codetable?s.attributes.codetable:""),keycol:(s.attributes.keycol?s.attributes.keycol:""),valcol:(s.attributes.valcol?s.attributes.valcol:""),vtype:s.attributes.vtype,refId:s.attributes.refId,dimtype:(s.attributes.dimtype?s.attributes.dimtype:""),dyna:s.attributes.dyna,dateformat:s.attributes.dateformat})}if(s.attributes.tp=="group"){var w={id:s.id,text:s.text,iconCls:"icon-group",attributes:{col_type:"group",showmenu:true,drag:"n",type:"group",cubeId:x.id},children:[]};f.push(w);r=w.children}else{var g=r==null?f:r;g.push({id:s.id,text:s.text,iconCls:"icon-dim",attributes:{col_type:"dim",showmenu:true,drag:"n",type:"dim",cubeId:x.id}})}}else{if(s.attributes&&s.attributes.tp=="kpi"){x.kpi.push({id:s.id,name:s.attributes.dispName,col:s.attributes.col,tname:s.attributes.tname,fmt:s.attributes.fmt,unit:s.attributes.unit,aggre:s.attributes.aggre,kpinote:s.attributes.kpinote,calc:(s.attributes.calc?s.attributes.calc:false),dyna:s.attributes.dyna});f.push({id:s.id,text:s.text,iconCls:(s.attributes.calc?"icon-ckpi":"icon-kpi"),attributes:{col_type:"kpi",showmenu:true,drag:"n",type:"kpi",cubeId:x.id}})}}}$("#mydatatree").tree("append",{parent:$("#mydatatree div[node-id='lft']"),data:[{id:x.id,text:x.name,iconCls:"icon-cube",attributes:{showmenu:true,type:"cube"},children:f}]});pageInfo.cube.push(x);$("#l_tab").tabs("select",1)}initselectDataTree();curTmpInfo.isupdate=true;$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#cubetabs").tabs({border:false,fit:true,tabPosition:"left",plain:false,onSelect:function(C,A){var w='<div class="textpanel" style="">';if(A==0){var x=$("#cubetabs").tabs("getSelected");if($(x).html()!=""){return}var z="";for(i=0;i<pageInfo.dataset.length;i++){var q=pageInfo.dataset[i];if(c){z=z+(a!=null&&a.datasetid==q.datasetid?'<option value="'+q.datasetid+'">'+q.name+"</option>":"")}else{z=z+'<option value="'+q.datasetid+'" '+(a!=null&&a.datasetid==q.datasetid?"selected":"")+">"+q.name+"</option>"}}w=w+'<span class="inputtext">立方体名称：</span><input type="text" class="inputform" name="cubename" id="cubename" value="'+(a==null?"":a.name)+'"><br>';w=w+'<span class="inputtext">数据集：</span><select class="inputform" id="datasetid" name="datasetid">'+z+"</select>"+(c?"(不可更改)":"");w=w+'<br/><table cellspacing="0" cellpadding="0"><tr><td valign="top"><span class="inputtext">备注信息：</span></td><td><textarea rows="4" cols="35" id="note" name="note">'+(a!=null&&a.note?a.note:"")+'</textarea></td></tr></table><br/><font color="#999">(创建好立方体后，即可对立方体进行多维分析。)</font>';w=w+"</div>";$(x).html(w)}else{if(a!=null&&A==3){var x=$("#cubetabs").tabs("getSelected");var w="开源版无此功能。";$(x).html(w)}else{if(a!=null&&A==4){var x=$("#cubetabs").tabs("getSelected");var w="开源版无此功能。";$(x).html(w)}else{if(a!=null&&A==5){var x=$("#cubetabs").tabs("getSelected");var w="开源版无此功能。";$(x).html(w)}else{if(a!=null&&A==2){var x=$("#cubetabs").tabs("getSelected");var w="开源版无此功能。";$(x).html(w)}else{if(A==1){var y="";var l=findDatasetById($("#cubetabs #datasetid").val());var n=l.cols;y=y+"<li data-options=\"iconCls:'icon-table'\"><span>"+l.master+"</span><ul>";for(i=0;i<n.length;i++){if(n[i].tname==l.master){y=y+"<li data-options=\"id:'"+n[i].name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+n[i].tname+"', vtype:'"+n[i].type+"', col:'"+n[i].name+"', dyna:false}\"><span>"+(n[i].dispName==""?n[i].name:n[i].dispName)+"</span></li>"}}y=y+"</ul></li>";var f=function(t){var o=[];for(k=0;k<n.length;k++){if(n[k].tname==t){o.push(n[k])}}return o};for(i=0;l.joininfo&&i<l.joininfo.length;i++){y=y+"<li data-options=\"iconCls:'icon-table'\"><span>"+l.joininfo[i].ref+"</span><ul>";var g=f(l.joininfo[i].ref);for(j=0;j<g.length;j++){var u=g[j];y=y+"<li data-options=\"id:'"+u.name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+u.tname+"', vtype:'"+u.type+"', col:'"+u.name+"', dyna:false}\"><span>"+(u.dispName==""?u.name:u.dispName)+"</span></li>"}y=y+"</ul></li>"}y=y+"<li data-options=\"iconCls:'icon-table'\"><span>动态字段</span><ul>";for(i=0;l.dynamic&&i<l.dynamic.length;i++){var p=l.dynamic[i];y=y+"<li data-options=\"id:'"+p.name+"',iconCls:'icon-dscol',attributes:{tp:'node', tname:'"+p.tname+"', vtype:'"+p.type+"', col:'"+(p.expression)+"', dyna:true}\"><span>"+p.name+"</span></li>"}y=y+"</ul></li>";var s="";if(a!=null){s=s+"<ul>";for(i=0;i<a.dim.length;i++){if(a.dim[i].tp=="dim"){s=s+"<li data-options=\"id:'"+a.dim[i].id+"',iconCls:'icon-dim',attributes:{tp:'dim',drag:true,col:'"+a.dim[i].col+"',dispName:'"+a.dim[i].name+"',tname:'"+a.dim[i].tname+"',codetable:'"+a.dim[i].codetable+"',keycol:'"+a.dim[i].keycol+"',valcol:'"+a.dim[i].valcol+"',vtype:'"+a.dim[i].vtype+"',refId:'"+a.dim[i].refId+"',dyna:"+a.dim[i].dyna+",dimtype:'"+a.dim[i].dimtype+"',dateformat:'"+(a.dim[i].dimtype?a.dim[i].dimtype:"")+"'}\"><span>"+a.dim[i].name+"</span></li>"}else{if(a.dim[i].tp=="group"){s=s+"<li data-options=\"id:'"+a.dim[i].id+"',iconCls:'icon-group',attributes:{tp:'group',dispName:'"+a.dim[i].name+"',drag:true, grouptype:'"+a.dim[i].grouptype+"'}\">";s=s+"<span>"+a.dim[i].name+"</span>";s=s+"<ul>";for(k=0;k<a.dim[i].children.length;k++){var d=a.dim[i].children[k];s=s+"<li data-options=\"id:'"+d.id+"',iconCls:'icon-dim',attributes:{tp:'dim',drag:true,col:'"+d.col+"',dispName:'"+d.name+"',tname:'"+d.tname+"',codetable:'"+d.codetable+"',keycol:'"+d.keycol+"',valcol:'"+d.valcol+"',vtype:'"+d.vtype+"',refId:'"+d.refId+"',dyna:"+d.dyna+",dimtype:'"+d.dimtype+"',dateformat:'"+(d.dateformat?d.dateformat:"")+"'}\"><span>"+d.name+"</span></li>"}s=s+"</ul>";s=s+"</li>"}}}s=s+"</ul>"}var e="";if(a!=null){e=e+"<ul>";for(i=0;i<a.kpi.length;i++){e=e+"<li data-options=\"id:'"+a.kpi[i].id+"',iconCls:'"+(a.kpi[i].calc?"icon-ckpi":"icon-kpi")+"',attributes:{tp:'kpi',drag:true,col:'"+(a.kpi[i].col)+"',dispName:'"+a.kpi[i].name+"',tname:'"+(a.kpi[i].tname)+"',unit:'"+(a.kpi[i].unit?a.kpi[i].unit:"")+"',fmt:'"+(a.kpi[i].fmt?a.kpi[i].fmt:"")+"',aggre:'"+(a.kpi[i].aggre?a.kpi[i].aggre:"")+"',calc:"+(a.kpi[i].calc==true?"true":"false")+",kpinote:'"+(a.kpi[i].kpinote?a.kpi[i].kpinote:"")+"',dyna:"+a.kpi[i].dyna+'}"><span>'+a.kpi[i].aggre+"("+a.kpi[i].name+")</span></li>"}e=e+"</ul>"}var B="<ul id=\"cuberighttree\"><li data-options=\"iconCls:'icon-cube'\"><span>数据立方体</span><ul><li data-options=\"iconCls:'icon-dim',id:'cubewd'\"><span>维度</span>"+s+"</li><li data-options=\"iconCls:'icon-kpi',id:'cubedl'\"><span>度量</span>"+e+"</li></ul></li></ul>";w=w+'<div class="cubeleft"><div class="cubetitle">待选数据字段：</div><ul id="cubelefttree"><li data-options="iconCls:\'icon-dataset2\',attributes:{tp:\'root\'}"><span>'+l.name+"</span><ul>"+y+'</ul></li></ul></div><div class="cubecenter"><p style="height:150px;"></p><input type="button" onclick="ds2cube()" value=">" title="选择"><br><input type="button" title="移除" value="<" onclick="cube2ds()"></div><div class="cuberight"><div class="cubetitle">维度和度量：</div>'+B+'</div><div style="width:60px;" class="cubecenter"><a href="javascript:;" id="crtdimgroup" data-options="plain:true,iconCls:\'icon-add\'">分组</a><a href="javascript:editCalcKpi(false);" id="crtcalckpi" data-options="plain:true,iconCls:\'icon-add\'">度量</a><a href="javascript:editcubecol(\''+l.datasetid+'\');" id="dim_editbtn" data-options="plain:true,iconCls:\'icon-edit\'">编辑</a><a href="javascript:cube2ds();" id="dim_delbtn" data-options="plain:true,iconCls:\'icon-cancel\'">删除</a></div>';w=w+"</div>";var x=$("#cubetabs").tabs("getSelected");$(x).html(w);$("#dim_editbtn,#dim_delbtn,#crtdimgroup,#crtcalckpi").linkbutton();$("#crtdimgroup").bind("click",function(){if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var o='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" value="" id="groupname" name="groupname" class="inputform"><br/><span class="inputtext">分组类型：</span><select id="grouptype" name="grouptype" class="inputform"><option value=""></option><option value="date">时间</option></select></div>';$("#dsColumn_div").dialog({title:"创建维度分组",width:300,height:150,closed:false,cache:false,modal:true,toolbar:null,content:o,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var t=$("#dsColumn_div #groupname").val();var D=$("#dsColumn_div #grouptype").val();if(t==""){msginfo("请填写分组名称！");$("#dsColumn_div #groupname").focus();return}var F=findCubeMaxId($("#cuberighttree  div[node-id='cubewd']"));var E={id:F,text:t,iconCls:"icon-group",attributes:{tp:"group",dispName:t,drag:true,grouptype:D}};$("#cuberighttree").tree("append",{parent:$("#cuberighttree div[node-id='cubewd']"),data:[E]});$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]})});$("#cubelefttree").tree({dnd:false,onBeforeDrag:function(o){if(o.attributes==undefined){return false}return true},onDragEnter:function(t,o){return false}});$("#cuberighttree").tree({dnd:true,onBeforeDrag:function(o){if(o.attributes&&o.attributes.drag){return true}else{return false}},onDragEnter:function(E,D){var t=$("#cuberighttree").tree("getNode",E);if(!t.attributes||t.attributes.drag==false){return false}if(D.attributes.tp=="kpi"&&t.attributes.tp=="dim"){return false}if(t.attributes.tp=="kpi"&&D.attributes.tp=="dim"){return false}if(D.attributes.tp=="group"&&t.attributes.tp=="kpi"){return false}var o=$("#cuberighttree").tree("getParent",E);if(D.attributes.tp=="group"&&o.attributes&&o.attributes.tp=="group"){return false}return true},onBeforeDrop:function(F,E,o){var D=$("#cuberighttree").tree("getNode",F);if(!D.attributes||D.attributes.drag==false){return false}if(D.attributes.tp=="kpi"&&o=="append"){return false}if(D.attributes.tp=="dim"&&o=="append"){return false}if(E.attributes.tp=="kpi"&&D.attributes.tp=="dim"){return false}if(D.attributes.tp=="kpi"&&E.attributes.tp=="dim"){return false}if(E.attributes.tp=="group"&&D.attributes.tp=="kpi"){return false}var t=$("#cuberighttree").tree("getParent",F);if(E.attributes.tp=="group"&&t.attributes&&t.attributes.tp=="group"){return false}if(E.attributes.tp=="group"&&D.attributes.tp=="group"&&o=="append"){return false}return true},onDblClick:function(o){editcubecol($("#pdailog #datasetid").val())},onDrop:function(D,t,o){}});var h=function(E,D){var t=null;for(j=0;j<a.dim.length;j++){if(a.dim[j].tp=="dim"){if(a.dim[j].col==E&&a.dim[j].tname==D){t=a.dim[j];break}}else{if(a.dim[j].tp=="group"){var o=a.dim[j].children;for(k=0;k<o.length;k++){if(o[k].col==E&&o[k].tname==D){t=o[k];break}}if(t!=null){break}}}}if(t==null){for(j=0;j<a.kpi.length;j++){if(a.kpi[j].col==E&&a.kpi[j].tname==D){t=a.kpi[j];break}}}return t};if(a!=null){var v=$("#cubelefttree").tree("getChildren",$("#cubelefttree").tree("getRoot").target);for(i=0;i<v.length;i++){var r=null;if(v[i].attributes&&v[i].attributes.dyna){r=v[i].attributes.col}else{r=v[i].id}if(v[i].attributes&&h(r,v[i].attributes.tname)!=null){$(v[i].target).attr("hide","y").hide()}}}}}}}}}}})}function editCalcKpi(b,f){var g;if(b){g=$("#cuberighttree").tree("getSelected")}var h=["sum","avg","count","max","min"];var c="";for(i=0;i<h.length;i++){c=c+'<option value="'+h[i]+'" '+(g&&h[i]==g.attributes.aggre?"selected":"")+">"+h[i]+"</option>"}var d="";var e=$("#cuberighttree").tree("getChildren",$("#cuberighttree  div[node-id='cubedl']"));for(i=0;i<e.length;i++){var a=e[i].attributes;if(a.calc!=true){d=d+'<span name="'+a.col+'" aggre="'+a.aggre+'" class="column">'+a.dispName+"</span> "}}var l='<div class="textpanel"><span class="inputtext">显示名称：</span><input type="text" class="inputform" name="kpiname" id="kpiname" value="'+(g?g.attributes.dispName:"")+'"><br/><table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea rows="2" style="height:52px;" cols="40" id="expression" name="expression">'+(g?g.attributes.col:"")+'</textarea></td></tr></tbody></table><div class="actColumn">'+d+'</div><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+c+'</select><br><span class="inputtext">度量单位：</span><input type="text" value="'+(g?g.attributes.unit:"")+'" class="inputform" name="kpiunit" id="kpiunit"><br/><span class="inputtext">格式化：</span>'+ftmstr("kpifmt","inputform",(g?g.attributes.fmt:""))+'<br/><span class="inputtext">指标解释：</span><textarea name="kpinote" id="kpinote"  cols="25" style="height:32px;" rows="2">'+(g?g.attributes.kpinote:"")+"</textarea></div>";if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:"创建表达式度量",width:420,height:390,closed:false,cache:false,modal:true,toolbar:null,content:l,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){var n=$("#dsColumn_div #kpiname").val();var q=$("#dsColumn_div #expression").val();if(n==""){msginfo("请填写度量名称。");$("#dsColumn_div #kpiname").focus();return}if(q==""){msginfo("请填写度量表达式。");$("#dsColumn_div #expression").focus();return}if(b){g.attributes.aggre=$("#dsColumn_div #kpiaggre").val();g.attributes.fmt=$("#dsColumn_div #kpifmt").val();g.attributes.unit=$("#dsColumn_div #kpiunit").val();g.attributes.dispName=n;g.attributes.kpinote=$("#dsColumn_div #kpinote").val();g.attributes.col=q;$("#cuberighttree").tree("update",{target:g.target,text:g.attributes.aggre+"("+n+")"})}else{var r=findCubeMaxId($("#cuberighttree  div[node-id='cubedl']"));var p={id:r,text:$("#dsColumn_div #kpiaggre").val()+"("+n+")",attributes:{tp:"kpi",calc:true,drag:true,aggre:$("#dsColumn_div #kpiaggre").val(),col:q,dispName:n,tname:"",fmt:$("#dsColumn_div #kpifmt").val(),unit:$("#dsColumn_div #kpiunit").val(),kpinote:$("#dsColumn_div #kpinote").val(),dyna:false},iconCls:"icon-ckpi"};$("#cuberighttree").tree("append",{parent:$("#cuberighttree  div[node-id='cubedl']"),data:[p]})}$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});$("#dsColumn_div .actColumn .column").bind("click",function(){var n=$(this).attr("name");var o=$(this).attr("aggre");insertText2focus(document.getElementById("expression"),o+"("+n+") ")})}function editcubecol(e){var l=$("#cuberighttree").tree("getSelected");if(l==null||!l.attributes){msginfo("您还未选择需要编辑的度量或维度。");return}var a=l.id;if(!a){return}if(l.attributes.tp=="kpi"&&l.attributes.calc==true){editCalcKpi(true,l.id);return}var g=findDatasetById(e);var n="";var h=["sum","avg","count","max","min"];if(l.attributes.tp=="dim"){var b="";for(i=0;i<g.joininfo.length;i++){b=b+'<option value="'+g.joininfo[i].ref+'" '+(l.attributes.codetable==g.joininfo[i].ref?"selected":"")+">"+g.joininfo[i].ref+"</option>"}var c='<option value=""></option>';for(i=0;i<dateformat.length;i++){c=c+'<option value="'+dateformat[i]+'" '+(l.attributes.dateformat==dateformat[i]?"selected":"")+">"+dateformat[i]+"</option>"}n='<div class="textpanel"><span class="inputtext">维度字段：</span>'+l.attributes.col+'<br/><span class="inputtext">显示名称：</span><input type="text" id="dimname" name="dimname" class="inputform" value="'+l.attributes.dispName+'"><br/><span class="inputtext">维度类型：</span><select id="dimtype" name="dimtype" class="inputform"><option value=""></option><option value="year" '+(l.attributes.dimtype=="year"?"selected":"")+'>年</option><option value="quarter" '+(l.attributes.dimtype=="quarter"?"selected":"")+'>季度</option><option value="month" '+(l.attributes.dimtype=="month"?"selected":"")+'>月</option><option value="day" '+(l.attributes.dimtype=="day"?"selected":"")+'>日</option></select><br/><span class="inputtext">维度格式：</span><select id="dateformat" class="inputform">'+c+'</select><br/><span class="inputtext">对应维表：</span><select id="codetable" name="codetable" class="inputform"><option value=\'\'></option>'+b+'</select><br/><span class="inputtext">KEY字段：</span><select id="keycol" name="keycol" class="inputform"></select><br/><span class="inputtext">Text字段：</span><select id="valcol" name="valcol" class="inputform"></select></div>'}else{if(l.attributes.tp=="kpi"){var d="";for(i=0;i<h.length;i++){d=d+'<option value="'+h[i]+'" '+(h[i]==l.attributes.aggre?"selected":"")+">"+h[i]+"</option>"}n='<div class="textpanel"><span class="inputtext">度量字段：</span>'+l.attributes.col+'<br/><span class="inputtext">显示名称：</span><input type="text" id="kpiname" name="kpiname" class="inputform" value="'+l.attributes.dispName+'"><br/><span class="inputtext">来源表：</span>'+l.attributes.tname+'<br/><span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+d+'</select> <br><span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(l.attributes.unit?l.attributes.unit:"")+'"> <br><span class="inputtext">格式化：</span>'+ftmstr("kpifmt","inputform",l.attributes.fmt?l.attributes.fmt:"")+'<br/><span class="inputtext">指标解释：</span><textarea name="kpinote" id="kpinote"  cols="25" style="height:32px;" rows="2">'+(l.attributes.kpinote?unescape(l.attributes.kpinote):"")+"</textarea></div>"}else{if(l.attributes.tp=="group"){n='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" id="groupname" name="groupname" value="'+l.attributes.dispName+'" class="inputform"><br/><span class="inputtext">分组类型：</span><select id="grouptype" name="grouptype" class="inputform"><option value=""></option><option value="date" '+(l.attributes.grouptype=="date"?"selected":"")+">时间</option></select></div>"}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}$("#dsColumn_div").dialog({title:l.attributes.tp=="group"?"编辑分组":"编辑度量及维度",width:350,height:l.attributes.tp=="group"?150:320,closed:false,cache:false,modal:true,toolbar:null,content:n,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(l.attributes.tp=="kpi"){l.attributes.aggre=$("#dsColumn_div #kpiaggre").val();l.attributes.fmt=$("#dsColumn_div #kpifmt").val();l.attributes.unit=$("#dsColumn_div #kpiunit").val();l.attributes.dispName=$("#dsColumn_div #kpiname").val();var r=$("#dsColumn_div #kpinote").val();r=escape(r);l.attributes.kpinote=r;$("#cuberighttree").tree("update",{target:l.target,text:l.attributes.aggre+"("+l.attributes.dispName+")"})}else{if(l.attributes.tp=="dim"){var p=$("#dsColumn_div #dateformat").val();var q=$("#dsColumn_div #dimtype").val();if(q!=""&&p==""){msginfo("请选择维度格式。",function(){$("#dsColumn_div #dateformat").select()});return}l.attributes.dispName=$("#dsColumn_div #dimname").val();l.attributes.codetable=$("#dsColumn_div #codetable").val();l.attributes.keycol=$("#dsColumn_div #keycol").val();l.attributes.valcol=$("#dsColumn_div #valcol").val();l.attributes.dimtype=q;if(l.attributes.keycol==null){l.attributes.keycol=""}if(l.attributes.valcol==null){l.attributes.valcol=""}l.attributes.dateformat=p;$("#cuberighttree").tree("update",{target:l.target,text:$("#dsColumn_div #dimname").val()})}else{if(l.attributes.tp=="group"){l.attributes.dispName=$("#dsColumn_div #groupname").val();l.attributes.grouptype=$("#dsColumn_div #grouptype").val();$("#cuberighttree").tree("update",{target:l.target,text:$("#dsColumn_div #groupname").val()})}}}curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});if(l.attributes.tp=="dim"){var o=function(q){if(q==""){$("#dsColumn_div #keycol").html("");$("#dsColumn_div #valcol").html("")}else{var p=findDatasourceById(g.dsid);$.ajax({type:"post",url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(p),querysql:"select * from "+q+" where 1=2"},success:function(u){var t="";var r="";for(k=0;k<u.length;k++){t=t+'<option value="'+u[k].name+'" '+(u[k].name==l.attributes.keycol?"selected":"")+">"+u[k].name+"</option>";r=r+'<option value="'+u[k].name+'" '+(u[k].name==l.attributes.valcol?"selected":"")+">"+u[k].name+"</option>"}$("#dsColumn_div #keycol").html(t);$("#dsColumn_div #valcol").html(r)}});curTmpInfo.isupdate=true}};$("#dsColumn_div #codetable").bind("change",function(){var p=$(this).val();o(p)});var f=$("#dsColumn_div #codetable").val();if(f!=""){o(f)}}}function editcubecol2(c,n,o){var A=n;var q=fundCubeById(o.attributes.cubeId);var g=findDatasetById(q.datasetid);var r="";var u=["sum","avg","count","max","min"];if(c=="dim"){var t=findCubeDimById(q,n);var b="";for(i=0;i<g.joininfo.length;i++){b=b+'<option value="'+g.joininfo[i].ref+'" '+(t.codetable==g.joininfo[i].ref?"selected":"")+">"+g.joininfo[i].ref+"</option>"}var p='<option value=""></option>';for(i=0;i<dateformat.length;i++){p=p+'<option value="'+dateformat[i]+'" '+(t.dateformat==dateformat[i]?"selected":"")+">"+dateformat[i]+"</option>"}r='<div class="textpanel"><span class="inputtext">维度字段：</span>'+(t.dyna?t.col.replace(/@/g,"'"):t.col)+'<br/><span class="inputtext">显示名称：</span><input type="text" id="dimname" name="dimname" class="inputform" value="'+t.name+'"><br/><span class="inputtext">维度类型：</span><select id="dimtype" name="dimtype" class="inputform"><option value=""></option><option value="year" '+(t.dimtype=="year"?"selected":"")+'>年</option><option value="quarter" '+(t.dimtype=="quarter"?"selected":"")+'>季度</option><option value="month" '+(t.dimtype=="month"?"selected":"")+'>月</option><option value="day" '+(t.dimtype=="day"?"selected":"")+'>日</option></select><br/><span class="inputtext">维度格式：</span><select id="dateformat" class="inputform">'+p+'</select><br/><span class="inputtext">对应维表：</span><select id="codetable" name="codetable" class="inputform"><option value=\'\'></option>'+b+'</select><br/><span class="inputtext">KEY字段：</span><select id="keycol" name="keycol" class="inputform"></select><br/><span class="inputtext">Text字段：</span><select id="valcol" name="valcol" class="inputform"></select></div>'}else{if(c=="kpi"){var a=findCubeKpiById(q,n);var z="";for(i=0;i<u.length;i++){z=z+'<option value="'+u[i]+'" '+(u[i]==a.aggre?"selected":"")+">"+u[i]+"</option>"}var y="";var d=q.kpi;for(i=0;i<d.length;i++){var s=d[i];if(s.calc!=true){y=y+'<span name="'+s.col+'", aggre="'+s.aggre+'" class="column">'+s.name+"</span> "}}r='<div class="textpanel">'+(!a.calc?'<span class="inputtext">度量字段：</span>'+(a.dyna?a.col.replace(/@/g,"'"):a.col)+"<br/>":"")+'<span class="inputtext">显示名称：</span><input type="text" id="kpiname" name="kpiname" class="inputform" value="'+a.name+'"><br/>'+(!a.calc?'<span class="inputtext">来源表：</span>'+a.tname+"<br/>":"")+(a.calc?'<table cellspacing="0" cellpadding="0"><tbody><tr><td valign="top"><span class="inputtext">表 达 式：</span></td><td><textarea rows="2" style="height:52px;" cols="45" id="expression" name="expression">'+(a.col?a.col:"")+'</textarea></td></tr></tbody></table><div class="actColumn">'+y+"</div>":"")+'<span class="inputtext">计算方式：</span><select id="kpiaggre" name="kpiaggre" class="inputform">'+z+'</select> <br><span class="inputtext">度量单位：</span><input type="text" id="kpiunit" name="kpiunit" class="inputform" value="'+(a.unit?a.unit:"")+'"> <br><span class="inputtext">格式化：</span>'+ftmstr("kpifmt","inputform",a.fmt?a.fmt:"")+'<br/><span class="inputtext">指标解释：</span><textarea name="kpinote" id="kpinote"  cols="25" style="height:32px;" rows="2">'+(a.kpinote?unescape(a.kpinote):"")+"</textarea></div>"}else{if(c=="group"){var e=findCubeGroupById(q,n);r='<div class="textpanel"><span class="inputtext">分组名称：</span><input type="text" id="groupname" name="groupname" value="'+e.name+'" class="inputform"><br/><span class="inputtext">分组类型：</span><select id="grouptype" name="grouptype" class="inputform"><option value=""></option><option value="date" '+(e.grouptype=="date"?"selected":"")+">时间</option></select></div>"}}}if($("#dsColumn_div").size()==0){$('<div id="dsColumn_div" class="easyui-menu"></div>').appendTo("body")}var l=350;if(c=="kpi"){l=420}var v=300;if(c=="group"){v=150}else{if(c=="kpi"){v=360}}$("#dsColumn_div").dialog({title:c=="group"?"编辑分组":"编辑度量及维度",width:l,height:v,closed:false,cache:false,modal:true,toolbar:null,content:r,onLoad:function(){},onClose:function(){$("#dsColumn_div").dialog("destroy")},buttons:[{text:"确定",handler:function(){if(c=="kpi"){var E=findCubeKpiById(q,n);E.aggre=$("#dsColumn_div #kpiaggre").val();E.fmt=$("#dsColumn_div #kpifmt").val();E.unit=$("#dsColumn_div #kpiunit").val();E.name=$("#dsColumn_div #kpiname").val();var w=$("#dsColumn_div #kpinote").val();E.kpinote=escape(w);if(E.calc){E.col=$("#dsColumn_div #expression").val()}$("#mydatatree").tree("update",{target:o.target,text:E.aggre+"("+E.name+")"})}else{if(c=="dim"){var D=findCubeDimById(q,n);var h=$("#dsColumn_div #dateformat").val();var B=$("#dsColumn_div #dimtype").val();if(B!=""&&h==""){msginfo("请选择维度格式。",function(){$("#dsColumn_div #dateformat").select()});return}D.name=$("#dsColumn_div #dimname").val();D.codetable=$("#dsColumn_div #codetable").val();D.keycol=$("#dsColumn_div #keycol").val();D.valcol=$("#dsColumn_div #valcol").val();D.dimtype=B;if(D.keycol==null){D.keycol=""}if(D.valcol==null){D.valcol=""}D.dateformat=h;$("#mydatatree").tree("update",{target:o.target,text:$("#dsColumn_div #dimname").val()})}else{if(c=="group"){var C=findCubeGroupById(q,n);C.name=$("#dsColumn_div #groupname").val();C.grouptype=$("#dsColumn_div #grouptype").val();$("#mydatatree").tree("update",{target:o.target,text:$("#dsColumn_div #groupname").val()})}}}initselectDataTree();curTmpInfo.isupdate=true;$("#dsColumn_div").dialog("close")}},{text:"取消",handler:function(){$("#dsColumn_div").dialog("close")}}]});if(c=="kpi"){$("#dsColumn_div .actColumn .column").bind("click",function(){var h=$(this).attr("name");var w=$(this).attr("aggre");insertText2focus(document.getElementById("expression"),w+"("+h+") ")})}if(c=="dim"){var f=function(w){if(w==""){$("#dsColumn_div #keycol").html("");$("#dsColumn_div #valcol").html("")}else{var h=findDatasourceById(g.dsid);$.ajax({type:"post",url:"DataSet!queryMeta.action",dataType:"json",data:{ds:JSON.stringify(h),querysql:"select * from "+w+" where 1=2"},success:function(D){var C="";var B="";for(s=0;s<D.length;s++){C=C+'<option value="'+D[s].name+'" '+(D[s].name==t.keycol?"selected":"")+">"+D[s].name+"</option>";B=B+'<option value="'+D[s].name+'" '+(D[s].name==t.valcol?"selected":"")+">"+D[s].name+"</option>"}$("#dsColumn_div #keycol").html(C);$("#dsColumn_div #valcol").html(B)}})}};$("#dsColumn_div #codetable").bind("change",function(){var h=$(this).val();f(h)});var x=$("#dsColumn_div #codetable").val();if(x!=""){f(x)}}}function findCubeMaxId(c){var b=0;var a=$("#cuberighttree").tree("getChildren",c);for(i=0;i<a.length;i++){if(Number(a[i].id)>b){b=Number(a[i].id)}}return b+1}function ds2cube(){var c=$("#cubelefttree").tree("getSelected");if(c==null){msginfo("您还未从左边选择字段。");return}if($(c.target).attr("hide")=="y"){return}var a=$("#cuberighttree").tree("getSelected");if(a==null){msginfo("您还未选择右边度量或维度。");return}var b=$("#cuberighttree").tree("getParent",a.target);if(a.text=="度量"||b.text=="度量"){var e=findCubeMaxId($("#cuberighttree  div[node-id='cubedl']"));var d={id:e,text:"sum("+c.text+")",attributes:{tp:"kpi",drag:true,aggre:"sum",col:c.attributes.col,dispName:c.text,tname:c.attributes.tname,dyna:c.attributes.dyna},iconCls:"icon-kpi"};if(a.text=="度量"){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}else{if(a.text=="维度"||b.text=="维度"||b.attributes.tp=="group"){var e=findCubeMaxId($("#cuberighttree  div[node-id='cubewd']"));var d={id:e,text:c.text,attributes:{tp:"dim",drag:true,col:c.attributes.col,dispName:c.text,tname:c.attributes.tname,vtype:c.attributes.vtype,dyna:c.attributes.dyna,refId:c.id},iconCls:"icon-dim"};if(a.text=="维度"||(b.text=="维度"&&a.attributes.tp=="group")){$("#cuberighttree").tree("append",{parent:a.target,data:d})}else{$("#cuberighttree").tree("insert",{after:a.target,data:d})}$(c.target).attr("hide","y").hide()}}curTmpInfo.isupdate=true}function cube2ds(){var b=$("#cuberighttree").tree("getSelected");if(b==null||!b.attributes){msginfo("您还未选择需要删除的度量或维度。");return}if(b.attributes.tp=="group"){if($("#cubelefttree").tree("getChildren",b.target).length>0){msginfo("您要删除的分组含有维度，不能删除。");return}}if(b.attributes.tp!="group"){var e=b.attributes.refId?b.attributes.refId:b.attributes.col;var d=b.attributes.tname;var a=$("#cubelefttree").tree("getRoot");var c=$("#cubelefttree").tree("getChildren",a.target);for(i=0;i<c.length;i++){if(c[i].id==e&&c[i].attributes&&c[i].attributes.tname==d){$(c[i].target).attr("hide","n").show();break}}}$("#cuberighttree").tree("remove",b.target);curTmpInfo.isupdate=true}function newGuid(){var a="";for(var b=1;b<=32;b++){var c=Math.floor(Math.random()*16).toString(16);a+=c}return a}function encoder(h,g){var f=["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0",".","-","*","/","'",":",";",">","<","~","!","@","#","$","%","^","&","(",")","{","}","[","]","|","_"];var e=["T","l","m",">","S","&","J","G","/","!","p","h","Z","7","q","_","U","(","0","a","X","f","^","@","D","~","M","t","O","6","9","C","N","K","H","g","w","4","F","<","e","2","R","o","$","d","V","v","]","#","[","L","r","b","Y","{","z","k","x","n","5","B","W","-","A","P","1","j","E","u","s","'","I","c","%",".","i","y","Q","*",")","3","8","}",";",":","|"];var a=function(o,c){var p=-1;for(var n=0;n<c.length;n++){if(o==c[n]){p=n;break}}return p};var d="";if(g=="encode"){for(var b=0;b<h.length;b++){var l=h.charAt(b);d=d+e[a(l,f)]}}else{if(g=="decode"){for(var b=0;b<h.length;b++){var l=h.charAt(b);d=d+f[a(l,e)]}}}return d}function ftmstr(d,b,a){var c='<select id="'+d+'" name="'+d+'" class="'+b+'">';c=c+'<option value=""></option><option '+(a=="#,###"?"selected":"")+' value="#,###">整数</option><option '+(a=="#,###.00"?"selected":"")+' value="#,###.00">小数</option><option '+(a=="0.00%"?"selected":"")+' value="0.00%">百分比</option>';c=c+"</select>";return c}function findDatasourceById(a){var b=null;for(i=0;i<pageInfo.datasource.length;i++){if(pageInfo.datasource[i].dsid==a){b=pageInfo.datasource[i]}}return b}function findDatasetById(a){var b=null;for(var c=0;c<pageInfo.dataset.length;c++){var e=pageInfo.dataset[c];if(e.datasetid==a){b=e;break}}return b}function fundCubeById(c){var a=null;for(var b=0;b<pageInfo.cube.length;b++){var e=pageInfo.cube[b];if(e.id==c){a=e;break}}return a}function findCubeKpiById(a,f,h){var c=null;var b=-1;if(!a.kpi||a.kpi.length==0){if(h==true){return b}else{return c}}for(var e=0;e<a.kpi.length;e++){var g=a.kpi[e];if(g.id==f){c=g;b=e;break}}if(h==true){return b}else{return c}}function findCubeDimById(a,f){var c=null;if(!a.dim||a.dim.length==0){return c}for(var e=0;e<a.dim.length;e++){var g=a.dim[e];if(g.tp=="dim"){if(g.id==f){c=g;break}}else{if(g.tp=="group"){for(var b=0;b<g.children.length;b++){if(g.children[b].id==f){c=g.children[b];break}}}}}return c}function findCubeGroupById(a,f,h){var c=null;var b=-1;if(!a.dim||a.dim.length==0){if(h==true){return b}else{return c}}for(var e=0;e<a.dim.length;e++){var g=a.dim[e];if(g.tp=="group"){if(g.id==f){c=g;b=e;break}}}if(h==true){return b}else{return c}}function insertText2focus(e,f){e.focus();if(document.selection){var d=document.selection.createRange();d.text=f}else{if(typeof e.selectionStart=="number"&&typeof e.selectionEnd=="number"){var c=e.selectionStart,b=e.selectionEnd,g=c,a=e.value;e.value=a.substring(0,c)+" "+f+a.substring(b,a.length);g+=f.length;e.selectionStart=e.selectionEnd=g}else{e.value+=f}}}if($==undefined){$=jQuery}function drill(h,l,f,b,c,a,o){var e=findCompById(l);var g=null;if(!e.dims){e.dims=copyCubedims(e.tid)}if(f=="row"){g=e.tableJson.rows}else{g=e.tableJson.cols}if(e.complink&&o){var d=findCompById(e.complink);if(d!=null&&isSameDimsInDrill(e,d)){drillingChart(h,d,f,b,c,a,false)}}for(i=0;i<g.length;i++){if(g[i].id==a){g[i].vals=b}}var n=null;for(j=0;j<e.dims.length;j++){if(e.dims[j].dim_id==h){n=e.dims[j];break}}g.push({id:n.dim_id,dimdesc:n.dim_desc,type:n.dim_type,colname:n.col_name,tid:n.tid,iscas:"",tableName:(n.dim_tname==null?"":n.dim_tname),tname:n.tname,tableColKey:(n.tableColKey==null?"":n.tableColKey),tableColName:(n.tableColName==null?"":n.tableColName),dimord:n.dim_ord,dim_name:n.dim_name,iscas:(n.iscas==null?"":n.iscas),grouptype:n.grouptype,valType:n.valType,dyna:n.dyna,ord:n.ord,dateformat:n.dateformat});curTmpInfo.isupdate=true;tableView(e,e.id)}function drillDim(n,h,l,d,e,b){var g=findCompById(n);var f=$(h).offset();var a=function(r){$("#drillmenu").menu("destroy");var v='<div id="drillmenu" style="width:150px">';var p=0;var x=[];var A=function(B,D){var C=false;for(k=0;k<B.length;k++){if(B[k]==D){C=true}}return C};var w=function(B){var C=[];for(j=0;j<r.length;j++){if(r[j].grouptype==B){C.push(r[j])}}return C};for(i=0;i<r.length;i++){if(!dimExist(r[i].dim_id,g.tableJson.cols)&&!dimExist(r[i].dim_id,g.tableJson.rows)){if(r[i].grouptype==""){var y=r[i].dim_id;v=v+'<div onclick="drill('+y+", "+g.id+", '"+l+"', '"+d+"', '"+e+"', '"+b+'\', true)"><span style="color:#ccc">下钻</span>'+r[i].dim_desc+"</div>";p=p+1}else{if(!A(x,r[i].grouptype)){var q='<div><span style="color:#ccc">下钻</span><span>'+r[i].groupname+'</span><div style="width:150px;">';x.push(r[i].grouptype);var o=w(r[i].grouptype);var z="";var s=0;for(kl=0;kl<o.length;kl++){var t=o[kl];var u=!dimExist(t.dim_id,g.tableJson.cols)&&!dimExist(t.dim_id,g.tableJson.rows);if(u){z=z+'<div onclick="drill('+t.dim_id+", "+g.id+", '"+l+"', '"+d+"', '"+e+"', '"+b+'\', true)"><span style="color:#ccc">下钻</span>'+t.dim_desc+"</div>";s=s+1}else{z="";s=0}}q=q+z+"</div></div>";if(s==0){q=""}v=v+q;p=p+s}}}}v=v+"</div>";if(p==0){msginfo("数据已钻透。");return}$(v).appendTo("body");$("#drillmenu").menu({});$("#drillmenu").menu("show",{left:f.left,top:f.top+20})};if(g.dims){a(g.dims)}else{var c=g.dims=copyCubedims(g.tid);a(c)}}function copyCubedims(g){var b=fundCubeById(g);var l=b.dim;var f=[];var e=b.aggreTable||b.divison?true:false;var a=0;for(i=0;i<l.length;i++){var h=l[i];if(h.tp=="dim"){f.push({dim_id:h.id,tid:b.id,dim_name:h.col,dim_desc:h.name,dim_tname:h.codetable,dim_type:"frd",col_name:(e?h.refId:h.col),iscas:"n",tname:(h.tname),tableName:h.codetable,tableColKey:h.keycol,tableColName:h.valcol,dim_ord:null,grouptype:"",groupname:"",valType:h.vtype,dyna:h.dyna,ord:a,dateformat:h.dateformat});a++}else{if(h.tp=="group"){for(j=0;j<h.children.length;j++){var c=h.children[j];f.push({dim_id:c.id,tid:b.id,dim_name:c.col,dim_desc:c.name,dim_tname:c.codetable,dim_type:(!c.dimtype||c.dimtype==""?"frd":c.dimtype),col_name:(e?c.refId:c.col),iscas:(j==0?"n":"y"),tname:(c.tname),tableName:c.codetable,tableColKey:c.keycol,tableColName:c.valcol,dim_ord:null,grouptype:"g"+h.id,groupname:h.name,valType:c.vtype,dyna:c.dyna,ord:a,dateformat:c.dateformat});a++}}}}return f}function goupDim(h,c,d,g,l){var f=null;var b=findCompById(h);if(d=="row"){f=b.tableJson.rows}else{f=b.tableJson.cols}if(b.complink&&l){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(b,a)){chartGoupDim(a.id,g,d,false)}}var e=0;for(i=0;i<f.length;i++){if(f[i].id==g){f[i].vals="";if(f[i].type=="day"){delete f[i].startdt;delete f[i].enddt}if(f[i].type=="month"){delete f[i].startmt;delete f[i].endmt}e=i;break}}f.splice(e+1,f.length-1);curTmpInfo.isupdate=true;tableView(b,b.id)}function drillChart(h,f,n,b,l,o,c){var g=findCompById(o);var e=l;var a=function(t){$("#drillmenu").menu("destroy");var w='<div id="drillmenu" style="width:150px">';var q=0;var y=[];var B=function(C,E){var D=false;for(k=0;k<C.length;k++){if(C[k]==E){D=true}}return D};var x=function(C){var D=[];for(j=0;j<t.length;j++){if(t[j].grouptype==C){D.push(t[j])}}return D};for(i=0;i<t.length;i++){if(dimExist(t[i].dim_id,g.chartJson.params)||(g.chartJson.xcol&&t[i].dim_id==g.chartJson.xcol.id)||(g.chartJson.scol&&t[i].dim_id==g.chartJson.scol.id)){continue}if(t[i].grouptype==""){var z=t[i].dim_id;w=w+'<div onclick="drillingChart('+z+", "+g.id+", 'row', '"+h+"', '"+f+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+t[i].dim_desc+"</div>";q=q+1}else{if(!B(y,t[i].grouptype)){var r='<div><span style="color:#ccc">下钻</span><span>'+t[i].groupname+'</span><div style="width:150px;">';y.push(t[i].grouptype);var p=x(t[i].grouptype);var A="";var u=0;for(kl=0;kl<p.length;kl++){var v=p[kl];var s=dimExist(v.dim_id,g.chartJson.params)||(g.chartJson.xcol&&v.dim_id==g.chartJson.xcol.id)||(g.chartJson.scol&&v.dim_id==g.chartJson.scol.id);if(!s){A=A+'<div onclick="drillingChart('+v.dim_id+", "+g.id+", 'row', '"+h+"', '"+f+"', '"+c+'\', true)"><span style="color:#ccc">下钻</span>'+v.dim_desc+"</div>";u=u+1}else{A="";u=0}}r=r+A+"</div></div>";if(u==0){r=""}w=w+r;q=q+u}}}w=w+"</div>";if(q==0){msginfo("数据已钻透。");return}$(w).appendTo("body");$("#drillmenu").menu({});$("#drillmenu").menu("show",{left:e.left,top:e.top+20})};if(g.dims){a(g.dims)}else{var d=g.dims=copyCubedims(g.tid);a(d)}}function drillingChart(b,o,n,l,g,a,q){var h=findCompById(o);if(!h.dims){h.dims=copyCubedims(h.tid)}if(n=="row"){h.chartJson.xcol.vals=l+"";h.chartJson.xcol.valDesc=g;h.chartJson.xcol.pos="row"}else{h.chartJson.scol.vals=l+"";h.chartJson.scol.valDesc=g;h.chartJson.scol.pos="col"}if(h.complink&&q){var d=findCompById(h.complink);if(d!=null&&isSameDimsInDrill(d,h)){drill(b,d,"row",l,g,a,false)}}var f=n=="row"?h.chartJson.xcol:h.chartJson.scol;f.filtertype=2;if(f.type=="month"){delete f.startmt;delete f.endmt}if(f.type=="day"){delete f.startdt;delete f.enddt}if(l=="合计"&&g=="合计"){}else{h.chartJson.params.push(n=="row"?h.chartJson.xcol:h.chartJson.scol)}var p=null;for(j=0;j<h.dims.length;j++){if(h.dims[j].dim_id==b){p=h.dims[j];break}}var e={id:p.dim_id,dimdesc:p.dim_desc,type:p.dim_type,colname:p.col_name,tid:p.tid,iscas:"",tableName:(p.dim_tname==null?"":p.dim_tname),tname:p.tname,tableColKey:(p.tableColKey==null?"":p.tableColKey),tableColName:(p.tableColName==null?"":p.tableColName),dimord:p.dim_ord,dim_name:p.dim_name,iscas:(p.iscas==null?"":p.iscas),grouptype:p.grouptype,valType:p.valType,dyna:p.dyna,ord:p.ord,dateformat:p.dateformat};if(n=="row"){h.chartJson.xcol=e}else{h.chartJson.scol=e}var c=e;$("#T"+h.id+(n=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+c.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+c.id+","+(n=="row"?"'xcol'":"'scol'")+", '"+c.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(h,h.id)}function chartGoupDim(l,g,d,n){var c=findCompById(l);var e=c.chartJson.params;if(c.complink&&n){var b=findCompById(c.complink);if(b!=null&&isSameDimsInDrill(b,c)){goupDim(b.id,null,d,g,false)}}var f=0;var h=null;for(i=0;i<e.length;i++){if(e[i].id==g){e[i].vals="";e[i].valDesc="";delete e[i].filtertype;f=i;h=e[i];break}}if(d=="row"){c.chartJson.xcol=h}else{c.chartJson.scol=h}e.splice(f,e.length);var a=h;$("#T"+c.id+(d=="row"?" #xcol":" #scol")).html('<span class="charttxt">'+a.dimdesc+'</span><span class="charticon" title="配置" onclick="chartmenu(this, '+a.id+","+(d=="row"?"'xcol'":"'scol'")+", '"+a.dimdesc+"')\"></span>");curTmpInfo.isupdate=true;chartview(c,c.id)}function isSameDimsInDrill(f,e){var d=f.tableJson;var b=e.chartJson;var g=d.cols.length+d.rows.length;var c=(b.params?b.params.length:0)+($.isEmptyObject(b.xcol)?0:1)+($.isEmptyObject(b.scol)?0:1);if(g!=c){return false}var a=true;for(i=0;b.params&&i<b.params.length;i++){if(!dimExist(b.params[i].id,d.cols)&&!dimExist(b.params[i].id,d.rows)){return false}}if(!$.isEmptyObject(b.xcol)){if(!dimExist(b.xcol.id,d.cols)&&!dimExist(b.xcol.id,d.rows)){return false}}if(!$.isEmptyObject(b.scol)){if(!dimExist(b.scol.id,d.cols)&&!dimExist(b.scol.id,d.rows)){return false}}return a}function paramsamedimdate(a){var d=true;var b=function(e){var f=false;for(var g=0;a.tableJson&&g<a.tableJson.cols.length;g++){if(a.tableJson.cols[g].type==e){f=true;break}}for(var g=0;a.tableJson&&g<a.tableJson.rows.length;g++){if(a.tableJson.rows[g].type==e){f=true;break}}return f};var c=pageInfo.params;for(i=0;c&&i<c.length;i++){if(c[i].grouptype=="date"){if(!b(c[i].type)){d=false;break}}}return d}function delExtKpi(d,g,f){var c=$(d).parents(".comp_table").attr("id").replace("T","");var a=findCompById(Number(c));var h=findKpiById(g,a.kpiJson);var e=h.compute.split(",");if(e.length==1){delete h.compute}else{var b="";for(i=0;i<e.length;i++){if(e[i]!=f){b=b+e[i]+","}}h.compute=b.substring(0,b.length-1)}tableView(a,c)}if($==undefined){$=jQuery}function initpage(){$("#l_tab").tabs({fit:true,border:false});loadMyReportTree();initviewTree();initselectDataTree();initparam();for(i=0;i<pageInfo.comps.length;i++){var a=pageInfo.comps[i];var b=a.type=="text"?a.text.replace(/\n/g,"<br>"):null;addComp(a.id,a.name,b,false,a.type,isnewpage?null:a)}initmydatatree();$(".comp_table .title .ticon a").live("mouseover",function(){$(this).css("opacity",1)}).live("mouseout",function(){$(this).css("opacity",0.6)}).live("click",function(){var c=$(this).attr("pid");delComp(c)});$(".dimoptbtn,.one_p,.charticon").live("mouseover",function(){$(this).css("opacity",1)}).live("mouseout",function(){$(this).css("opacity",0.6)});$(".dimDrill,.dimgoup,.chartdrillDim a").live("mouseover",function(){$(this).css("opacity",1)}).live("mouseout",function(){$(this).css("opacity",0.5)})}function newpage(a){var b=a?"ReportDesign!view.action":"ReportDesign.action";if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(a,function(){location.href=b})}else{location.href=b}}else{location.href=b}}function insertTable(){addComp(getMaxCompId(),"表格组件",null,true,"table")}function initparam(){if(pageInfo.params&&pageInfo.params.length>0){$("#optarea #p_param div.ptabhelpr").remove();$("#optarea #p_param").append("<b>参数： </b>");for(i=0;i<pageInfo.params.length;i++){var a=$("#optarea #p_param");var b='<span class="pppp" id="pa_'+pageInfo.params[i].id+'"><span title="筛选" onclick="paramFilter(\''+pageInfo.params[i].id+"', '"+pageInfo.params[i].type+"', '"+pageInfo.params[i].name+'\')" class="text">'+pageInfo.params[i].name+"(";b=b+(!pageInfo.params[i].valStrs||pageInfo.params[i].valStrs==""?"无":pageInfo.params[i].valStrs);b=b+')</span><a class="one_p" title="删除" onclick="deleteParam(\''+pageInfo.params[i].id+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>';a.append(b)}}$("#optarea #p_param").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(f,d){var c=$("#selectdatatree").tree("getNode",d);var g=c.attributes.col_type;if(g==1){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$(this).css("border","1px solid #ff0000")}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$(this).css("border","1px dotted #999999");d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,d){h.cancelBubble=true;h.stopPropagation();$(this).css("border","1px dotted #999999");var c=$("#selectdatatree").tree("getNode",d);var l=c.attributes.col_type;if(l==1){if(!pageInfo.params){pageInfo.params=[]}if(findParamById(c.id)!=null){msginfo("您已经添加了该参数！");return}var n=c.attributes.col_id;var g={id:n,name:c.text,type:c.attributes.dim_type,tname:c.attributes.tname,colname:c.attributes.col,tableName:c.attributes.tableName,tableColKey:c.attributes.tableColKey,tableColName:c.attributes.tableColName,vals:"",tid:c.attributes.tid,valType:c.attributes.valType,dyna:c.attributes.dyna,ord:c.attributes.ord,grouptype:c.attributes.grouptype,dateformat:c.attributes.dateformat};pageInfo.params.push(g);var f=$(this);f.find("div.ptabhelpr").remove();if(f.find("b").size()==0){f.append("<b>参数： </b>")}f.append('<span class="pppp" id="pa_'+n+'"><span title="筛选" onclick="paramFilter(\''+n+"', '"+c.attributes.dim_type+"','"+c.text+'\')" class="text">'+c.text+'(无)</span><a class="one_p" title="删除" onclick="deleteParam(\''+n+'\')" href="javascript:;" style="opacity: 0.6;"> &nbsp; </a></span>');initviewTree();paramFilter(n,g.type,g.name)}}})}function loadDimFunc(a,c,d,b){$.ajax({type:"post",dataType:"json",url:"DimFilter.action",data:{dsource:JSON.stringify(c),dim:JSON.stringify(d),keyword:b,aggreTable:a.aggreTable},success:function(f){var e="";for(i=0;i<f.length;i++){e=e+'<div class="fltone"><input type="checkbox" id="D'+f[i].id+'" name="dimval" value="'+f[i].id+'" desc="'+f[i].text+'"><label for="D'+f[i].id+'">'+f[i].text+"</label></div>"}$("#pdailog .dxwd .wdlist").html(e)}})}function loadDimFunc2(a,c,d,b){$.ajax({type:"post",dataType:"json",url:"DimFilter!listVals.action",data:{dsource:JSON.stringify(c),dim:JSON.stringify(d),keyword:b,aggreTable:a.aggreTable},success:function(e){var f="";for(i=0;i<e.length;i++){f=f+'<div class="fltone"><input type="checkbox" desc="'+e[i].text+'" value="'+e[i].id+'" name="dimval" id="D'+e[i].id+'"><label for="D'+e[i].id+'">'+e[i].text+"</label></div>"}$("#pdailog .dxwd .wdlist").html(f)}})}function paramFilter(b,g,a){var e=findParamById(b);var c=fundCubeById(e.tid);var h=findDatasetById(c.datasetid);var d=findDatasourceById(h.dsid);var l=[];if(e.vals){l=e.vals.split(",")}var n=function(r){var q=false;for(j=0;j<l.length;j++){if(r==l[j]){q=true;break}}return q};var p="";var o="";var f=e.valStrs?e.valStrs.split(","):[];for(j=0;j<l.length;j++){o=o+'<div class="fltone"><input type="checkbox" id="S'+l[j]+'" name="dimselcet" value="'+l[j]+'" desc="'+f[j]+'"><label for="S'+l[j]+'">'+f[j]+"</label></div>"}p='<div class="dxwd"><div class="wdhead">待选维度</div><input id="dimsearch" style="width:230px;"></input><div class="wdlist" style="height:278px;"></div></div><div class="xzwdbtn"><input type="button" value=">" id="xzwd" style="margin-top:120px;" title="选择"><br/><input type="button" value="<" id="scwd" title="删除"></div><div class="yxwd"><div class="wdhead">已选维度</div><div class="wdlist">'+o+"</div></div>";$("#pdailog").dialog({title:a+" - 参数值筛选",width:546,height:400,closed:false,cache:false,modal:true,content:p,buttons:[{text:"确定",handler:function(){var r="";var q="";var s=$("#pdailog input[name='dimselcet']");if(s.size()==0){e.vals="";e.valStrs="";$("#optarea #p_param #pa_"+b+" span.text").text(a+"(无)")}else{s.each(function(u,t){r=r+$(this).val();if(u!=s.size()-1){r=r+","}q=q+$(this).attr("desc");if(u!=s.size()-1){q=q+","}});$("#optarea #p_param #pa_"+b+" span.text").text(a+"("+(q==""?"无":q)+")");e.vals=r;e.valStrs=q}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;flushPage()}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(e.tableName==""||e.tableColKey==""||e.tableColName==""){loadDimFunc2(c,d,e,"")}else{loadDimFunc(c,d,e,"")}$("#pdailog #xzwd").click(function(){var q=$("#pdailog input[name='dimselcet']");var r=function(t){var s=false;for(i=0;i<q.size();i++){if($(q.get(i)).val()==t){s=true;break}}return s};$("#pdailog input[name='dimval']:checkbox:checked").each(function(s,t){if(!r($(t).val())){var u='<div class="fltone"><input type="checkbox" desc="'+$(t).attr("desc")+'" value="'+$(t).val()+'" name="dimselcet" id="S'+$(t).val()+'"><label for="S'+$(t).val()+'">'+$(t).attr("desc")+"</label></div>";$("#pdailog .yxwd .wdlist").append(u)}})});$("#pdailog #scwd").click(function(){$("#pdailog input[name='dimselcet']:checkbox:checked").each(function(q,r){$(r).parent().remove()})});$("#pdailog #dimsearch").searchbox({searcher:function(r,q){if(e.tableName==""||e.tableColKey==""||e.tableColName==""){loadDimFunc2(c,d,e,r)}else{loadDimFunc(c,d,e,r)}},prompt:"维度搜索..."})}function flushPage(){for(var a=0;pageInfo.comps&&a<pageInfo.comps.length;a++){var b=pageInfo.comps[a].type;if(b=="table"){tableView(pageInfo.comps[a],pageInfo.comps[a].id)}else{if(b=="chart"){chartview(pageInfo.comps[a],pageInfo.comps[a].id)}}}}function deleteParam(c){$("#optarea #p_param #pa_"+c).remove();var a=-1;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var b=pageInfo.params[i];if(b.id==c){a=i;break}}pageInfo.params.splice(a,1);if(pageInfo.params.length==0){$("#optarea #p_param").html('<div class="ptabhelpr">拖拽维度到此处作为页面参数</div>')}initviewTree();flushPage()}function initviewTree(){var e=[{text:"页面参数",id:"param",state:"open",iconCls:"icon-param"},{text:"页面组件",id:"comp",state:"open"}];if(pageInfo.params){e[0].children=[];for(var c=0;c<pageInfo.params.length;c++){var f=pageInfo.params[c];e[0].children.push({text:f.name,id:f.id,iconCls:"icon-param",attributes:{showmenu:false,type:"param"}})}}if(pageInfo.comps){e[1].children=[];for(var b=0;b<pageInfo.comps.length;b++){var a=pageInfo.comps[b];var f={text:a.name,id:a.id,attributes:{showmenu:true,type:"compview"}};var d=a.type;if(d=="chart"){f.iconCls="icon-chart"}else{if(d=="table"){f.iconCls="icon-cross"}else{if(d=="text"){f.iconCls="icon-label"}}}e[1].children.push(f)}}$("#viewtree").tree({data:e,onContextMenu:function(h,g){h.preventDefault();if(!g.attributes||g.attributes.showmenu!=true||g.attributes.type=="compview"){return}curTmpInfo.tp=g.attributes.type;curTmpInfo.id=g.id;$("#viewtree").tree("select",g.target);$("#mydatasetmenu").menu("show",{left:h.pageX,top:h.pageY})},onClick:function(g){if(g.attributes.type=="compview"){compBorderSet($("#"+g.id));setProp($("#"+g.id).parent().attr("id").split("_")[1],g.id)}}})}function openreport(a){$("#pdailog").dialog({title:"打开报表",width:550,height:300,closed:false,cache:false,modal:true,toolbar:null,onLoad:function(){},buttons:[{text:"确定",handler:function(){var c=$('input[name="reportId"]:checked').val();if(!c||c==null){msginfo("请至少选择一个报表！");return}$("#pdailog").dialog("close");var b=(a?"ReportDesign!view.action":"ReportDesign.action")+"?pageId="+c;if(curTmpInfo.isupdate==true){if(confirm("页面还未保存\n是否保存当前页面？")){savepage(a,function(){location.href=b})}else{location.href=b}}else{location.href=b}}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog").dialog("refresh","MyReport!list.action?view="+curTmpInfo.view)}function findCompById(c){var a=null;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id==c){a=b;break}}return a}function delComp(c){var a=-1;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id==c){a=i;break}}pageInfo.comps.splice(a,1);$("#T"+c).remove();if(pageInfo.comps.length==0){$("#optarea").append("<div class='tabhelpr'>请先添加组件再进行多维分析(点击<strong>插入</strong>按钮)。</div>")}initviewTree()}function addComp(g,c,b,d,f,a){if(pageInfo.comps.length==0){$("#optarea .tabhelpr").remove()}if(b==null||b==undefined){if(f=="table"){if(a==null||a==undefined){b=crtCrossTable()}else{if(a.tableJson==undefined||a.kpiJson==undefined){b=crtCrossTable()}else{b=""}}}else{if(f=="chart"){b=crtChart(g)}}}if(d==true){pageInfo.comps.push({id:g,name:c,type:f});curTmpInfo.isupdate=true;initviewTree()}$('<div class="comp_table" tp="'+f+'" id="T'+g+'"><div class="title"><div title="双击改名" class="tname">'+c+'</div><div title="移动组件" class="mvcomp"></div><div class="ticon"><a title=\'删除组件\' pid=\''+g+"' href='javascript:;'></a></div></div><div class=\"ctx\""+(f=="text"?'title="双击修改文本内容"':"")+">"+(b==null?"":b)+"</div></div>").appendTo("#optarea");if(f=="table"){if(a!=null&&a!=undefined){if(a.tableJson==undefined||a.kpiJson==undefined){initDropDiv(g)}else{tableView(a,g)}}else{initDropDiv(g)}}if(f=="chart"){if(a!=null&&a!=undefined){chartview(a,g);backChartData(a);if(a.chartJson.type=="bubble"||a.chartJson.type=="scatter"){initChartByScatter(g)}else{initChartKpiDrop(g)}}else{if(curTmpInfo.charttype=="bubble"||curTmpInfo.charttype=="scatter"){initChartByScatter(g)}else{initChartKpiDrop(g)}}}if(f=="text"){$("#T"+g+" div.ctx").bind("dblclick",function(){insertText("update",g)})}liveCompMoveEvent(g);if(a==null||a==undefined){var e=$("#T"+g).offset();$("#optarea").scrollTop(e.top)}}function crtCrossTable(){var a="<table class='d_table'><tr><td class='blank'></td><td><div id='d_colDims' class='tabhelpr'>将维度拖到此处作为列标签</div></td></tr><tr><td><div id='d_rowDims' class='tabhelpr'>将维度拖到此处<br>作为行标签</div></td><td><div id='d_kpi' class='tabhelpr'>将度量拖到此处<br>查询数据</div></td></tr></table>";return a}function isExistDateDim(a,e){var b=false;if(e=="table"){if(!a.tableJson||!a.tableJson.cols){return b}for(var c=0;c<a.tableJson.cols.length;c++){var d=a.tableJson.cols[c];if(d.grouptype=="date"&&d.type!="frd"){b=true;break}}if(!a.tableJson||!a.tableJson.rows){return b}for(var c=0;c<a.tableJson.rows.length;c++){var d=a.tableJson.rows[c];if(d.grouptype=="date"&&d.type!="frd"){b=true;break}}}if(e=="chart"){if(!a.chartJson||!a.chartJson.params){return b}for(var c=0;c<a.chartJson.params.length;c++){var d=a.tableJson.cols[c];if(d.grouptype=="date"&&d.type!="frd"){b=true;break}}if(!a.chartJson||!a.chartJson.xcol){return b}if(a.chartJson.xcol.grouptype=="date"&&a.chartJson.xcol.type!="frd"){b=true}}return b}function initDropDiv(b){var a=false;$("#T"+b+" #d_colDims, #T"+b+" #d_rowDims, #T"+b+" #d_kpi").droppable({accept:"#selectdatatree .tree-node",onDragEnter:function(f,d){var c=$("#selectdatatree").tree("getNode",d);var g=c.attributes.col_type;if(g==1&&($(this).attr("id")=="d_colDims"||$(this).attr("id")=="d_rowDims")){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");if($(this).attr("id")=="d_colDims"){$("#T"+b+" #d_colDims").css("border","1px solid #ff0000")}if($(this).attr("id")=="d_rowDims"){$("#T"+b+" #d_rowDims").css("border","1px solid #ff0000")}a=true}else{a=false}if(g==2&&$(this).attr("id")=="d_kpi"){$(d).draggable("proxy").find("span").removeClass("tree-dnd-no");$(d).draggable("proxy").find("span").addClass("tree-dnd-yes");$("#T"+b+" #d_kpi").css("border","1px solid #ff0000");a=false}f.cancelBubble=true;f.stopPropagation()},onDragLeave:function(d,c){if($(this).attr("id")=="d_kpi"&&a==true){}else{$(c).draggable("proxy").find("span").addClass("tree-dnd-no");$(c).draggable("proxy").find("span").removeClass("tree-dnd-yes");$("#T"+b+" #"+$(this).attr("id")).css("border","none")}d.cancelBubble=true;d.stopPropagation()},onDrop:function(h,f){var l=$(this).parents(".comp_table").attr("id").replace("T","");var c=findCompById(Number(l));h.cancelBubble=true;h.stopPropagation();$("#T"+l+" #"+$(this).attr("id")).css("border","none");var d=$("#selectdatatree").tree("getNode",f);if(c.tid!=undefined){if(c.tid!=d.attributes.tid){msginfo("您拖入的"+(d.attributes.col_type==2?"度量":"维度")+"与表格已有的内容不在同一个立方体中，拖放失败。");return}}if(d.attributes.calc_kpi==1){if(!isExistDateDim(c,"table")){msginfo("您拖入的度量需要表格中先有时间类型的维度(年/季度/月/日)。");return}}c.tid=d.attributes.tid;if(c.kpiJson==undefined){c.kpiJson=[]}if(c.tableJson==undefined){c.tableJson={cols:[],rows:[]}}if(d.attributes.col_type==2&&$(this).attr("id")=="d_kpi"){if(!kpiExist(d.id,c.kpiJson)){c.kpiJson.push({kpi_id:d.id,kpi_name:d.text,col_name:d.attributes.col_name,tname:d.attributes.tname,aggre:d.attributes.aggre,fmt:d.attributes.fmt,alias:d.attributes.alias,tid:c.tid,unit:d.attributes.unit,rate:d.attributes.rate,calc:d.attributes.calc,dyna:d.attributes.dyna})}else{msginfo("度量已经存在。");return}curTmpInfo.isupdate=true;tableView(c,Number(l))}if(d.attributes.col_type==1){if($(this).attr("id")=="d_colDims"){if(dimExist(d.id,c.tableJson.cols)||dimExist(d.id,c.tableJson.rows)){msginfo("维度已经存在。");return}var g=d.attributes.grouptype;if(g!=null&&g!=""&&findGroup(c.tableJson.rows,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。");return}c.tableJson.cols.push({id:d.id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.col,tid:c.tid,iscas:d.attributes.iscas,tname:d.attributes.tname,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,dyna:d.attributes.dyna,ord:d.attributes.ord,dateformat:d.attributes.dateformat});curTmpInfo.isupdate=true;tableView(c,Number(l))}if($(this).attr("id")=="d_rowDims"){if(dimExist(d.id,c.tableJson.rows)||dimExist(d.id,c.tableJson.cols)){msginfo("维度已经存在。");return}var g=d.attributes.grouptype;if(g!=null&&findGroup(c.tableJson.cols,g)){msginfo("拖放失败，同一分组的维度必须在同一行/列标签。");return}c.tableJson.rows.push({id:d.id,dimdesc:d.text,type:d.attributes.dim_type,colname:d.attributes.col,tid:c.tid,iscas:d.attributes.iscas,tname:d.attributes.tname,tableName:d.attributes.tableName,tableColKey:d.attributes.tableColKey,tableColName:d.attributes.tableColName,dimord:d.attributes.dimord,dim_name:d.attributes.dim_name,grouptype:d.attributes.grouptype,valType:d.attributes.valType,dyna:d.attributes.dyna,ord:d.attributes.ord,dateformat:d.attributes.dateformat});curTmpInfo.isupdate=true;tableView(c,Number(l))}}}})}function findGroup(d,c,b){var a=false;if(!d||d==null){return a}for(m=0;m<d.length;m++){if(b&&b==d[m]){continue}if(d[m].grouptype==c){a=true;break}}return a}function getMaxCompId(){var a=1;for(i=0;i<pageInfo.comps.length;i++){var b=pageInfo.comps[i];if(b.id>a){a=b.id}}return a+1}function insertText(c,b){$("#pdailog").dialog({title:"请输入文本内容 - 文本组件",width:490,height:226,closed:false,cache:false,modal:true,toolbar:null,content:'<div class="txtctxdiv"><textarea name="txtctx" id="txtctx" cols="84" rows="8"></textarea></div>',buttons:[{text:"确定",handler:function(){if(c=="insert"){var d=$("#txtctx").val().replace(/\n/g,"<br>");var e=getMaxCompId();addComp(e,"文本组件",d,true,"text");findCompById(e).text=$("#txtctx").val()}if(c=="update"){var f=findCompById(b);f.text=$("#txtctx").val();$("#T"+b+" div.ctx").html($("#txtctx").val().replace(/\n/g,"<br>"));curTmpInfo.isupdate=true}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(b){var a=findCompById(b);$("#txtctx").val(a.text)}$("#txtctx").focus()}function loadMyReportTree(){$("#myreporttree").tree({url:"MyReport!tree.action?view="+curTmpInfo.view,dnd:false,onDblClick:function(a){if(a.id=="sharereport"){return}location.href=(curTmpInfo.view?"ReportDesign!view.action":"ReportDesign.action")+"?pageId="+a.id},onContextMenu:function(b,a){b.preventDefault();if(a.id=="sharereport"||"y"==a.attributes.sharefile){return}if(curTmpInfo.view!=true){if(a.attributes.share=="y"){$("#myreportmenu").menu("disableItem",$("#myreportmenu #m_share"));$("#myreportmenu").menu("enableItem",$("#myreportmenu #m_share2"))}else{$("#myreportmenu").menu("enableItem",$("#myreportmenu #m_share"));$("#myreportmenu").menu("disableItem",$("#myreportmenu #m_share2"))}}$("#myreporttree").tree("select",a.target);$("#myreportmenu").menu("show",{left:b.pageX,top:b.pageY});pageInfo.reportId=a.id}})}function deletemyreport(){if(confirm("是否确认删除？")){$.post("MyReport!delete.action",{reportId:pageInfo.reportId,view:curTmpInfo.view},function(b){var a=$("#myreporttree").tree("getSelected");$("#myreporttree").tree("remove",a.target)})}}function chgreportname(){var a=$("#myreporttree").tree("getSelected");$.messager.prompt("提示信息","请输入新文件名称：",function(b){if(b){$.post("MyReport!rename.action",{reportId:pageInfo.reportId,reportName:b,view:curTmpInfo.view},function(c){if(a){$("#myreporttree").tree("update",{target:a.target,text:b})}})}});$(".messager-input").val(a.text);$(".messager-input").select()}function resortComp(){var a=pageInfo.comps;pageInfo.comps=[];$("#optarea").children().each(function(b,c){if($(this).hasClass("comp_table")){var d=Number($(this).attr("id").replace("T",""));for(i=0;i<a.length;i++){if(a[i].id==d){pageInfo.comps.push(a[i]);delete a[i].dims;break}}}})}function savepage(view,cb,nomsg){if(curTmpInfo.view&&curTmpInfo.share=="y"){msginfo("您不能保存共享报表，请先另存报表后再修改。");return}resortComp();var jsonStr=JSON.stringify(pageInfo);var pageId=pageInfo.id;if(pageId==undefined||pageId==null){pageId=""}if(pageId==""){$.messager.prompt("提示信息","请输入您要保存的文件名称：",function(r){if(r){$.post("ReportDesign!save.action",{pageInfo:jsonStr,pageId:pageId,pageName:r,view:view},function(resp){var oo=eval("("+resp+")");if(oo.state==1){showmsg(oo.msg)}else{pageInfo.id=oo.pageId;if(cb!=undefined){cb()}else{}loadMyReportTree();msginfo("保存成功！","suc");curTmpInfo.isupdate=false}})}});$(".messager-input").focus()}else{$.post("ReportDesign!save.action",{pageInfo:jsonStr,pageId:pageId,view:view},function(resp){var oo=eval("("+resp+")");if(oo.state==1){showmsg(oo.msg)}else{if(cb!=undefined){cb()}else{}if(!nomsg||nomsg==false){msginfo("保存成功！","suc")}curTmpInfo.isupdate=false}})}}function saveas(view){resortComp();var jsonStr=JSON.stringify(pageInfo);var json=eval("("+jsonStr+")");if(view&&curTmpInfo.share=="y"&&!json.linkReport){json.linkReport=pageInfo.id}$.messager.prompt("提示信息","请输入您要另存的文件名称：",function(r){if(r){$.post("ReportDesign!save.action",{pageInfo:JSON.stringify(json),pageId:"",pageName:r,view:view},function(resp){loadMyReportTree();msginfo("保存成功！","suc")})}});$(".messager-input").focus()}function liveCompMoveEvent(b){var a=findCompById(b);$("#T"+b+" .title .tname").bind("dblclick",function(){var c=this;$.messager.prompt("提示信息","请输入新的组件名称：",function(e){if(e!=undefined){var d=$(c).parents(".comp_table").attr("id").replace("T","");findCompById(d).name=e;$(c).html(e)}});$(".messager-input").val($(this).text());$(".messager-input").select()});$("#T"+b).draggable({revert:true,handle:$("#T"+b+" .title .mvcomp"),proxy:function(e){var d=$(e).width();var c=$(e).height();var f=$('<div style="border:1px solid #999999;background-color:#cccccc; opacity:0.5; filter:alpha(opacity=50); width:'+d+"px; height:"+c+'px;"></div>');f.appendTo("body");return f},onBeforeDrag:function(c){},onStartDrag:function(c){},onStopDrag:function(c){$("body").css("cursor","default")}});$("#optarea,#T"+b).droppable({accept:".comp_table",onDragEnter:function(f,d){if($(this).hasClass("comp_table")){$(".indicator").css({display:"block",left:$(this).offset().left,top:$(this).offset().top-10});curTmpInfo.curComp={tp:"zjj",obj:$(this)};f.cancelBubble=true;f.stopPropagation()}else{var c=$(this).children().last();var g=c.offset();curTmpInfo.curComp={tp:"zjw",obj:$(this)};$(".indicator").css({display:"block",left:g.left-10,top:g.top-5+$(c).height()})}},onDragLeave:function(f,d){if($(this).hasClass("comp_table")){var c=$(this).children().last();var g=c.offset();$(".indicator").css({display:"block",left:g.left-10,top:g.top-5+$(c).height()});curTmpInfo.curComp={tp:"zjw",obj:$(this)};f.cancelBubble=true;f.stopPropagation()}else{$(".indicator").hide()}},onDrop:function(d,c){$(".indicator").hide();if(curTmpInfo.curComp&&curTmpInfo.curComp.tp=="zjj"){curTmpInfo.isupdate=true;$(c).insertBefore(curTmpInfo.curComp.obj);d.cancelBubble=true;d.stopPropagation()}else{if(curTmpInfo.curComp.tp&&curTmpInfo.curComp.tp=="zjw"){$("#optarea").append(c)}}}})}function kpicompute(h){var b={zb:1,sq:2,tq:2,zje:2,hb:2,tb:2};var e=curTmpInfo.ckid;var l=curTmpInfo.compId.replace("T","");var d=findCompById(l);var g=findKpiById(e,d.kpiJson);if(h=="zb"){g.compute="zb"}else{if(!isExistDateDim(d,"table")){msginfo("当前指标计算需要表格中先有时间类型的维度(年/季度/月/日)。");return}if(!paramsamedimdate(d)){msginfo("指标计算时，需要表格中具有和参数相同的维度。");return}var f=g.compute;if(!f||f==""){g.compute=h}else{var a=f.split(",");if(b[a[0]]==1){g.compute=h}else{var c=false;for(j=0;j<a.length;j++){if(a[j]==h){c=true;break}}if(!c){g.compute=f+","+h}}}}tableView(d,l)}function tableView(p,o){if(p.tableJson==undefined||p.kpiJson==undefined){return}if(p.kpiJson.length==0&&p.tableJson.cols.length==0&&p.tableJson.rows.length==0){$("#T"+o+" div.ctx").html(crtCrossTable());initDropDiv(o);return}p.tableJson.cols.push({type:"kpiOther",id:"kpi"});var l=JSON.stringify(p.tableJson);p.tableJson.cols.pop();var f=[];if(pageInfo.params&&pageInfo.params.length>0){for(d=0;d<pageInfo.params.length;d++){if(pageInfo.params[d].tid==p.tid){f.push(pageInfo.params[d])}}}var h=JSON.stringify(p.kpiJson);var a=fundCubeById(p.tid);if(a==null){$("#T"+o+" div.ctx").html("组件关联的立方体已经失效，请移除该组件。");return}var n=findDatasetById(a.datasetid);if(n==null){$("#T"+o+" div.ctx").html("组件关联的数据集已经失效，请移除该组件。");return}var b={name:n.name,master:n.master,aggreTable:a.aggreTable,joininfo:n.joininfo,param:n.param};var c=findDatasourceById(n.dsid);if(c==null){$("#T"+o+" div.ctx").html("组件关联的数据源已经失效，请移除该组件。");return}var e=[];for(i=0;i<a.kpi.length;i++){var d=a.kpi[i];var g=d.aggre+"_"+d.id;e.push({calc:(d.calc==true?true:false),col_name:d.col,aggre:d.aggre,alias:g,tname:d.tname})}showloading();$.ajax({type:"POST",url:"TableView.action",dataType:"html",data:{tableJson:l,kpiJson:h,divison:(a.divison?JSON.stringify(a.divison):"{}"),cubeId:(a.cache?a.id:""),compId:o,params:JSON.stringify(f),dset:JSON.stringify(b),dsource:JSON.stringify(c),cubeKpis:(a.cache?JSON.stringify(e):"[]")},success:function(q){hideLoading();$("#T"+o+" div.ctx").html(q);initDropDiv(o)},error:function(q){hideLoading();$.messager.alert("出错了","系统出错，请查看后台日志。","error")}})}function kpiFilter(g){var e=curTmpInfo.ckid;var d=curTmpInfo.compId.replace("T","");var b=findCompById(d);var f=findKpiById(e,b.kpiJson);var h=f.filter;var c="";if(f.rate==1000){c="千"}else{if(f.rate==10000){c="万"}else{if(f.rate==1000000){c="百万"}else{if(f.rate==100000000){c="亿"}}}}var a="<div style='line-height:25px; margin:5px;'><br/> "+f.kpi_name+' &nbsp; <select id="ftype"><option value=""></option><option value=">" '+(h&&h.filterType==">"?"selected":"")+'>大于</option><option value="<" '+(h&&h.filterType=="<"?"selected":"")+'>小于</option><option value="=" '+(h&&h.filterType=="="?"selected":"")+'>等于</option><option value="between" '+(h&&h.filterType=="between"?"selected":"")+'>区间</option></select> &nbsp; <input type="text" id="startval" size="5" value="'+(h?h.val1:"")+'"><span id="endvalspan" style="display:'+(h&&h.filterType=="between"?"inline":"none")+'"> - <input type="text" id="endval" size="5" value="'+(h?h.val2:"")+'"></span>'+c+(f.unit?f.unit:"")+"<br/>[<a id=\"clear\" href='javascript:;'>清除筛选</a>]</div>";$("#pdailog").dialog({title:"度量筛选",width:330,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){var p=$("#pdailog #ftype").val();var l=$("#pdailog #startval").val();var o=$("#pdailog #endval").val();if(p==""||l==""){delete f.filter}else{var n={kpi:f.kpi_id,filterType:p,val1:Number(l),val2:(o==""?0:Number(o))};f.filter=n}$("#pdailog").dialog("close");curTmpInfo.isupdate=true;if(g=="table"){tableView(b,d)}else{if(g=="chart"){chartview(b,d)}}}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #startval,#pdailog #endval").numberbox();$("#pdailog #ftype").bind("change",function(){var l=$(this);if(l.val()=="between"){$("#pdailog #endvalspan").css("display","inline")}else{$("#pdailog #endvalspan").css("display","none")}});$("#pdailog #clear").bind("click",function(){$("#pdailog #ftype").val("");$("#pdailog #startval").val("");$("#pdailog #endval").val("")})}function kpiExist(d,c){var a=false;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=true;break}}return a}function dimExist(c,d){var a=false;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=true;break}}return a}function delJsonKpiOrDim(f){var a=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var d=findCompById(Number(n));var e=curTmpInfo.pos;if(f=="kpi"){var l=d.kpiJson;var h=-1;for(var c=0;c<l.length;c++){if(l[c].kpi_id==a){h=c;break}}l.splice(h,1)}if(f=="dim"){var g=null;if(e=="col"){g=d.tableJson.cols}else{g=d.tableJson.rows}var h=-1;for(var c=0;c<g.length;c++){if(g[c].id==a){h=c;break}}g.splice(h,1);if(!isExistDateDim(d,"table")){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}if(!paramsamedimdate(d)){for(var b=0;d.kpiJson&&b<d.kpiJson.length;b++){delete d.kpiJson[b].compute}}}curTmpInfo.isupdate=true;tableView(d,n)}function setKpiInfo(b,e){var d=$(b).offset();curTmpInfo.ckid=e;curTmpInfo.compId=$(b).parents(".comp_table").attr("id");var a=findCompById(Number(curTmpInfo.compId.replace("T","")));var c=findKpiById(e,a.kpiJson);if(c.sort=="asc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{if(c.sort=="desc"){$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-ok"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-blank"})}else{$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord1")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord2")).target,iconCls:"icon-blank"});$("#dimoptmenu").menu("setIcon",{target:$("#kpioptmenu").menu("getItem",$("#k_kpi_ord3")).target,iconCls:"icon-ok"})}}$("#kpioptmenu").menu("show",{left:d.left,top:d.top+20})}function setCdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="col";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.tableJson.cols;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至行维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function setRdimInfo(h,b,a){var d=$(h).offset();curTmpInfo.ckid=b;curTmpInfo.compId=$(h).parents(".comp_table").attr("id");curTmpInfo.pos="row";curTmpInfo.dimname=a;var e=false;var g=findCompById(Number(curTmpInfo.compId.replace("T","")));var l=g.tableJson.rows;for(var f=0;f<l.length;f++){if(l[f].id==b){if(l[f].issum=="y"){e=true;break}}}if(e){var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"取消聚合"})}else{var c=$("#dimoptmenu").menu("getItem",$("#m_aggre"));$("#dimoptmenu").menu("setText",{target:c.target,text:"聚合..."})}var c=$("#dimoptmenu").menu("getItem",$("#m_moveto"));$("#dimoptmenu").menu("setText",{target:c.target,text:"移至列维度"});$("#dimoptmenu").menu("show",{left:d.left,top:d.top+20})}function updateQDate(d,c,e){$("#pdailog").dialog({title:"修改数据账期",width:250,height:240,closed:false,cache:false,modal:true,toolbar:null,buttons:[{text:"确定",handler:function(){var f=findCompById(c);if(e=="table"){f.tableJson.baseDate={start:$("#pdailog #dft2").val(),end:$("#pdailog #dft1").val()};curTmpInfo.isupdate=true;tableView(f,c)}if(e=="chart"){f.chartJson.baseDate={start:$("#pdailog #dft2").val(),end:$("#pdailog #dft1").val()};curTmpInfo.isupdate=true;chartview(f,c)}$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});var b=$(d).attr("ed");var a=$(d).attr("st");b=b.substring(0,4)+"-"+b.substring(4,6)+"-"+b.substring(6,8);a=a.substring(0,4)+"-"+a.substring(4,6)+"-"+a.substring(6,8);$("#pdailog").dialog("refresh","DateFilter.action?dimType="+($(d).attr("dimid")==1?"day":"month")+"&dimId="+$(d).attr("dimid")+"&dft1="+b+"&dft2="+a)}function filterDims(){var o=curTmpInfo.ckid;var s=curTmpInfo.compId.replace("T","");var n=curTmpInfo.pos;var a=curTmpInfo.dimname;var g=findCompById(s);var q=null;if(n=="col"){q=g.tableJson.cols}else{q=g.tableJson.rows}var f=null;for(var e=0;e<q.length;e++){if(q[e].id==o){f=q[e];break}}var l=[];if(f.vals){l=f.vals.split(",")}var p=function(v){var u=false;for(j=0;j<l.length;j++){if(v==l[j]){u=true;break}}return u};var b=fundCubeById(f.tid);var h=findDatasetById(b.datasetid);var c=findDatasourceById(h.dsid);var t="";var r="";var d=f.valStrs?f.valStrs.split(","):[];for(j=0;j<l.length;j++){r=r+'<div class="fltone"><input type="checkbox" id="S'+l[j]+'" name="dimselcet" value="'+l[j]+'" desc="'+d[j]+'"><label for="S'+l[j]+'">'+d[j]+"</label></div>"}t='<div class="dxwd"><div class="wdhead">待选维度</div><input id="dimsearch" style="width:230px;"></input><div class="wdlist" style="height:278px;"></div></div><div class="xzwdbtn"><input type="button" value=">" id="xzwd" style="margin-top:120px;" title="选择"><br/><input type="button" value="<" id="scwd" title="删除"></div><div class="yxwd"><div class="wdhead">已选维度</div><div class="wdlist">'+r+"</div></div>";$("#pdailog").dialog({title:a+" - 维度筛选",width:546,height:400,closed:false,cache:false,modal:true,content:t,buttons:[{text:"确定",handler:function(){var v="";var u="";var w=$("#pdailog input[name='dimselcet']");w.each(function(y,x){v=v+$(this).val();u=u+$(this).attr("desc");if(y!=w.size()-1){v=v+",";u=u+","}});f.vals=v;f.valStrs=u;curTmpInfo.isupdate=true;tableView(g,s);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});if(f.tableColKey==""||f.tableName==""||f.tableColName==""){loadDimFunc2(b,c,f,"")}else{loadDimFunc(b,c,f,"")}$("#pdailog #xzwd").click(function(){var u=$("#pdailog input[name='dimselcet']");var v=function(x){var w=false;for(e=0;e<u.size();e++){if($(u.get(e)).val()==x){w=true;break}}return w};$("#pdailog input[name='dimval']:checkbox:checked").each(function(w,x){if(!v($(x).val())){var y='<div class="fltone"><input type="checkbox" desc="'+$(x).attr("desc")+'" value="'+$(x).val()+'" name="dimselcet" id="S'+$(x).val()+'"><label for="S'+$(x).val()+'">'+$(x).attr("desc")+"</label></div>";$("#pdailog .yxwd .wdlist").append(y)}})});$("#pdailog #scwd").click(function(){$("#pdailog input[name='dimselcet']:checkbox:checked").each(function(u,v){$(v).parent().remove()})});$("#pdailog #dimsearch").searchbox({searcher:function(v,u){if(f.tableName==""||f.tableColKey==""||f.tableColName==""){loadDimFunc2(b,c,f,v)}else{loadDimFunc(b,c,f,v)}},prompt:"维度搜索..."})}function kpisort(d){var c=curTmpInfo.ckid;var b=curTmpInfo.compId.replace("T","");var a=findCompById(b);for(i=0;i<a.kpiJson.length;i++){if(a.kpiJson[i].kpi_id==c){a.kpiJson[i].sort=d}else{a.kpiJson[i].sort=""}}curTmpInfo.isupdate=true;tableView(a,b)}function dimsort(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}for(var d=0;d<f.length;d++){if(f[d].id==b){f[d].dimord=g;break}}for(d=0;d<a.kpiJson.length;d++){a.kpiJson[d].sort=""}curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide")}function dimexchange(){var f=curTmpInfo.ckid;var n=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(n);if(e=="col"){var h=0;var c=null;var g=d.tableJson.cols;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.tableJson.cols,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。");return}d.tableJson.cols.splice(h,1);d.tableJson.rows.push(c)}if(e=="row"){var h=0;var c=null;var g=d.tableJson.rows;for(var b=0;b<g.length;b++){if(g[b].id==f){h=b;c=g[b];break}}var l=c.grouptype;if(l!=null&&findGroup(d.tableJson.rows,l,c)){msginfo("移动失败，同一分组的维度必须在同一行/列标签。");return}d.tableJson.rows.splice(h,1);d.tableJson.cols.push(c)}curTmpInfo.isupdate=true;tableView(d,n)}function changecolrow(e){var d=curTmpInfo.compId.replace("T","");var b=findCompById(d);var c=b.tableJson.rows;b.tableJson.rows=b.tableJson.cols;b.tableJson.cols=c;tableView(b,d);if(b.complink&&e){var a=findCompById(b.complink);if(a!=null&&isSameDimsInDrill(b,a)){exchangexs(a.id,false)}}}function dimmove(g){var b=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var h=curTmpInfo.pos;var c=curTmpInfo.dimname;var a=findCompById(e);var f=null;if(h=="col"){f=a.tableJson.cols}else{f=a.tableJson.rows}if(f.length<=1){msginfo("无效移动。");return}for(var d=0;d<f.length;d++){if(f[d].id==b){if(g=="left"){if(d<=0){msginfo("无效移动。");return}else{var g=f[d-1];f[d-1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}else{if(g=="right"){if(d>=f.length-1){msginfo("无效移动。");return}else{var g=f[d+1];f[d+1]=f[d];f[d]=g;curTmpInfo.isupdate=true;tableView(a,e);$("#dimoptmenu").menu("hide");return}}}break}}}function msginfo(a,d){var c=null;if(d&&(d=="suc"||d=="info")){c="<div class='msginfo msgsuc'>"+a+"</div>"}else{c="<div class='msginfo msgerr'>"+a+"</div>"}var b="出错了";if(d&&d=="suc"){b="成功了"}else{if(d&&d=="info"){b="提示信息"}}$.messager.show({title:b,msg:c,showType:"fade",timeout:2000,style:{right:"",top:document.body.scrollTop+document.documentElement.scrollTop+10,bottom:""}})}function showmsg(b){var a='<div class="textpanel" style="margin:25px;"><div class=\'msginfo msgsuc\'>'+b+"</div></div>";$("#pdailog").dialog({title:"提示信息",width:300,height:180,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){$("#pdailog").dialog("close")}}]})}function findDimById(c,d){var a=null;if(!d||d==null){return a}for(var b=0;b<d.length;b++){if(d[b].id==c){a=d[b];break}}return a}function findKpiById(d,c){var a=null;if(!c||c==null){return a}for(var b=0;b<c.length;b++){if(c[b].kpi_id==d){a=c[b];break}}return a}function findParamById(a){var b=null;for(i=0;pageInfo.params&&i<pageInfo.params.length;i++){var c=pageInfo.params[i];if(c.id==a){b=c;break}}return b}function kpiproperty(){var f=curTmpInfo.ckid;var e=curTmpInfo.compId.replace("T","");var c=findCompById(e);var g=findKpiById(f,c.kpiJson);var a=fundCubeById(g.tid);var d=findCubeKpiById(a,f);var b='<div class="textpanel"><span class="inputtext">度量名称：</span>'+g.kpi_name+'<br><span class="inputtext">所属表/字段：</span>'+g.tname+" / "+g.col_name+"<br><span class=\"inputtext\">度量单位：</span><select id=\"kpiunit\" name=\"kpiunit\" class=\"inputform\"><option value='1'></option><option value='1000'>千</option><option value='10000'>万</option><option value='1000000'>百万</option><option value='100000000'>亿</option></select>"+(g.unit?g.unit:"")+'<br><span class="inputtext">格 式 化：</span><select id="fmt" name="fmt" class="inputform"><option value=""></option><option value="###,##0">整数</option><option value="###,##0.00">小数</option><option value="0.00%">百分比</option></select><br/><span class="inputtext">度量解释：</span>'+(d.kpinote?unescape(d.kpinote):"无")+"</div>";$("#pdailog").dialog({title:"度量属性",width:320,height:245,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"确定",handler:function(){g.fmt=$("#pdailog #fmt").val();g.rate=Number($("#pdailog #kpiunit").val());$("#pdailog").dialog("close");curTmpInfo.isupdate=true;tableView(c,e)}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});$("#pdailog #fmt").find("option[value='"+g.fmt+"']").attr("selected",true);$("#pdailog #kpiunit").find("option[value='"+g.rate+"']").attr("selected",true)}function aggreDim(){var f=curTmpInfo.ckid;var h=curTmpInfo.compId.replace("T","");var e=curTmpInfo.pos;var a=curTmpInfo.dimname;var d=findCompById(h);var g=null;if(e=="col"){g=d.tableJson.cols}else{g=d.tableJson.rows}var c=null;for(var b=0;b<g.length;b++){if(g[b].id==f){c=g[b]}}if(c.issum=="y"){c.issum="n";delete c.aggre;curTmpInfo.isupdate=true;tableView(d,h);return}var l='<div style=\'line-height:30px; margin:20px 20px 20px 40px;\'>聚合方式：<select id="dimaggre" name="dimaggre"><option value="sum">求和</option><option value="count">计数</option><option value="avg">平均</option><option value="max">最大</option><option value="min">最小</option><option value="var">方差</option><option value="sd">标准差</option><option value="middle">中位数</option></select></div>';$("#pdailog").dialog({title:"维度聚合",width:280,height:180,closed:false,cache:false,modal:true,toolbar:null,content:l,buttons:[{text:"确定",handler:function(){if(c.issum=="y"){c.issum="n";delete c.aggre}else{c.issum="y";c.aggre=$("#pdailog #dimaggre").val()}curTmpInfo.isupdate=true;tableView(d,h);$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]})}function shareReport(b){var a=$("#myreporttree").tree("getSelected");if(a.attributes.share=="y"&&b=="y"){return}if(a.attributes.share!="y"&&b=="n"){return}if(confirm("是否"+(b=="n"?"取消":"")+"共享？")){$.ajax({type:"post",dataType:"json",url:b=="y"?"MyReport!share.action":"MyReport!unshare.action",data:{reportId:a.id},success:function(c){loadMyReportTree()}})}}function printData(){resortComp();for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先查询数据。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}var c=JSON.stringify(pageInfo);for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}var d="about:blank";var b="printwindow";window.open(d,b);var a="<form name='prtff' method='post' target='printwindow' action=\"ReportDesign!print.action\" id='expff'><input type='hidden' name='pageInfo' id='pageInfo' value='"+c+"'></form>";$(a).appendTo("body").submit().remove()}function exportPage(){var a="<form name='expff' method='post' action=\"ReportExport.action\" id='expff'><input type='hidden' name='type' id='type'><input type='hidden' name='json' id='json'><div class='exportpanel'><span class='exptp select' tp='html'><img src='../resource/img/export-html.gif'><br>HTML</span><span class='exptp' tp='csv'><img src='../resource/img/export-csv.gif'><br>CSV</span><span class='exptp' tp='excel'><img src='../resource/img/export-excel.gif'><br>EXCEL</span><span class='exptp' tp='pdf'><img src='../resource/img/export-pdf.gif'><br>PDF</span></div></form>";$("#pdailog").dialog({title:"导出数据",width:310,height:200,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"确定",handler:function(){resortComp();var b=curTmpInfo.expType;$("#expff #type").val(b);for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type!="text"&&pageInfo.comps[i].kpiJson==undefined){msginfo("组件中无数据，请先查询数据。");$("#pdailog").dialog("close");return}if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.push({type:"kpiOther",id:"kpi"})}}$("#expff #json").val(JSON.stringify(pageInfo));for(i=0;i<pageInfo.comps.length;i++){if(pageInfo.comps[i].type=="table"){pageInfo.comps[i].tableJson.cols.pop()}}$("#expff").submit();$("#pdailog").dialog("close")}},{text:"取消",handler:function(){$("#pdailog").dialog("close")}}]});curTmpInfo.expType="html";$(".exportpanel span.exptp").click(function(b){$(".exportpanel span.exptp").removeClass("select");$(this).addClass("select");curTmpInfo.expType=$(this).attr("tp")})}function kpidesc(){var d="";if(pageInfo.selectDs&&pageInfo.selectDs!=""){var c=pageInfo.selectDs.split(",");var e=[];for(i=0;i<c.length;i++){var a=fundCubeById(c[i]);if(a==null){continue}for(j=0;j<a.kpi.length;j++){d=d+"<tr><td class='kpiData1 grid3-td' align=\"left\">"+a.kpi[j].name+'</td><td class=\'kpiData1 grid3-td\' align="left" style="color:#666">'+(a.kpi[j].kpinote?unescape(a.kpi[j].kpinote):"")+"</td></tr>"}}}var b='<table class="grid3" id="T_report54" cellpadding="0" cellspacing="0"><tr style="background-color:#FFF"><th width=\'30%\'>度量</th><th>解释信息</th></tr>'+d+"</table>";$("#pdailog").dialog({title:"度量指标解释",width:530,height:300,closed:false,cache:false,modal:true,toolbar:null,content:b,buttons:[{text:"关闭",handler:function(){$("#pdailog").dialog("close")}}]})}function helper(){var a='<div style="line-height:20px; margin:5px; font-size:13px;"> &nbsp; &nbsp; 专业的在线数据分析软件，产品简单易用，功能强大，用户不用编写任何代码，只用通过简单配置即可查询和分析数据；支持表格、图形、文本等多种展现方式；支持下钻、上卷、钻透、排序、过滤、求和、同环比计算等分析方法；成本低廉，是您企业数据分析的理想工具。 <br/> <b>表格展现：</b><br/> <img src="../resource/img/help1.gif"> <br/> <b>表格钻取：</b><br/> <img src="../resource/img/help4.gif">  <br/> <b>创建图形：</b><br/> <img src="../resource/img/help2.gif">  <br/> <b>图形展现：</b><br/> <img src="../resource/img/help3.gif">  <br/> <a href=\'http://www.ruisitech.com/doc/rsbi_jjb.pdf\' target=\'_blank\'>用户使用手册</a> <br/> <b>北京睿思科技有限公司</b> 版权所有 </div>';$("#pdailog").dialog({title:"睿思BI|OLAP工具使用帮助",width:630,height:420,closed:false,cache:false,modal:true,toolbar:null,content:a,buttons:[{text:"关闭",handler:function(){$("#pdailog").dialog("close")}}]})}function showloading(){var d=jQuery(document);var c=jQuery(window);var b=d.scrollTop()+60;var a=d.scrollLeft()+c.width()-200;$("#Cloading").css({top:b,left:a,display:"block"})}function hideLoading(){$("#Cloading").css("display","none")};